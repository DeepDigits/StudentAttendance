<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>CampusTrack | Dashboard</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://unpkg.com/@material-tailwind/html@latest/scripts/ripple.js"></script>
	<script>
		tailwind.config = {
			darkMode: "class",
			theme: {
				extend: {
					fontFamily: {
						sans: ["Inter", "ui-sans-serif", "system-ui"],
					},
					colors: {
						brand: {
							50: "#f0f4ff",
							100: "#e6edfe",
							200: "#c7d2fe",
							300: "#a5b4fc",
							400: "#818cf8",
							500: "#6366f1",
							600: "#4f46e5",
							700: "#4338ca",
							800: "#3730a3",
							900: "#312e81",
						},
					},
					boxShadow: {
						soft: "0 15px 40px -15px rgba(99, 102, 241, 0.3)",
						inset: "inset 0 1px 0 rgba(255,255,255,0.06)",
					},
				},
			},
		};
	</script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<style>
		body {
			background: linear-gradient(135deg, #f0f4ff 0%, #f8fafc 50%, #f0f9ff 100%);
		}

		.glass-card {
			background: rgba(255, 255, 255, 0.85);
			backdrop-filter: blur(20px);
			border: 1px solid rgba(255, 255, 255, 0.3);
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
		}

		.metric-card:hover {
			transform: translateY(-6px);
			box-shadow: 0 25px 50px -15px rgba(99, 102, 241, 0.35);
		}

		.dark body {
			background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #1e1b4b 100%);
		}

		.dark .glass-card {
			background: rgba(15, 23, 42, 0.75);
			border: 1px solid rgba(71, 85, 105, 0.4);
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
		}

		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(20px); }
			to { opacity: 1; transform: translateY(0); }
		}

		.fade-in {
			animation: fadeIn 0.6s ease-out forwards;
		}

		/* Smooth scroll and smart scroll-padding so anchored sections don't get hidden */
		html {
			scroll-behavior: smooth;
			scroll-padding-top: var(--scroll-padding, 1rem);
		}

		.chart-container {
			background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
		}

		.dark .chart-container {
			background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
		}

		/* Accent theme variables and helpers */
		:root {
			/* default = purple */
			--accent-500: #6366f1;
			--accent-600: #4f46e5;
			--accent-700: #4338ca;
			--accent-500-rgb: 99,102,241;
		}

		.accent-gradient-r {
			background-image: linear-gradient(to right, var(--accent-500), var(--accent-600));
		}
		.accent-gradient-br {
			background-image: linear-gradient(to bottom right, var(--accent-500), var(--accent-700));
		}
		.accent-text { color: var(--accent-600); }
		.accent-text-strong { color: var(--accent-700); }
		.accent-border { border-color: rgba(var(--accent-500-rgb), 0.35) !important; }
		.accent-surface {
			background-color: rgba(var(--accent-500-rgb), 0.08);
			color: var(--accent-700);
			border-color: rgba(var(--accent-500-rgb), 0.35);
		}
		.accent-chip {
			background-color: rgba(var(--accent-500-rgb), 0.15);
			color: var(--accent-600);
		}

		/* Sidebar nav icon circle + polish */
		.nav-item { position: relative; overflow: visible; display: block; }
		.nav-icon { position: relative; display: inline-flex; align-items: center; justify-content: center; height: 44px; width: 44px; border-radius: 9999px; background: rgba(255,255,255,0.98); box-shadow: 0 10px 30px rgba(2,6,23,0.06); color: var(--accent-600); }
		.dark .nav-icon { background: rgba(15,23,42,0.65); color: var(--accent-500); }
		.nav-icon::after { content: ''; position: absolute; left: -18px; top: 50%; transform: translateY(-50%); width: 86px; height: 86px; border-radius: 9999px; background: radial-gradient(circle at 30% 30%, rgba(var(--accent-500-rgb),0.14), transparent 40%); filter: blur(20px); z-index: 0; opacity: 0.95; }
		.nav-icon > i { position: relative; z-index: 2; font-size: 14px; }
		.nav-label { position: relative; z-index: 2; color: rgba(20, 35, 58, 0.65); font-weight: 600; }
		.nav-item:hover .nav-icon { transform: translateY(-2px) scale(1.01); background-image: linear-gradient(to right, var(--accent-500), var(--accent-600)); color: #fff; box-shadow: 0 22px 48px rgba(var(--accent-500-rgb),0.14); }
		.nav-item .fa-chevron-right { color: rgba(20,35,58,0.35); }

		/* Active / selected tab: draw a subtle rounded rectangle behind the whole item */
		.nav-item::before { content: ''; position: absolute; left: 8px; right: 8px; top: 6px; bottom: 6px; border-radius: 12px; background: transparent; transition: background 220ms ease, transform 220ms ease, opacity 220ms ease; z-index: 0; pointer-events: none; }
		.nav-item.active::before { background: linear-gradient(90deg, rgba(var(--accent-500-rgb),0.10), rgba(var(--accent-500-rgb),0.04)); transform: translateX(0); opacity: 1; }
		.nav-item.active { /* ensure stacking context */ z-index: 2; }
		.nav-item.active .nav-icon { background-image: linear-gradient(to right, var(--accent-500), var(--accent-600)); color: #fff; box-shadow: 0 18px 44px rgba(var(--accent-500-rgb),0.14); position: relative; z-index: 2; }
		.nav-item.active .nav-label { color: var(--accent-700); position: relative; z-index: 2; }
		.nav-item.active .fa-chevron-right { color: rgba(20,35,58,0.45); position: relative; z-index: 2; }
	</style>

	<style>
		/* Loader styles */
		#pageLoader{
			position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(250,250,255,0.95));backdrop-filter:blur(6px);transition:opacity .45s ease,visibility .45s ease;}
		#pageLoader.hidden{opacity:0;visibility:hidden;pointer-events:none}
		#pageLoader .loader-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
		.loader-ring{width:84px;height:84px}
		.ring-bg{stroke:rgba(15,23,42,0.06)}
		.ring{stroke:var(--loader-accent);stroke-dasharray:125;stroke-dashoffset:100;transform-origin:center;animation:spin 1.6s linear infinite, dash 1.4s ease-in-out infinite}
		.loader-text{font-weight:700;color:var(--accent-700);letter-spacing:0.6px}
		@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
		@keyframes dash{0%{stroke-dashoffset:125}50%{stroke-dashoffset:40}100%{stroke-dashoffset:125}}
	</style>
</head>
<body class="min-h-screen text-slate-800 dark:bg-slate-950 dark:text-slate-100" style="overflow-x: hidden;">
	<!-- Page loader overlay -->
	<div id="pageLoader" aria-hidden="true" style="--loader-accent: var(--accent-500);">
		<div class="loader-wrap">
			<svg class="loader-ring" viewBox="0 0 50 50" aria-hidden="true">
				<circle class="ring-bg" cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle>
				<circle class="ring" cx="25" cy="25" r="20" fill="none" stroke-width="4" stroke-linecap="round"></circle>
			</svg>
			<div class="loader-text">CampusTrack</div>
		</div>
	</div>
	<div class="flex min-h-screen">
	<aside class="hidden lg:flex w-72 flex-col gap-8 border-r border-slate-200/60 bg-white/90 px-6 py-10 backdrop-blur-xl dark:border-slate-800/70 dark:bg-slate-900/80 lg:sticky lg:top-0 lg:h-screen lg:self-start">
			<div class="flex items-center gap-3">
				<span class="flex h-12 w-12 items-center justify-center rounded-2xl accent-gradient-br text-white shadow-soft">
					<i class="fas fa-user-graduate"></i>
				</span>
				<div>
					<p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">CampusTrack</p>
					<h1 class="text-xl font-bold text-slate-900 dark:text-white">Student Portal</h1>
				</div>
			</div>
			<nav class="space-y-1 text-sm font-medium text-slate-500">
				<a href="#" class="rounded-xl px-4 py-3 text-white shadow-soft nav-item active">
					<div class="flex items-center justify-between">
						<span class="inline-flex items-center gap-3">
							<span class="nav-icon"><i class="fas fa-gauge-high text-sm"></i></span>
							<span class="nav-label ml-3">My Dashboard</span>
						</span>
						<i class="fas fa-chevron-right text-xs"></i>
					</div>
				</a>
				<a href="#attendance" class="rounded-xl px-4 py-3 transition-all duration-300 hover:bg-white hover:text-brand-600 hover:shadow-md dark:hover:bg-slate-800/80 nav-item">
					<div class="flex items-center gap-3">
						<span class="nav-icon"><i class="fas fa-calendar-check text-sm"></i></span>
						<span class="nav-label ml-3">My Attendance</span>
					</div>
				</a>
				<a href="#profile" class="rounded-xl px-4 py-3 transition-all duration-300 hover:bg-white hover:text-brand-600 hover:shadow-md dark:hover:bg-slate-800/80 nav-item">
					<div class="flex items-center gap-3">
						<span class="nav-icon"><i class="fas fa-user text-sm"></i></span>
						<span class="nav-label ml-3">My Profile</span>
					</div>
				</a>
				<a href="#progress" class="rounded-xl px-4 py-3 transition-all duration-300 hover:bg-white hover:text-brand-600 hover:shadow-md dark:hover:bg-slate-800/80 nav-item">
					<div class="flex items-center gap-3">
						<span class="nav-icon"><i class="fas fa-chart-line text-sm"></i></span>
						<span class="nav-label ml-3">Progress</span>
					</div>
				</a>
			</nav>
			<!-- Theme Customization Card -->
			<div class="mt-auto rounded-2xl p-6 text-slate-800 dark:text-slate-100 glass-card">
				<p class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400">Theme</p>
				<h3 class="mt-1 text-lg font-bold">Customize Colors</h3>
				<p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Choose an accent color for your dashboard.</p>
				<div class="mt-4 grid grid-cols-6 gap-2" id="themeSwatches">
					<button class="h-8 w-8 rounded-full ring-1 ring-black/5" style="background:#6366f1" data-theme="purple" title="Purple"></button>
					<button class="h-8 w-8 rounded-full ring-1 ring-black/5" style="background:#3b82f6" data-theme="blue" title="Blue"></button>
					<button class="h-8 w-8 rounded-full ring-1 ring-black/5" style="background:#10b981" data-theme="green" title="Green"></button>
					<button class="h-8 w-8 rounded-full ring-1 ring-black/5" style="background:#ef4444" data-theme="red" title="Red"></button>
					<button class="h-8 w-8 rounded-full ring-1 ring-black/5" style="background:#8b5cf6" data-theme="violet" title="Violet"></button>
					<button class="h-8 w-8 rounded-full ring-1 ring-black/5" style="background:#64748b" data-theme="grey" title="Grey"></button>
				</div>
				<div class="mt-4 text-xs text-slate-600 dark:text-slate-300">Current: <span id="currentTheme" class="font-semibold">Purple</span></div>
			</div>
		</aside>

		<div class="flex flex-1 flex-col">
			<header class="glass-card flex flex-col gap-4 border-b border-slate-200/60 px-6 py-5 shadow-sm dark:border-slate-800/80">
				<div class="flex flex-wrap items-center justify-between gap-4">
					<div class="flex items-center gap-4">
						<button id="backHomeBtn" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-sm font-semibold text-slate-700 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200" aria-label="Back to homepage">
							<i class="fas fa-arrow-left text-sm"></i>
							<span class="hidden sm:inline">Back</span>
						</button>
						<div>
							<h2 class="text-2xl font-bold text-slate-900 dark:text-white">Welcome back, {{ profile.user.first_name|default:profile.user.username }}</h2>
							<p class="text-sm text-slate-500 dark:text-slate-400">Track your attendance and academic progress.</p>
						</div>
					</div>
					<div class="flex flex-wrap items-center gap-3">
						<div class="flex items-center gap-3 rounded-full border border-slate-200 bg-white/70 px-3 py-2 shadow-sm transition-all duration-300 hover:shadow-md dark:border-slate-700 dark:bg-slate-900">
                            {% if profile.avatar %}
                            <img src="{{ profile.avatar.url }}" alt="{{ profile.user.get_full_name }}" class="h-10 w-10 rounded-full object-cover border-2 border-white shadow" />
                            {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ profile.user.first_name|default:profile.user.username }}&background=6366f1&color=fff" alt="{{ profile.user.get_full_name }}" class="h-10 w-10 rounded-full object-cover border-2 border-white shadow" />
                            {% endif %}
							<div class="leading-tight">
								<p class="text-sm font-semibold text-slate-700 dark:text-white">{{ profile.user.get_full_name|default:profile.user.username }}</p>
								<span class="text-xs text-slate-500 dark:text-slate-400">{{ profile.student_id }}</span>
							</div>
							<i class="fas fa-chevron-down text-xs text-slate-400"></i>
						</div>
					</div>
				</div>
			</header>

			<main class="relative flex-1 space-y-10 px-6 py-10">
				<section class="grid gap-6 md:grid-cols-2 xl:grid-cols-4">
					<article class="metric-card glass-card group relative overflow-hidden rounded-3xl px-6 py-6 transition-all duration-300 ease-out fade-in">
						<div class="absolute -right-6 -top-6 h-24 w-24 rounded-full bg-brand-100/80 blur-2xl"></div>
						<div class="flex items-center justify-between">
							<div>
								<p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Total Present</p>
								<h3 class="mt-3 text-3xl font-bold text-slate-900 dark:text-white">{{ total_present }}</h3>
							</div>
							<span class="flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-brand-500 to-brand-600 text-white shadow-soft">
								<i class="fas fa-user-check"></i>
							</span>
						</div>
						<p class="mt-4 flex items-center gap-2 text-xs font-medium text-slate-500"><i class="fas fa-calendar"></i> Last 30 days</p>
					</article>

					<article class="metric-card glass-card relative overflow-hidden rounded-3xl px-6 py-6 transition-all duration-300 ease-out fade-in" style="animation-delay: 0.1s;">
						<div class="absolute -right-8 -top-8 h-28 w-28 rounded-full bg-emerald-100/80 blur-2xl"></div>
						<div class="flex items-center justify-between">
							<div>
								<p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">On-Time</p>
								<h3 class="mt-3 text-3xl font-bold text-slate-900 dark:text-white">{{ on_time }}</h3>
							</div>
							<span class="flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-white shadow-soft">
								<i class="fas fa-clock"></i>
							</span>
						</div>
						<p class="mt-4 flex items-center gap-2 text-xs font-medium text-emerald-500"><i class="fas fa-check-circle"></i> Punctual arrivals</p>
					</article>

					<article class="metric-card glass-card relative overflow-hidden rounded-3xl px-6 py-6 transition-all duration-300 ease-out fade-in" style="animation-delay: 0.2s;">
						<div class="absolute -right-8 -top-8 h-28 w-28 rounded-full bg-orange-100/80 blur-2xl"></div>
						<div class="flex items-center justify-between">
							<div>
								<p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Late Arrivals</p>
								<h3 class="mt-3 text-3xl font-bold text-slate-900 dark:text-white">{{ late }}</h3>
							</div>
							<span class="flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 text-white shadow-soft">
								<i class="fas fa-exclamation-triangle"></i>
							</span>
						</div>
						<p class="mt-4 flex items-center gap-2 text-xs font-medium text-orange-500"><i class="fas fa-clock"></i> Need improvement</p>
					</article>

					<article class="metric-card glass-card relative overflow-hidden rounded-3xl px-6 py-6 transition-all duration-300 ease-out fade-in" style="animation-delay: 0.3s;">
						<div class="absolute -right-8 -top-8 h-28 w-28 rounded-full bg-sky-100/80 blur-2xl"></div>
						<div class="flex items-center justify-between">
							<div>
								<p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Today's Status</p>
								<h3 class="mt-3 text-xl font-bold text-slate-900 dark:text-white">
									{% if today_record %}
										<span class="text-emerald-600">Present</span>
									{% else %}
										<span class="text-slate-400">Not Yet</span>
									{% endif %}
								</h3>
							</div>
							<span class="flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-sky-500 to-sky-600 text-white shadow-soft">
								<i class="fas fa-calendar-day"></i>
							</span>
						</div>
						<p class="mt-4 flex items-center gap-2 text-xs font-medium text-sky-500">
							<i class="fas fa-circle"></i> 
							{% if today_record %}
								{{ today_record.status }}
							{% else %}
								Awaiting check-in
							{% endif %}
						</p>
					</article>
				</section>

				<section id="attendance" class="grid gap-6 lg:grid-cols-3">
					<div class="glass-card rounded-3xl p-6 shadow-soft lg:col-span-2 fade-in" style="animation-delay: 0.4s;">
						<header class="flex items-center justify-between">
							<div>
								<h3 class="text-lg font-bold text-slate-900 dark:text-white">Weekly Attendance Trend</h3>
								<p class="text-xs text-slate-500 dark:text-slate-400">Updated 15 minutes ago</p>
							</div>
							<div class="flex items-center gap-3">
								<div class="flex items-center gap-2 text-xs text-slate-500">
									<button id="btnWeek" class="rounded-full border border-slate-200 px-3 py-1 font-semibold text-slate-500 transition-all duration-300 hover:accent-border hover:text-slate-700 dark:border-slate-700 dark:text-slate-300">Week</button>
									<button id="btnMonth" class="rounded-full border border-transparent accent-gradient-r px-3 py-1 font-semibold text-white shadow-soft" data-ripple-light="true">Month</button>
								</div>
								<div class="ml-4 flex items-center gap-2">
									<div class="rounded-full bg-white/90 px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm dark:bg-slate-800/70 dark:text-white">
										Total Attendees: <span id="attendanceTotal">—</span>
									</div>
									<div class="rounded-full bg-rose-50/90 px-3 py-1 text-xs font-semibold text-rose-600 shadow-sm dark:bg-rose-900/20 dark:text-rose-200">
										Active Alerts: <span id="alertsTotal">—</span>
									</div>
								</div>
							</div>
						</header>
						<div class="mt-6 w-full rounded-2xl chart-container p-4 bg-white/70 border border-slate-100 shadow-sm dark:bg-slate-900/60 dark:border-slate-800">
							<div class="grid grid-cols-1 gap-4 lg:grid-cols-3 lg:items-stretch">
								<div class="col-span-2 h-72 w-full rounded-2xl bg-transparent p-3">
									<div class="h-full w-full rounded-xl bg-gradient-to-tr from-white/80 to-brand-50/60 p-3 border border-dashed border-slate-100/60 dark:border-slate-700/40">
										<canvas id="attendanceChart" class="w-full h-full"></canvas>
									</div>
								</div>
								<div class="col-span-1 h-72 w-full rounded-2xl bg-transparent p-3 flex items-center justify-center">
									<div class="h-full w-full rounded-xl bg-white/90 p-3 flex items-center justify-center border border-slate-100/60 dark:bg-slate-900/70 dark:border-slate-800">
										<canvas id="attendancePieChart" class="max-h-[220px] w-full"></canvas>
									</div>
								</div>
							</div>
							
							<!-- Statistics Cards Below Charts -->
							<div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
								<div class="rounded-xl border border-slate-200/60 bg-gradient-to-br from-emerald-50 to-emerald-100/50 p-4 dark:border-slate-800 dark:from-emerald-900/20 dark:to-emerald-800/10">
									<p class="text-xs uppercase text-slate-600 dark:text-slate-400">Weekly Average</p>
									<p class="mt-2 text-2xl font-bold text-emerald-700 dark:text-emerald-400" id="weeklyAverage">—</p>
									<p class="mt-1 text-xs text-slate-500 dark:text-slate-400">students/day</p>
								</div>
								<div class="rounded-xl border border-slate-200/60 bg-gradient-to-br from-blue-50 to-blue-100/50 p-4 dark:border-slate-800 dark:from-blue-900/20 dark:to-blue-800/10">
									<p class="text-xs uppercase text-slate-600 dark:text-slate-400">Peak Day</p>
									<p class="mt-2 text-2xl font-bold text-blue-700 dark:text-blue-400" id="peakDay">—</p>
									<p class="mt-1 text-xs text-slate-500 dark:text-slate-400" id="peakDayCount">— students</p>
								</div>
								<div class="rounded-xl border border-slate-200/60 bg-gradient-to-br from-rose-50 to-rose-100/50 p-4 dark:border-slate-800 dark:from-rose-900/20 dark:to-rose-800/10">
									<p class="text-xs uppercase text-slate-600 dark:text-slate-400">Lowest Day</p>
									<p class="mt-2 text-2xl font-bold text-rose-700 dark:text-rose-400" id="lowestDay">—</p>
									<p class="mt-1 text-xs text-slate-500 dark:text-slate-400" id="lowestDayCount">— students</p>
								</div>
								
								<div class="rounded-xl border border-slate-200/60 bg-gradient-to-br from-amber-50 to-amber-100/50 p-4 dark:border-slate-800 dark:from-amber-900/20 dark:to-amber-800/10">
									<p class="text-xs uppercase text-slate-600 dark:text-slate-400">Trend</p>
									<p class="mt-2 text-2xl font-bold text-amber-700 dark:text-amber-400" id="trendPercent">—</p>
									<p class="mt-1 text-xs text-slate-500 dark:text-slate-400" id="trendLabel">no change</p>
								</div>
							</div>
						</div>
					</div>

					<div class="glass-card flex flex-col rounded-3xl p-6 shadow-soft fade-in" style="animation-delay: 0.5s;">
						<header class="flex items-center justify-between">
							<div>
								<h3 class="text-lg font-bold text-slate-900 dark:text-white">Top Classes by Attendance</h3>
								<p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Last 30 days</p>
							</div>
							<span class="rounded-full px-3 py-1 text-xs font-semibold accent-chip">History</span>
						</header>
						<ul id="topClassesList" class="mt-6 space-y-5 text-sm">
							<li class="flex items-center justify-center py-8 text-slate-400">
								<i class="fas fa-spinner fa-spin mr-2"></i> Loading...
							</li>
						</ul>
						
						<!-- Class History Cards Grid -->

								<div class="flex items-center justify-between rounded-2xl border border-slate-200/60 bg-white/70 p-3 shadow-sm dark:border-slate-800 dark:bg-slate-900/70">
									<div class="flex items-center gap-3">
										<span class="flex h-9 w-9 items-center justify-center rounded-full bg-emerald-100 text-emerald-600"><i class="fas fa-door-open"></i></span>
										<div>
											<p class="font-semibold text-slate-900 dark:text-white">Cafeteria</p>
											<span class="text-xs text-slate-500 dark:text-slate-400">Current density: 55%</span>
										</div>
									</div>
									<div class="text-sm font-semibold text-emerald-600">Low</div>
								</div>
							</div>
						</div>
					</div>
				</section>

				<!-- My Attendance Records -->
				<section id="attendance" class="glass-card rounded-3xl p-6 shadow-soft fade-in" style="animation-delay: 1s;">
					<header class="flex items-center justify-between mb-4">
						<div>
							<h3 class="text-lg font-bold text-slate-900 dark:text-white">My Attendance History</h3>
							<p class="text-xs text-slate-500 dark:text-slate-400">Your attendance records for the last 30 days.</p>
						</div>
					</header>

					<div class="overflow-auto rounded-2xl border border-slate-200/60 dark:border-slate-800">
						<table class="min-w-full divide-y divide-slate-200 dark:divide-slate-800 text-sm">
							<thead class="bg-slate-50/70 dark:bg-slate-900/60">
								<tr>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Date</th>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Day</th>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Check-in Time</th>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Status</th>
								</tr>
							</thead>
							<tbody class="divide-y divide-slate-200 dark:divide-slate-800 bg-white/70 dark:bg-slate-900/70">
								{% for record in records %}
								<tr>
									<td class="px-4 py-3">
										<div class="font-medium text-slate-800 dark:text-white">{{ record.date|date:"M d, Y" }}</div>
									</td>
									<td class="px-4 py-3 text-slate-600 dark:text-slate-300">{{ record.date|date:"l" }}</td>
									<td class="px-4 py-3 text-slate-600 dark:text-slate-300">{{ record.time|date:"g:i A" }}</td>
									<td class="px-4 py-3">
										{% if record.status == "On-Time" %}
										<span class="inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-semibold text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">
											<i class="fas fa-check-circle mr-1"></i> On-Time
										</span>
										{% else %}
										<span class="inline-flex items-center rounded-full bg-orange-100 px-2.5 py-0.5 text-xs font-semibold text-orange-700 dark:bg-orange-900/30 dark:text-orange-400">
											<i class="fas fa-clock mr-1"></i> Late
										</span>
										{% endif %}
									</td>
								</tr>
								{% empty %}
								<tr><td colspan="4" class="px-4 py-6 text-center text-slate-500">No attendance records found for the last 30 days.</td></tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</section>

				<!-- <section class="glass-card rounded-3xl border accent-border p-6 shadow-soft fade-in" style="animation-delay: 1s; background-image: linear-gradient(to bottom right, rgba(var(--accent-500-rgb),0.06), rgba(99,102,241,0));">
					<div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
						<div>
							<h3 class="text-lg font-bold text-slate-900 dark:text-white">Need deeper insights?</h3>
							<p class="text-sm accent-text-strong">Connect with CampusTrack AI Lab to tailor predictive analytics for your institution.</p>
						</div>
						<div class="flex flex-wrap gap-3">
							<button class="inline-flex items-center gap-2 rounded-full accent-gradient-r px-5 py-2 text-sm font-semibold text-white shadow-soft transition-all duration-300 hover:shadow-lg" data-ripple-light="true">
								Schedule demo <i class="fas fa-arrow-right text-xs"></i>
							</button>
							<button class="inline-flex items-center gap-2 rounded-full border accent-border px-5 py-2 text-sm font-semibold accent-text transition-all duration-300 hover:shadow-md" data-ripple-dark="true">
								Download brochure
							</button>
						</div>
					</div>
				</section>  -->
			</main>
		</div>
	</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	// Chart instances (singletons)
	let attendanceChartInstance = null;
	let pieChartInstance = null;

	// Sample weekly attendance percentages (Mon → Sun)
	const labels = ['Mon','Tue','Wed','Thu','Fri','Sat'];
	// Percent values (0-100)
	const dataValues = [92,90,88,93,91,87,];

	// Delay initialization until DOM is ready
	document.addEventListener('DOMContentLoaded', function () {
		const ctx = document.getElementById('attendanceChart');
		const pieCtx = document.getElementById('attendancePieChart');
	const zoneCtx = null; // zoneChart removed for student view

		const colors = [
			'rgba(124,58,237,0.95)',
			'rgba(139,92,246,0.85)',
			'rgba(99,102,241,0.85)',
			'rgba(59,130,246,0.9)',
			'rgba(249,115,22,0.9)',
			'rgba(139,92,246,0.8)'
		];

			if (ctx) {
				// destroy any chart already attached to this canvas (defensive)
				try {
					const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(ctx) : (Chart.helpers && Chart.helpers.getChart ? Chart.helpers.getChart(ctx) : null);
					if (existing) existing.destroy();
				} catch (e) { /* ignore */ }
				attendanceChartInstance = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'Attendance %',
						data: dataValues,
						backgroundColor: colors,
						borderRadius: 8,
						barPercentage: 0.7,
						categoryPercentage: 0.7,
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						y: {
							beginAtZero: true,
							min: 0,
							max: 100,
							ticks: { stepSize: 10, callback: function(value){ return value + '%'; } },
							title: { display: true, text: 'Attendance (%)', color: 'rgba(15,23,42,0.7)' },
							grid: { color: 'rgba(15,23,42,0.04)' }
						},
						x: {
							grid: { display: false },
							title: { display: true, text: 'Weekday', color: 'rgba(15,23,42,0.7)' }
						}
					},
					plugins: {
						legend: { display: false },
						tooltip: {
							backgroundColor: 'rgba(15,23,42,0.9)',
							titleColor: '#fff',
							bodyColor: '#fff',
							callbacks: {
								label: function(context){
									const v = context.parsed && context.parsed.y !== undefined ? context.parsed.y : context.parsed;
									return (context.dataset.label ? context.dataset.label + ': ' : '') + v + '%';
								}
							}
						}
					}
				}
			});
		}

			if (pieCtx) {
				try {
					const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(pieCtx) : (Chart.helpers && Chart.helpers.getChart ? Chart.helpers.getChart(pieCtx) : null);
					if (existing) existing.destroy();
				} catch(e) { /* ignore */ }
			// Example alert breakdown - these should come from your backend in production
			const alertLabels = ['Capacity','Attendance','Sync Issues'];
			const alertCounts = [2,3,1];
			const alertColors = ['rgba(249,115,22,0.95)','rgba(239,68,68,0.9)','rgba(59,130,246,0.9)'];

			pieChartInstance = new Chart(pieCtx, {
				type: 'doughnut',
				data: {
					labels: alertLabels,
					datasets: [{
						data: alertCounts,
						backgroundColor: alertColors,
						hoverOffset: 8,
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					cutout: '58%',
					plugins: {
						legend: {
							position: 'bottom',
							labels: { boxWidth: 10, padding: 8 }
						},
						tooltip: {
							backgroundColor: 'rgba(15,23,42,0.9)',
							titleColor: '#fff',
							bodyColor: '#fff'
						}
					}
				}
			});

			// Populate totals in the header pills
			const attendanceTotalEl = document.getElementById('attendanceTotal');
			if (attendanceTotalEl) attendanceTotalEl.textContent = dataValues.reduce((a,b)=>a+b,0);
		}

			// zone chart removed in student view
	});

	// Student modal + line chart
	(function(){
		// Inject modal HTML at end of body
		const modalHtml = `
		<div id="studentModal" class="fixed inset-0 z-[999] hidden items-end md:items-center justify-center">
			<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
			<div class="relative w-full md:w-[720px] max-w-[92vw] rounded-3xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
				<header class="flex items-center justify-between px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
					<h4 class="text-lg font-bold text-slate-900 dark:text-white" id="smName">Student Report</h4>
					<button id="smClose" class="rounded-full border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-600 hover:border-brand-500 hover:text-brand-600 dark:border-slate-700 dark:text-slate-300"><i class='fas fa-times'></i></button>
				</header>
				<div class="p-5 space-y-5">
					<div class="flex items-center gap-3">
						<img id="smAvatar" class="h-12 w-12 rounded-full object-cover border-2 border-white shadow"/>
						<div>
							<p class="font-semibold text-slate-900 dark:text-white" id="smClass">—</p>
							<p class="text-xs text-slate-500" id="smId">—</p>
						</div>
					</div>
					<div class="grid gap-3 sm:grid-cols-3">
						<div class="rounded-2xl border border-slate-200/60 p-3 text-center dark:border-slate-800"><p class="text-xs text-slate-500">Attendance</p><p class="text-xl font-bold text-slate-900 dark:text-white" id="smRate">—%</p></div>
						<div class="rounded-2xl border border-slate-200/60 p-3 text-center dark:border-slate-800"><p class="text-xs text-slate-500">Present</p><p class="text-xl font-bold text-emerald-600" id="smPresent">—</p></div>
						<div class="rounded-2xl border border-slate-200/60 p-3 text-center dark:border-slate-800"><p class="text-xs text-slate-500">Absent</p><p class="text-xl font-bold text-rose-600" id="smAbsent">—</p></div>
					</div>
					<div class="rounded-2xl border border-slate-200/60 p-3 dark:border-slate-800">
						<canvas id="studentLineChart" class="h-52 w-full"></canvas>
					</div>
				</div>
			</div>
		</div>`;
		const body = document.body;
		body.insertAdjacentHTML('beforeend', modalHtml);

		const modal = document.getElementById('studentModal');
		const smClose = document.getElementById('smClose');
		function openModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
		function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
		smClose.addEventListener('click', closeModal);
		modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

		let lineChartInstance = null;
		function renderLine(labels, values){
			const ctx = document.getElementById('studentLineChart');
			if (!ctx) return;
			if (lineChartInstance) { lineChartInstance.destroy(); }
			lineChartInstance = new Chart(ctx, {
				type: 'line',
				data: { labels, datasets: [{ label: 'Weekly Attendance %', data: values, borderColor: 'rgba(99,102,241,1)', backgroundColor: 'rgba(99,102,241,0.12)', fill: true, tension: 0.35, pointRadius: 3 }] },
				options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15,23,42,0.9)', titleColor: '#fff', bodyColor: '#fff' } } }
			});
		}

		function setText(id, text){ const el = document.getElementById(id); if (el) el.textContent = text; }
		function setSrc(id, src){ const el = document.getElementById(id); if (el) el.src = src; }

		// Bind table action buttons
		document.querySelectorAll('.btn-view').forEach(btn=>{
			btn.addEventListener('click', ()=>{
				const name = btn.getAttribute('data-name');
				const id = btn.getAttribute('data-id');
				const klass = btn.getAttribute('data-class');
				const avatar = btn.getAttribute('data-avatar');
				const rate = btn.getAttribute('data-rate');
				const present = btn.getAttribute('data-present');
				const absent = btn.getAttribute('data-absent');
				const weeks = (btn.getAttribute('data-weeks')||'').split(',');
				const values = (btn.getAttribute('data-values')||'').split(',').map(v=>Number(v));

				setText('smName', name);
				setText('smClass', klass);
				setText('smId', `ID: ${id}`);
				setSrc('smAvatar', avatar);
				setText('smRate', rate ? `${rate}%` : '—%');
				setText('smPresent', present || '—');
				setText('smAbsent', absent || '—');
				renderLine(weeks, values);
				openModal();
			});
		});
	})();

			// Students search/filter (client-side)
				(function(){
					const searchInput = document.getElementById('studentSearch');
					if (!searchInput) return;
					const tbody = document.querySelector('#students table tbody');
					if (!tbody) return;
					// ensure there's a no-results row
					let noRow = tbody.querySelector('.no-results');
					if (!noRow){
						noRow = document.createElement('tr');
						noRow.className = 'no-results hidden';
						noRow.innerHTML = '<td colspan="5" class="px-4 py-6 text-center text-slate-500">No students match your search.</td>';
						tbody.appendChild(noRow);
					}

					function normalize(s){ return (s||'').toString().trim().toLowerCase(); }
					function runFilter(){
						const q = normalize(searchInput.value);
						const rows = Array.from(tbody.querySelectorAll('tr[data-row-pk]'));
						let visible = 0;
						rows.forEach(row=>{
							const name = normalize(row.querySelector('td:nth-child(1) p.font-semibold')?.textContent);
							const sid = normalize(row.querySelector('td:nth-child(2)')?.textContent);
							if (!q || name.includes(q) || sid.includes(q)){
								row.style.display = '';
								visible++;
							} else {
								row.style.display = 'none';
							}
						});
						if (visible === 0) noRow.classList.remove('hidden'); else noRow.classList.add('hidden');
					}

					let timer = null;
					['input','keyup'].forEach(ev=> searchInput.addEventListener(ev, ()=>{
						clearTimeout(timer);
						timer = setTimeout(runFilter, 100);
					}));
				})();

			// Theme customizer (no chart color changes)
		(function(){
			const THEME_KEY = 'campustrack_theme';
			const themeMap = {
				purple: {500:'#6366f1',600:'#4f46e5',700:'#4338ca'},
				blue:   {500:'#3b82f6',600:'#2563eb',700:'#1d4ed8'},
				green:  {500:'#10b981',600:'#059669',700:'#047857'},
				red:    {500:'#ef4444',600:'#dc2626',700:'#b91c1c'},
				violet: {500:'#8b5cf6',600:'#7c3aed',700:'#6d28d9'},
				grey:   {500:'#64748b',600:'#475569',700:'#334155'}
			};
			const updateVars = (c) => {
				const root = document.documentElement;
				root.style.setProperty('--accent-500', c[500]);
				root.style.setProperty('--accent-600', c[600]);
				root.style.setProperty('--accent-700', c[700]);
				const rgb = hexToRgb(c[500]);
				if (rgb) root.style.setProperty('--accent-500-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
			};
			const hexToRgb = (hex) => {
				const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
				return m ? { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) } : null;
			};
			const applyTheme = (name) => {
				const c = themeMap[name] || themeMap.purple;
				updateVars(c);
				const label = document.getElementById('currentTheme');
				if (label) label.textContent = name.charAt(0).toUpperCase()+name.slice(1);
				localStorage.setItem(THEME_KEY, name);
			};
			const init = () => {
				const saved = localStorage.getItem(THEME_KEY) || 'purple';
				applyTheme(saved);
				const container = document.getElementById('themeSwatches');
				if (container) {
					container.addEventListener('click', (e) => {
						const btn = e.target.closest('[data-theme]');
						if (!btn) return;
						const t = btn.getAttribute('data-theme');
						applyTheme(t);
					});
				}
			};
			document.addEventListener('DOMContentLoaded', init);
			// If script loads after DOMContentLoaded, run init immediately
			if (document.readyState === 'complete' || document.readyState === 'interactive') {
				init();
			}
		})();

	// Sidebar active tab handling with smooth scroll and smart padding
	(function(){
		function getAnchorForItem(item){
			if (!item) return null;
			if (item.tagName && item.tagName.toLowerCase() === 'a') return item;
			return item.querySelector('a[href]') || null;
		}

		function clearActive(){
			document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
		}

		function setActiveByHref(href){
			document.querySelectorAll('.nav-item').forEach(item=>{
				const a = getAnchorForItem(item);
				if (!a) return;
				if (a.getAttribute('href') === href) item.classList.add('active');
			});
		}

		function updateScrollPadding(){
			const header = document.querySelector('header');
			const root = document.documentElement;
			if (!header) return;
			const h = header.getBoundingClientRect().height + 12; // small gap
			root.style.setProperty('--scroll-padding', h + 'px');
		}

		function smoothScrollToHash(hash){
			if (!hash || hash === '#') return; // don't scroll for root
			const id = hash.replace(/^#/, '');
			const el = document.getElementById(id);
			if (!el) return;
			// compute the top position accounting for scroll-padding
			const padding = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--scroll-padding')) || 0;
			const rect = el.getBoundingClientRect();
			const offset = rect.top + window.pageYOffset - padding;
			window.scrollTo({ top: offset, behavior: 'smooth' });
		}

		// attach listeners
		document.querySelectorAll('.nav-item').forEach(item=>{
			const a = getAnchorForItem(item);
			if (!a) return;
			a.addEventListener('click', (e)=>{
				const href = a.getAttribute('href') || '#';
				// update url without triggering immediate jump
				if (href.startsWith('#')){
					e.preventDefault();
					// update history
					history.pushState(null, '', href);
					clearActive();
					item.classList.add('active');
					// smooth scroll
					smoothScrollToHash(href);
				}
			});
		});

		window.addEventListener('hashchange', function(){
			updateScrollPadding();
			clearActive();
			setActiveByHref(window.location.hash || '#');
			smoothScrollToHash(window.location.hash || '#');
		});

		// measure on load and resize
		window.addEventListener('resize', updateScrollPadding);
		updateScrollPadding();

		// initial activation based on current hash
		clearActive();
		setActiveByHref(window.location.hash || '#');
		// if we have a hash at load, jump smoothly to it
		if (window.location.hash){
			setTimeout(()=>{ smoothScrollToHash(window.location.hash); }, 60);
		}
	})();

	// Page loader fade-out
	(function(){
		const loader = document.getElementById('pageLoader');
		if (!loader) return;

		function hideLoader(){
			if (!loader) return;
			loader.classList.add('hidden');
			// remove after transition to keep DOM clean
			setTimeout(()=>{ loader.remove(); }, 700);
		}

		// Prefer window.load which waits for images/CSS
		window.addEventListener('load', ()=>{ setTimeout(hideLoader, 240); });

		// Safety fallback in case load is delayed
		setTimeout(()=>{ if (document.readyState === 'complete') hideLoader(); }, 2000);
	})();
</script>
<!-- CSRF helper + Edit/Delete modals and handlers -->
<script>
// CSRF helper
function getCookie(name){
		const value = `; ${document.cookie}`;
		const parts = value.split(`; ${name}=`);
		if (parts.length === 2) return parts.pop().split(';').shift();
}
function getCSRFToken(){
  return getCookie('csrftoken') || (document.querySelector('input[name=csrfmiddlewaretoken]') || {}).value;
}

// Back/Home button
(function(){
	const back = document.getElementById('backHomeBtn');
	if (!back) return;
	back.addEventListener('click', ()=>{ window.location.href = '/'; });
	// optional shortcut: Alt+H to go home
	document.addEventListener('keydown', (e)=>{ if (e.altKey && e.key.toLowerCase() === 'h') window.location.href = '/'; });
})();

// Inject Edit and Delete modals
(function(){
	const html = `
	<div id="editStudentModal" class="fixed inset-0 z-[1000] hidden items-end md:items-center justify-center">
		<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
		<div class="relative w-full md:w-[640px] max-w-[92vw] rounded-3xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
			<header class="flex items-center justify-between px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
				<h4 class="text-lg font-bold text-slate-900 dark:text-white">Edit Student</h4>
				<button data-close="edit" class="rounded-full border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-600 hover:border-amber-500 hover:text-amber-600 dark:border-slate-700 dark:text-slate-300"><i class='fas fa-times'></i></button>
			</header>
			<form id="editStudentForm" class="p-5 space-y-4" enctype="multipart/form-data">
				<input type="hidden" name="pk" id="editPk" />
				<div class="grid gap-4 sm:grid-cols-2">
					<div>
						<label class="text-xs text-slate-500">Name</label>
						<input id="editName" name="name" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" required />
					</div>
					<div>
						<label class="text-xs text-slate-500">Email</label>
						<input id="editEmail" name="email" type="email" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" required />
					</div>
					<div>
						<label class="text-xs text-slate-500">Phone</label>
						<input id="editPhone" name="phone" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div>
						<label class="text-xs text-slate-500">Student ID</label>
						<input id="editStudentId" name="student_id" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div>
						<label class="text-xs text-slate-500">Department</label>
						<input id="editDepartment" name="department" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div>
						<label class="text-xs text-slate-500">Avatar</label>
						<input id="editAvatar" name="avatar" type="file" accept="image/*" class="mt-1 w-full text-sm" />
					</div>
				</div>
				<div class="pt-3 flex justify-end gap-2">
					<button type="button" data-close="edit" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:text-slate-300">Cancel</button>
					<button type="submit" class="rounded-full accent-gradient-r px-4 py-2 text-xs font-semibold text-white shadow-soft">Save changes</button>
				</div>
				<p id="editError" class="text-xs text-rose-600 hidden"></p>
			</form>
		</div>
	</div>

	<div id="deleteConfirmModal" class="fixed inset-0 z-[1000] hidden items-end md:items-center justify-center">
		<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
		<div class="relative w-full md:w-[460px] max-w-[92vw] rounded-2xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
			<header class="px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
				<h4 class="text-base font-bold text-slate-900 dark:text-white">Delete Student</h4>
			</header>
			<div class="p-5">
				<p class="text-sm text-slate-600 dark:text-slate-300">Are you sure you want to delete this student? This action cannot be undone.</p>
				<div class="mt-5 flex justify-end gap-2">
					<button type="button" data-close="delete" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:text-slate-300">Cancel</button>
					<button id="confirmDeleteBtn" class="rounded-full bg-rose-600 px-4 py-2 text-xs font-semibold text-white">Delete</button>
				</div>
			</div>
		</div>
	</div>`;
	document.body.insertAdjacentHTML('beforeend', html);

	const editModal = document.getElementById('editStudentModal');
	const deleteModal = document.getElementById('deleteConfirmModal');
	function openModal(el){ el.classList.remove('hidden'); el.classList.add('flex'); }
	function closeModal(el){ el.classList.add('hidden'); el.classList.remove('flex'); }
	document.querySelectorAll('[data-close="edit"]').forEach(b=> b.addEventListener('click', ()=> closeModal(editModal)));
	document.querySelectorAll('[data-close="delete"]').forEach(b=> b.addEventListener('click', ()=> closeModal(deleteModal)));

	// Open Edit with data
	document.querySelectorAll('.btn-edit').forEach(btn => {
		btn.addEventListener('click', ()=>{
			const pk = btn.getAttribute('data-pk');
			document.getElementById('editPk').value = pk;
			document.getElementById('editName').value = btn.getAttribute('data-name') || '';
			document.getElementById('editEmail').value = btn.getAttribute('data-email') || '';
			document.getElementById('editPhone').value = btn.getAttribute('data-phone') || '';
			document.getElementById('editStudentId').value = btn.getAttribute('data-student_id') || '';
			document.getElementById('editDepartment').value = btn.getAttribute('data-department') || '';
			openModal(editModal);
		});
	});

	// Submit edit via fetch
	document.getElementById('editStudentForm').addEventListener('submit', async (e)=>{
		e.preventDefault();
		const form = e.currentTarget;
		const pk = document.getElementById('editPk').value;
		const url = `/students/${pk}/update/`;
		const fd = new FormData(form);
		fd.delete('pk');
		try {
			const res = await fetch(url, { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCSRFToken() } });
			const data = await res.json();
			if (!res.ok) { throw data; }
			// Update row in table
			const row = document.querySelector(`tr[data-row-pk="${data.student.pk}"]`);
			if (row) {
				// Update name, department, id, avatar
				const nameEl = row.querySelector('td:nth-child(1) p.font-semibold');
				const deptEl = row.querySelector('td:nth-child(1) p.text-xs');
				const idEl = row.querySelector('td:nth-child(2)');
				const clsEl = row.querySelector('td:nth-child(3)');
				const avatarEl = row.querySelector('img');
				if (nameEl) nameEl.textContent = data.student.name;
				if (deptEl) deptEl.textContent = data.student.department || '—';
				if (idEl) idEl.textContent = data.student.student_id;
				if (clsEl) clsEl.textContent = data.student.department || '—';
				if (avatarEl && data.student.avatar_url) avatarEl.src = data.student.avatar_url;
				// Also update data-attrs on buttons
				const viewBtn = row.querySelector('.btn-view');
				const editBtn = row.querySelector('.btn-edit');
				if (viewBtn){
					viewBtn.setAttribute('data-name', data.student.name);
					viewBtn.setAttribute('data-id', data.student.student_id);
					viewBtn.setAttribute('data-class', data.student.department || '—');
					viewBtn.setAttribute('data-avatar', data.student.avatar_url || viewBtn.getAttribute('data-avatar'));
				}
				if (editBtn){
					editBtn.setAttribute('data-name', data.student.name);
					editBtn.setAttribute('data-email', data.student.email);
					editBtn.setAttribute('data-phone', data.student.phone || '');
					editBtn.setAttribute('data-student_id', data.student.student_id);
					editBtn.setAttribute('data-department', data.student.department || '');
					if (data.student.avatar_url) editBtn.setAttribute('data-avatar', data.student.avatar_url);
				}
			}
			closeModal(editModal);
		} catch(err){
			const errBox = document.getElementById('editError');
			errBox.classList.remove('hidden');
			if (err && err.errors){
				errBox.textContent = Object.entries(err.errors).map(([k,v])=>`${k}: ${v}`).join(' | ');
			} else {
				errBox.textContent = 'Failed to save changes.';
			}
		}
	});

	// Delete flow
	let deletePk = null;
	document.querySelectorAll('.btn-delete').forEach(btn => {
		btn.addEventListener('click', ()=>{
			deletePk = btn.getAttribute('data-pk');
			openModal(deleteModal);
		});
	});
	document.getElementById('confirmDeleteBtn').addEventListener('click', async ()=>{
		if (!deletePk) return;
		const url = `/students/${deletePk}/delete/`;
		try{
			const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCSRFToken() } });
			const data = await res.json();
			if (!res.ok) throw data;
			// remove row
			const row = document.querySelector(`tr[data-row-pk="${deletePk}"]`);
			if (row) row.remove();
			closeModal(deleteModal);
			deletePk = null;
		} catch(err){
			closeModal(deleteModal);
			deletePk = null;
			alert('Failed to delete student');
		}
	});
})();

// Live Dashboard Updates
(function() {

	async function updateDashboard() {
		try {
			const response = await fetch('/api/dashboard/stats/', {
				credentials: 'include'
			});
			const data = await response.json();

			// Update stats cards
			document.getElementById('attendanceRate').textContent = `${data.attendance_rate}%`;
			document.getElementById('todayAttendance').textContent = data.today_attendance;
			document.getElementById('classesInSession').textContent = data.classes_in_session;
			document.getElementById('punctualityRate').textContent = `${data.punctuality}%`;
			document.getElementById('onTimeCount').textContent = data.on_time_count;

			// Update weekly attendance chart
			updateAttendanceChart(data.weekly_data);

			// Update pie chart
			updatePieChart(data.on_time_count, data.late_count);

			// Update top classes
			updateTopClasses(data.top_classes);

			// Update class history cards
			updateClassHistoryCards();

			// live classroom, recent checkins removed for student view

		} catch (error) {
			console.error('Dashboard update error:', error);
		}
	}

	function updateAttendanceChart(weeklyData) {
		const ctx = document.getElementById('attendanceChart');
		if (!ctx) return;

		const labels = weeklyData.map(d => d.date);
		const values = weeklyData.map(d => d.count);

		// Always destroy the old chart if it exists
		if (attendanceChartInstance) {
			attendanceChartInstance.destroy();
		} else {
			// Defensive: if instance var isn't set, check Chart registry for an existing chart attached to this canvas
			try {
				const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(ctx) : (Chart.helpers && Chart.helpers.getChart ? Chart.helpers.getChart(ctx) : null);
				if (existing) existing.destroy();
			} catch (e) { /* ignore */ }
		}

		// Create fresh chart instance
		attendanceChartInstance = new Chart(ctx, {
			type: 'bar',
			data: {
				labels: labels,
				datasets: [{
					label: 'Daily Attendance',
					data: values,
					backgroundColor: [
						'rgba(99,102,241,0.8)',
						'rgba(99,102,241,0.85)',
						'rgba(99,102,241,0.9)',
						'rgba(99,102,241,0.95)',
						'rgba(99,102,241,1)',
						'rgba(99,102,241,0.92)',
						'rgba(99,102,241,0.87)'
					],
					borderColor: 'rgba(99,102,241,1)',
					borderWidth: 2,
					borderRadius: 8,
					borderSkipped: false,
					hoverBackgroundColor: 'rgba(79, 70, 229, 1)',
					hoverBorderColor: 'rgba(55, 56, 202, 1)',
					hoverBorderWidth: 3
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				animation: {
					duration: 300
				},
				plugins: {
					legend: { display: false },
					tooltip: {
						backgroundColor: 'rgba(15,23,42,0.9)',
						padding: 12,
						titleColor: '#fff',
						bodyColor: '#fff',
						borderColor: 'rgba(99,102,241,0.3)',
						borderWidth: 1,
						cornerRadius: 6,
						displayColors: false
					}
				},
				scales: {
					y: {
						beginAtZero: true,
						ticks: {
							stepSize: 1
						},
						grid: { color: 'rgba(148,163,184,0.1)', drawBorder: false }
					},
					x: {
						grid: { display: false, drawBorder: false },
						ticks: { color: 'rgba(71,85,105,0.6)' }
					}
				}
			}
		});
		
		// Update statistics
		updateAttendanceStats(weeklyData);
	}

	function updateAttendanceStats(weeklyData) {
		if (!weeklyData || weeklyData.length === 0) return;

		const counts = weeklyData.map(d => d.count);
		const dates = weeklyData.map(d => d.date);

		// Calculate average
		const average = Math.round(counts.reduce((a, b) => a + b, 0) / counts.length);
		document.getElementById('weeklyAverage').textContent = average;

		// Find peak day
		const maxCount = Math.max(...counts);
		const maxIndex = counts.indexOf(maxCount);
		document.getElementById('peakDay').textContent = dates[maxIndex];
		document.getElementById('peakDayCount').textContent = maxCount + ' students';

		// Find lowest day
		const minCount = Math.min(...counts);
		const minIndex = counts.indexOf(minCount);
		document.getElementById('lowestDay').textContent = dates[minIndex];
		document.getElementById('lowestDayCount').textContent = minCount + ' students';

		// Calculate trend (first 3 days vs last 3 days) with safe divide-by-zero handling
		const firstThree = counts.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
		const lastThree = counts.slice(-3).reduce((a, b) => a + b, 0) / 3;
		let trendChange = 0;
		if (firstThree === 0) {
			// If there was no activity in the earlier period but some now, treat as 100% increase; otherwise 0
			trendChange = lastThree === 0 ? 0 : 100;
		} else {
			trendChange = Math.round((lastThree - firstThree) / firstThree * 100);
		}
		
		const trendElement = document.getElementById('trendPercent');
		const trendLabel = document.getElementById('trendLabel');
		
		if (trendChange > 0) {
			trendElement.textContent = '+' + trendChange + '%';
			trendElement.parentElement.style.color = 'rgb(34, 197, 94)';
			trendLabel.textContent = 'Increasing';
		} else if (trendChange < 0) {
			trendElement.textContent = trendChange + '%';
			trendElement.parentElement.style.color = 'rgb(239, 68, 68)';
			trendLabel.textContent = 'Decreasing';
		} else {
			trendElement.textContent = '0%';
			trendLabel.textContent = 'Stable';
		}
	}

	function updatePieChart(onTime, late) {
		const pieCtx = document.getElementById('attendancePieChart');
		if (!pieCtx) return;

		// Always destroy the old chart if it exists
		if (pieChartInstance) {
			pieChartInstance.destroy();
		}
		else {
			try {
				const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(pieCtx) : (Chart.helpers && Chart.helpers.getChart ? Chart.helpers.getChart(pieCtx) : null);
				if (existing) existing.destroy();
			} catch(e) { /* ignore */ }
		}

		// Create fresh chart instance
		pieChartInstance = new Chart(pieCtx, {
			type: 'doughnut',
			data: {
				labels: ['On-Time', 'Late'],
				datasets: [{
					data: [onTime, late],
					backgroundColor: ['rgba(16,185,129,0.8)', 'rgba(251,146,60,0.8)'],
					borderWidth: 2,
					borderColor: '#fff'
				}]
			},
			options: {
				responsive: true,
				animation: {
					duration: 300
				},
				plugins: {
					legend: {
						position: 'bottom',
						labels: { padding: 15, font: { size: 11 } }
					},
					tooltip: {
						backgroundColor: 'rgba(15,23,42,0.9)',
						padding: 12
					}
				}
			}
		});
	}

	async function updateClassHistoryCards() {
		const container = document.getElementById('classHistoryCards');
		if (!container) return;

		try {
			const response = await fetch('/api/class-history/', {
				method: 'GET',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json'
				}
			});
			if (!response.ok) throw new Error(`API error: ${response.status}`);
			
			const data = await response.json();
			console.log('Class history data:', data);

			if (!data.classes || Object.keys(data.classes).length === 0) {
				container.innerHTML = `
					<div class="flex items-center justify-center py-6 text-slate-400 col-span-2">
						<i class="fas fa-inbox mr-2"></i> No history data
					</div>
				`;
				return;
			}

			const cardsHTML = Object.entries(data.classes).map(([className, classData]) => {
				const onTimePercent = Math.round(classData.on_time_percentage || 0);
				const statusColor = onTimePercent >= 80 ? 'emerald' : onTimePercent >= 60 ? 'amber' : 'rose';
				const statusBg = {
					emerald: 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800',
					amber: 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800',
					rose: 'bg-rose-50 dark:bg-rose-900/20 border-rose-200 dark:border-rose-800'
				}[statusColor];

				const statusText = {
					emerald: 'text-emerald-700 dark:text-emerald-400',
					amber: 'text-amber-700 dark:text-amber-400',
					rose: 'text-rose-700 dark:text-rose-400'
				}[statusColor];

				return `
					<div class="rounded-xl border ${statusBg} p-3 cursor-pointer hover:shadow-md transition" onclick="showClassHistory('${className}')">
						<div class="flex items-start justify-between mb-2">
							<h4 class="font-bold text-slate-900 dark:text-white text-sm">${className}</h4>
							<span class="text-xs font-semibold ${statusText}">${onTimePercent}%</span>
						</div>
						<div class="space-y-1 text-xs">
							<p class="text-slate-600 dark:text-slate-400"><i class="fas fa-users mr-1"></i> ${classData.unique_students} students</p>
							<p class="text-slate-600 dark:text-slate-400"><i class="fas fa-check-circle mr-1 text-emerald-600"></i> ${classData.total_on_time} on-time</p>
							<p class="text-slate-600 dark:text-slate-400"><i class="fas fa-clock mr-1 text-amber-600"></i> ${classData.total_late} late</p>
						</div>
					</div>
				`;
			}).join('');
			
			container.innerHTML = cardsHTML;
		} catch (error) {
			console.error('Error loading history cards:', error);
			container.innerHTML = `
				<div class="flex items-center justify-center py-6 text-rose-400 col-span-2">
					<i class="fas fa-exclamation-circle mr-2"></i> Error: ${error.message}
				</div>
			`;
		}
	}

	function updateTopClasses(classes) {
		const list = document.getElementById('topClassesList');
		if (!list) return;

		if (classes.length === 0) {
			list.innerHTML = `
				<li class="flex items-center justify-center py-8 text-slate-400">
					<i class="fas fa-inbox mr-2"></i> No attendance data yet
				</li>
			`;
			return;
		}

		list.innerHTML = classes.map(cls => {
			const statusColor = cls.late > cls.on_time ? 'amber' : 'emerald';
			const percentage = Math.round((cls.on_time / cls.count) * 100) || 0;
			
			return `
				<li class="flex items-center justify-between rounded-2xl border border-slate-200/60 px-4 py-3 shadow-sm transition-all duration-300 hover:border-brand-300 hover:shadow-md cursor-pointer dark:border-slate-800" onclick="showClassHistory('${cls.class_name}')">
					<div>
						<p class="font-semibold text-slate-800 dark:text-white">${cls.class_name}</p>
						<span class="text-xs text-slate-500 dark:text-slate-400">${cls.count} students • ${cls.on_time} on-time, ${cls.late} late</span>
					</div>
					<span class="rounded-full bg-${statusColor}-100 px-3 py-1 text-xs font-semibold text-${statusColor}-600">${percentage}%</span>
				</li>
			`;
		}).join('');
	}

	// live classroom updates removed for student view

	// Initial load
	updateDashboard();

	// Auto-refresh every 5 seconds
	setInterval(updateDashboard, 5000);

	// Add event listener for view history button
	const viewHistoryBtn = document.getElementById('viewClassHistoryBtn');
	if (viewHistoryBtn) {
		viewHistoryBtn.addEventListener('click', async () => {
			try {
				const response = await fetch('/api/class-history/', {
					credentials: 'include'
				});
				const data = await response.json();
				
				// Show all classes history in a comprehensive modal
				const allClassesHTML = `
					<div id="allClassesHistoryModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
						<div class="glass-card relative w-full max-w-5xl mx-4 rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
							<div class="flex items-center justify-between mb-6 sticky top-0 bg-gradient-to-b from-white/80 to-white/0 dark:from-slate-900/80 dark:to-slate-900/0 pb-4">
								<div>
									<h3 class="text-2xl font-bold text-slate-900 dark:text-white">All Classes - Attendance History</h3>
									<p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${data.period}</p>
								</div>
								<button onclick="closeAllClassesHistoryModal()" class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
									<i class="fas fa-times text-xl text-slate-600 dark:text-slate-300"></i>
								</button>
							</div>

							<div class="grid lg:grid-cols-2 gap-6">
								${Object.entries(data.classes).map(([className, classData]) => `
									<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-5 dark:border-slate-800 dark:bg-slate-900/30 hover:shadow-lg transition cursor-pointer" onclick="showClassHistory('${className}')">
										<div class="flex items-start justify-between mb-4">
											<div>
												<h4 class="text-lg font-bold text-slate-900 dark:text-white">${className}</h4>
												<p class="text-xs text-slate-500 dark:text-slate-400">${classData.unique_students} unique students</p>
											</div>
											<span class="rounded-full ${classData.on_time_percentage >= 80 ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'} px-3 py-1 text-xs font-semibold">${classData.on_time_percentage}%</span>
										</div>
										
										<div class="grid grid-cols-3 gap-2 mb-4 text-center">
											<div class="rounded-lg bg-slate-100 dark:bg-slate-800 p-2">
												<p class="text-xs text-slate-600 dark:text-slate-400">Total</p>
												<p class="text-lg font-bold text-slate-900 dark:text-white">${classData.total_attendance}</p>
											</div>
											<div class="rounded-lg bg-emerald-100/50 dark:bg-emerald-900/30 p-2">
												<p class="text-xs text-emerald-600 dark:text-emerald-400">On-Time</p>
												<p class="text-lg font-bold text-emerald-600 dark:text-emerald-400">${classData.total_on_time}</p>
											</div>
											<div class="rounded-lg bg-amber-100/50 dark:bg-amber-900/30 p-2">
												<p class="text-xs text-amber-600 dark:text-amber-400">Late</p>
												<p class="text-lg font-bold text-amber-600 dark:text-amber-400">${classData.total_late}</p>
											</div>
										</div>

										<div class="space-y-2">
											<div class="flex justify-between items-center text-xs mb-1">
												<span class="text-slate-600 dark:text-slate-400">On-Time Rate</span>
												<span class="font-bold text-emerald-600">${classData.on_time_percentage}%</span>
											</div>
											<div class="h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
												<div class="h-full bg-gradient-to-r from-emerald-400 to-emerald-600" style="width: ${classData.on_time_percentage}%"></div>
											</div>
										</div>
										
										<div class="mt-4 pt-4 border-t border-slate-200/60 dark:border-slate-700">
											<i class="fas fa-chevron-right text-sm text-brand-600 dark:text-brand-400"></i>
											<p class="text-xs text-brand-600 dark:text-brand-400 font-semibold inline ml-2">View Details</p>
										</div>
									</div>
								`).join('')}
							</div>
						</div>
					</div>
				`;
					
				const existingModal = document.getElementById('allClassesHistoryModal');
				if (existingModal) existingModal.remove();

				document.body.insertAdjacentHTML('beforeend', allClassesHTML);
			} catch (error) {
				console.error('Error loading all classes history:', error);
				alert('Failed to load class history');
			}
		});
	}
})();

window.closeAllClassesHistoryModal = function() {
	const modal = document.getElementById('allClassesHistoryModal');
	if (modal) modal.remove();
};

// Class History Modal// Class History Modal
window.showClassHistory = async function(className) {
	try {
		const response = await fetch('/api/class-history/', {
			credentials: 'include'
		});
		const data = await response.json();
		const classData = data.classes[className];
		
		if (!classData) {
			alert('No data found for this class');
			return;
		}

		const modalHTML = `
			<div id="classHistoryModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
				<div class="glass-card relative w-full max-w-4xl mx-4 rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
					<div class="flex items-center justify-between mb-6">
						<div>
							<h3 class="text-2xl font-bold text-slate-900 dark:text-white">
								<i class="fas fa-chart-bar text-brand-600 mr-2"></i> ${className} - Attendance History
							</h3>
							<p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${data.period}</p>
						</div>
						<button onclick="closeClassHistoryModal()" class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
							<i class="fas fa-times text-xl text-slate-600 dark:text-slate-300"></i>
						</button>
					</div>

					<div class="grid md:grid-cols-4 gap-4 mb-6">
						<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-4 dark:border-slate-800 dark:bg-slate-900/30">
							<p class="text-xs uppercase text-slate-500 mb-1">Total Attendance</p>
							<p class="text-2xl font-bold text-slate-900 dark:text-white">${classData.total_attendance}</p>
							<p class="text-xs text-slate-400 mt-1">${classData.unique_students} unique students</p>
						</div>
						<div class="rounded-2xl border border-emerald-200/60 bg-emerald-50/50 p-4 dark:border-emerald-800 dark:bg-emerald-900/20">
							<p class="text-xs uppercase text-emerald-600 dark:text-emerald-400 mb-1">On-Time</p>
							<p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${classData.total_on_time}</p>
							<p class="text-xs text-emerald-500 mt-1">${classData.on_time_percentage}% rate</p>
						</div>
						<div class="rounded-2xl border border-amber-200/60 bg-amber-50/50 p-4 dark:border-amber-800 dark:bg-amber-900/20">
							<p class="text-xs uppercase text-amber-600 dark:text-amber-400 mb-1">Late</p>
							<p class="text-2xl font-bold text-amber-600 dark:text-amber-400">${classData.total_late}</p>
							<p class="text-xs text-amber-500 mt-1">${Math.round((classData.total_late / classData.total_attendance) * 100)}% rate</p>
						</div>
						<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-4 dark:border-slate-800 dark:bg-slate-900/30">
							<p class="text-xs uppercase text-slate-500 mb-1">Avg per Day</p>
							<p class="text-2xl font-bold text-slate-900 dark:text-white">${Math.round(classData.total_attendance / 30)}</p>
							<p class="text-xs text-slate-400 mt-1">students/day</p>
						</div>
					</div>

					<div class="grid md:grid-cols-2 gap-6">
						<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-4 dark:border-slate-800 dark:bg-slate-900/30">
							<h4 class="font-semibold text-slate-900 dark:text-white mb-4">Last 7 Days Trend</h4>
							<div class="space-y-3">
								${classData.daily_data.map(d => `
									<div class="flex items-center gap-3">
										<span class="text-xs font-semibold text-slate-500 w-8">${d.date}</span>
										<div class="flex-1 h-6 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
											<div class="h-full bg-gradient-to-r from-brand-400 to-brand-600 rounded-full" style="width: ${(d.count / Math.max(...classData.daily_data.map(x => x.count), 1)) * 100}%"></div>
										</div>
										<span class="text-xs font-semibold text-slate-900 dark:text-white w-6 text-right">${d.count}</span>
									</div>
								`).join('')}
							</div>
						</div>

						<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-4 dark:border-slate-800 dark:bg-slate-900/30">
							<h4 class="font-semibold text-slate-900 dark:text-white mb-4">Attendance Status Breakdown</h4>
							<div class="space-y-4">
								<div>
									<div class="flex justify-between text-xs mb-2">
										<span class="text-slate-600 dark:text-slate-300">On-Time Percentage</span>
										<span class="font-bold text-emerald-600">${classData.on_time_percentage}%</span>
									</div>
									<div class="h-3 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
										<div class="h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full" style="width: ${classData.on_time_percentage}%"></div>
									</div>
								</div>
								<div>
									<div class="flex justify-between text-xs mb-2">
										<span class="text-slate-600 dark:text-slate-300">Late Percentage</span>
										<span class="font-bold text-amber-600">${Math.round((classData.total_late / classData.total_attendance) * 100)}%</span>
									</div>
									<div class="h-3 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
										<div class="h-full bg-gradient-to-r from-amber-400 to-amber-600 rounded-full" style="width: ${Math.round((classData.total_late / classData.total_attendance) * 100)}%"></div>
									</div>
								</div>
								<div class="mt-4 rounded-xl border border-brand-200/60 bg-brand-50/50 p-3 dark:border-brand-800 dark:bg-brand-900/20">
									<p class="text-xs text-brand-700 dark:text-brand-200">
										<i class="fas fa-info-circle mr-1"></i> 
										${classData.on_time_percentage >= 90 ? "Excellent punctuality! Keep up the good work." : classData.on_time_percentage >= 75 ? "Good attendance rate. Room for improvement." : "Needs attention to punctuality."}
									</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		`;

		// Remove any existing modal
		const existingModal = document.getElementById('classHistoryModal');
		if (existingModal) existingModal.remove();

		document.body.insertAdjacentHTML('beforeend', modalHTML);
	} catch (error) {
		console.error('Error loading class history:', error);
		alert('Failed to load class history');
	}
};

window.closeClassHistoryModal = function() {
	const modal = document.getElementById('classHistoryModal');
	if (modal) modal.remove();
};

// Close modal on outside click
document.addEventListener('click', function(e) {
	if (e.target && e.target.id === 'classHistoryModal') {
		window.closeClassHistoryModal();
	}
});

// Unknown Face Modal
window.showUnknownFaceModal = function(imageUrl, detectedAt, className) {
	const modalHTML = `
		<div id="unknownFaceModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
			<div class="glass-card relative w-full max-w-2xl mx-4 rounded-3xl p-6 shadow-2xl">
				<div class="flex items-center justify-between mb-4">
					<h3 class="text-xl font-bold text-slate-900 dark:text-white">
						<i class="fas fa-user-secret text-rose-600 mr-2"></i> Unknown Face Detected
					</h3>
					<button onclick="closeUnknownFaceModal()" class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
						<i class="fas fa-times text-xl text-slate-600 dark:text-slate-300"></i>
					</button>
				</div>
				
				<div class="grid md:grid-cols-2 gap-6">
					<div class="rounded-2xl overflow-hidden bg-slate-900">
						<img src="${imageUrl}" alt="Unknown Face" class="w-full h-auto object-contain" style="max-height: 400px;">
					</div>
					
					<div class="flex flex-col justify-center space-y-4">
						<div class="rounded-2xl border border-slate-200/60 p-4 dark:border-slate-800">
							<p class="text-xs uppercase text-slate-500 mb-1">Detected At</p>
							<p class="text-lg font-semibold text-slate-900 dark:text-white">${detectedAt}</p>
						</div>
						
						<div class="rounded-2xl border border-slate-200/60 p-4 dark:border-slate-800">
							<p class="text-xs uppercase text-slate-500 mb-1">Class</p>
							<p class="text-lg font-semibold text-slate-900 dark:text-white">${className || 'Unknown'}</p>
						</div>
						
						<div class="rounded-2xl border border-rose-200/60 bg-rose-50/80 p-4 dark:border-rose-800 dark:bg-rose-900/20">
							<div class="flex items-start gap-2">
								<i class="fas fa-exclamation-triangle text-rose-600 mt-1"></i>
								<div>
									<p class="text-sm font-semibold text-rose-900 dark:text-rose-100">Action Required</p>
									<p class="text-xs text-rose-700 dark:text-rose-200 mt-1">This person was not recognized in the system. Please verify identity and add to database if authorized.</p>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div class="mt-6 flex justify-end gap-3">
					<button onclick="closeUnknownFaceModal()" class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800">
						Close
					</button>
					<button class="rounded-lg bg-brand-600 hover:bg-brand-700 px-4 py-2 text-sm font-semibold text-white shadow-md transition">
						<i class="fas fa-user-plus mr-2"></i> Add to System
					</button>
				</div>
			</div>
		</div>
	`;
	
	document.body.insertAdjacentHTML('beforeend', modalHTML);
};

window.closeUnknownFaceModal = function() {
	const modal = document.getElementById('unknownFaceModal');
	if (modal) {
		modal.remove();
	}
};

// Attendance Modal Functionality
(function() {
	const logAttendanceBtn = document.getElementById('logAttendanceBtn');
	if (!logAttendanceBtn) return;

	// Create Attendance Modal
	const modalHTML = `
	<div id="attendanceModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm" role="dialog" aria-modal="true">
		<div class="glass-card relative w-full max-w-4xl mx-4 rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
			<div class="flex items-center justify-between mb-6">
				<div>
					<h2 class="text-2xl font-bold text-slate-900 dark:text-white">Log Attendance</h2>
					<p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Start camera to mark student attendance</p>
				</div>
				<button id="closeAttendanceModal" class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition" aria-label="Close">
					<i class="fas fa-times text-xl text-slate-600 dark:text-slate-300"></i>
				</button>
			</div>

			<!-- Camera Feed -->
			<div class="relative mb-6 rounded-2xl overflow-hidden bg-slate-900" style="height: 400px;">
				<img id="attendanceVideoFeed" src="" alt="Camera Feed" class="w-full h-full object-cover hidden">
				<div id="attendanceCameraPlaceholder" class="w-full h-full flex items-center justify-center">
					<div class="text-center text-slate-400">
						<i class="fas fa-camera text-6xl mb-4 opacity-50"></i>
						<p class="text-lg">Configure settings and click "Start Camera"</p>
					</div>
				</div>
			</div>

			<!-- Controls -->
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
				<div>
					<label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
						<i class="fas fa-graduation-cap mr-1"></i> Select Class
					</label>
					<select id="attendanceClass" class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
						<option value="">-- Select Class --</option>
						<option value="BCA">BCA</option>
						<option value="BSC">BSC</option>
						<option value="BCOM">BCOM</option>
						<option value="ELECTRONICS">ELECTRONICS</option>
					</select>
				</div>
				<div>
					<label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
						<i class="fas fa-clock mr-1"></i> Cutoff Time
					</label>
					<input type="time" id="attendanceCutoffTime" class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500" value="09:00">
				</div>
				<div class="flex items-end">
					<button id="startAttendanceCameraBtn" class="w-full rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 text-sm font-semibold shadow-md transition">
						<i class="fas fa-play mr-2"></i> Start Camera
					</button>
					<button id="stopAttendanceCameraBtn" class="w-full rounded-lg bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 text-sm font-semibold shadow-md transition hidden">
						<i class="fas fa-stop mr-2"></i> Stop Camera
					</button>
				</div>
			</div>

			<!-- Status Message -->
			<div id="attendanceMessage" class="hidden rounded-lg p-4 mb-4">
				<div class="flex items-center gap-3">
					<i class="fas fa-info-circle text-xl"></i>
					<div id="attendanceMessageContent"></div>
				</div>
			</div>

			<!-- Instructions -->
			<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
				<div class="flex items-start gap-3">
					<i class="fas fa-info-circle text-blue-600 dark:text-blue-400 text-lg mt-1"></i>
					<div class="text-sm text-blue-900 dark:text-blue-100">
						<p class="font-semibold mb-2">How it works:</p>
						<ul class="space-y-1 text-xs">
							<li>• Students crossing the red line will be automatically detected</li>
							<li>• First crossing = Check-In, second crossing = Check-Out</li>
							<li>• Late arrivals (after cutoff time) will be marked as "Late"</li>
							<li>• Unknown faces will trigger an alert and be saved for review</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>`;

	document.body.insertAdjacentHTML('beforeend', modalHTML);

	const modal = document.getElementById('attendanceModal');
	const closeBtn = document.getElementById('closeAttendanceModal');
	const startBtn = document.getElementById('startAttendanceCameraBtn');
	const stopBtn = document.getElementById('stopAttendanceCameraBtn');
	const videoFeed = document.getElementById('attendanceVideoFeed');
	const placeholder = document.getElementById('attendanceCameraPlaceholder');
	const classSelect = document.getElementById('attendanceClass');
	const cutoffTime = document.getElementById('attendanceCutoffTime');
	const messageBox = document.getElementById('attendanceMessage');
	const messageContent = document.getElementById('attendanceMessageContent');

	let currentSessionId = null;
	let statusInterval = null;

	function openModal() {
		modal.classList.remove('hidden');
		modal.classList.add('flex');
	}

	function closeModal() {
		modal.classList.add('hidden');
		modal.classList.remove('flex');
		if (currentSessionId) {
			stopCamera();
		}
	}

	function showMessage(content, type = 'info') {
		messageBox.className = `rounded-lg p-4 mb-4 ${
			type === 'success' ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-900 dark:text-green-100' :
			type === 'error' ? 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-900 dark:text-red-100' :
			type === 'warning' ? 'bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-amber-900 dark:text-amber-100' :
			'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 text-blue-900 dark:text-blue-100'
		}`;
		messageContent.innerHTML = content;
		messageBox.classList.remove('hidden');
	}

	function pollStatus() {
		if (!currentSessionId) return;
		
		statusInterval = setInterval(async () => {
			try {
				const res = await fetch(`/api/attendance/status/${currentSessionId}/`);
				const data = await res.json();
				
				if (data.last_result) {
					if (data.last_result.unknown) {
						showMessage(data.last_result.message, 'warning');
					} else {
						showMessage(`
							<strong>Attendance Marked</strong><br>
							<span class="text-sm">Student ID: ${data.last_result.student_id}</span><br>
							<span class="text-sm">Name: ${data.last_result.name}</span><br>
							<span class="text-sm">Action: ${data.last_result.action}</span><br>
							<span class="text-sm">Time: ${data.last_result.time}</span><br>
							<span class="text-sm">Status: <strong>${data.last_result.status}</strong></span>
						`, data.last_result.status === 'Late' ? 'warning' : 'success');
					}
					// Clear result
					data.last_result = null;
				}
				
				if (!data.active) {
					clearInterval(statusInterval);
					stopCamera();
				}
			} catch (error) {
				console.error('Status poll error:', error);
			}
		}, 500);
	}

	async function startCamera() {
		const className = classSelect.value;
		const cutoff = cutoffTime.value;

		if (!className) {
			showMessage('Please select a class', 'error');
			return;
		}

		if (!cutoff) {
			showMessage('Please set a cutoff time', 'error');
			return;
		}

		try {
			const res = await fetch('/api/attendance/start/', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					class_name: className,
					cutoff_time: cutoff
				})
			});

			const data = await res.json();

			if (data.success) {
				currentSessionId = data.session_id;
				placeholder.classList.add('hidden');
				videoFeed.classList.remove('hidden');
				videoFeed.src = `/api/attendance/video-feed/${currentSessionId}/`;
				startBtn.classList.add('hidden');
				stopBtn.classList.remove('hidden');
				classSelect.disabled = true;
				cutoffTime.disabled = true;
				showMessage('Camera started. Students will be automatically detected.', 'success');
				pollStatus();
			} else {
				showMessage(data.error || 'Failed to start camera', 'error');
			}
		} catch (error) {
			console.error('Start camera error:', error);
			showMessage('Network error occurred', 'error');
		}
	}

	async function stopCamera() {
		if (!currentSessionId) return;

		try {
			await fetch('/api/attendance/stop/', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ session_id: currentSessionId })
			});
		} catch (error) {
			console.error('Stop camera error:', error);
		}

		clearInterval(statusInterval);
		videoFeed.src = '';
		videoFeed.classList.add('hidden');
		placeholder.classList.remove('hidden');
		startBtn.classList.remove('hidden');
		stopBtn.classList.add('hidden');
		classSelect.disabled = false;
		cutoffTime.disabled = false;
		currentSessionId = null;
		messageBox.classList.add('hidden');
	}

	logAttendanceBtn.addEventListener('click', openModal);
	closeBtn.addEventListener('click', closeModal);
	startBtn.addEventListener('click', startCamera);
	stopBtn.addEventListener('click', stopCamera);
	
	// Close on outside click
	modal.addEventListener('click', (e) => {
		if (e.target === modal) closeModal();
	});
})();
</script>
<!-- Hidden form to ensure CSRF cookie is set -->
<form style="display:none">{% csrf_token %}</form>
</body>
</html>