<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>AttendanceTrack | Dashboard</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://unpkg.com/@material-tailwind/html@latest/scripts/ripple.js"></script>
	<script>
		tailwind.config = {
			darkMode: "class",
			theme: {
				extend: {
					fontFamily: {
						sans: ["Inter", "ui-sans-serif", "system-ui"],
					},
					colors: {
						brand: {
							50: "#f0f4ff",
							100: "#e6edfe",
							200: "#c7d2fe",
							300: "#a5b4fc",
							400: "#818cf8",
							500: "#6366f1",
							600: "#4f46e5",
							700: "#4338ca",
							800: "#3730a3",
							900: "#312e81",
						},
					},
					boxShadow: {
						soft: "0 15px 40px -15px rgba(99, 102, 241, 0.3)",
						inset: "inset 0 1px 0 rgba(255,255,255,0.06)",
					},
				},
			},
		};
	</script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<style>
		body {
			background: linear-gradient(135deg, #f0f4ff 0%, #fef3f9 30%, #f0f9ff 60%, #f8fafc 100%);
			position: relative;
			overflow-x: hidden;
		}

		body::before {
			content: '';
			position: fixed;
			top: -50%;
			left: -50%;
			width: 200%;
			height: 200%;
			background: 
				radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
				radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 50%),
				radial-gradient(circle at 40% 90%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
				radial-gradient(circle at 60% 20%, rgba(168, 85, 247, 0.08) 0%, transparent 50%);
			animation: gradientShift 25s ease infinite;
			pointer-events: none;
			z-index: 0;
		}

		@keyframes gradientShift {
			0%, 100% { transform: translate(0, 0) rotate(0deg); }
			33% { transform: translate(5%, -5%) rotate(120deg); }
			66% { transform: translate(-5%, 5%) rotate(240deg); }
		}

		.glass-card {
			background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
			backdrop-filter: blur(24px) saturate(180%);
			-webkit-backdrop-filter: blur(24px) saturate(180%);
			border: 1px solid rgba(255, 255, 255, 0.5);
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.9);
			position: relative;
			z-index: 1;
			transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		}

		.glass-card::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 3px;
			background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), rgba(236, 72, 153, 0.5), transparent);
			opacity: 0;
			transition: opacity 0.4s ease;
		}

		.glass-card:hover {
			box-shadow: 0 12px 48px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 1);
			transform: translateY(-2px);
		}

		.glass-card:hover::before {
			opacity: 1;
		}

		.metric-card {
			position: relative;
			overflow: hidden;
			transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		}

		.metric-card::after {
			content: '';
			position: absolute;
			top: -50%;
			left: -50%;
			width: 200%;
			height: 200%;
			background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
			opacity: 0;
			transition: opacity 0.4s ease;
			pointer-events: none;
		}

		.metric-card:hover {
			transform: translateY(-8px) scale(1.02);
			box-shadow: 0 25px 50px -15px rgba(99, 102, 241, 0.35);
		}

		.metric-card:hover::after {
			opacity: 0.4;
		}

		.dark body {
			background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #1e1b4b 100%);
		}

		.dark .glass-card {
			background: rgba(15, 23, 42, 0.75);
			border: 1px solid rgba(71, 85, 105, 0.4);
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
		}

		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(20px); }
			to { opacity: 1; transform: translateY(0); }
		}

		@keyframes slideInLeft {
			from { opacity: 0; transform: translateX(-30px); }
			to { opacity: 1; transform: translateX(0); }
		}

		@keyframes slideInRight {
			from { opacity: 0; transform: translateX(30px); }
			to { opacity: 1; transform: translateX(0); }
		}

		@keyframes scaleIn {
			from { opacity: 0; transform: scale(0.95); }
			to { opacity: 1; transform: scale(1); }
		}

		@keyframes float {
			0%, 100% { transform: translateY(0px); }
			50% { transform: translateY(-10px); }
		}

		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.7; }
		}

		.fade-in {
			animation: fadeIn 0.6s ease-out forwards;
		}

		.slide-in-left {
			animation: slideInLeft 0.6s ease-out forwards;
		}

		.slide-in-right {
			animation: slideInRight 0.6s ease-out forwards;
		}

		.scale-in {
			animation: scaleIn 0.5s ease-out forwards;
		}

		.floating {
			animation: float 3s ease-in-out infinite;
		}

		/* Interactive badges */
		.status-badge {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.5rem 1rem;
			border-radius: 9999px;
			font-size: 0.875rem;
			font-weight: 600;
			transition: all 0.3s ease;
			cursor: pointer;
		}

		.status-badge:hover {
			transform: scale(1.05);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		}

		.status-badge.success {
			background: linear-gradient(135deg, #10b981, #059669);
			color: white;
		}

		.status-badge.warning {
			background: linear-gradient(135deg, #f59e0b, #d97706);
			color: white;
		}

		.status-badge.danger {
			background: linear-gradient(135deg, #ef4444, #dc2626);
			color: white;
		}

		/* Classroom Status Card Styles */
		.status-card {
			background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
			border: 1px solid rgba(226, 232, 240, 0.5);
			border-radius: 1.5rem;
			padding: 1.5rem;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			position: relative;
			overflow: hidden;
		}

		.status-card:hover {
			transform: translateY(-8px);
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
			border-color: rgba(16, 185, 129, 0.3);
		}

		.dark .status-card {
			background: linear-gradient(135deg, rgba(20, 20, 20, 0.9) 0%, rgba(15, 15, 15, 0.8) 100%);
			border: 1px solid rgba(40, 40, 40, 0.8);
		}

		.status-card.active {
			border-color: rgba(16, 185, 129, 0.4);
			background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.04) 100%);
		}

		.dark .status-card.active {
			background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(5, 150, 105, 0.08) 100%);
			border-color: rgba(16, 185, 129, 0.3);
		}

		.capacity-bar {
			height: 6px;
			border-radius: 3px;
			background: linear-gradient(90deg, #e5e7eb 0%, #f3f4f6 100%);
			overflow: hidden;
			position: relative;
		}

		.dark .capacity-bar {
			background: linear-gradient(90deg, rgba(40, 40, 40, 0.6) 0%, rgba(30, 30, 30, 0.6) 100%);
		}

		.capacity-fill {
			height: 100%;
			border-radius: 3px;
			background: linear-gradient(90deg, #10b981 0%, #059669 100%);
			transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
		}

		/* Animated progress bars */
		.progress-bar {
			width: 100%;
			height: 8px;
			background: rgba(148, 163, 184, 0.2);
			border-radius: 9999px;
			overflow: hidden;
			position: relative;
		}

		.progress-bar::after {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			height: 100%;
			width: 30%;
			background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
			animation: shimmer 2s infinite;
		}

		@keyframes shimmer {
			0% { transform: translateX(-100%); }
			100% { transform: translateX(400%); }
		}

		.progress-fill {
			height: 100%;
			background: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899);
			border-radius: 9999px;
			transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 0 12px rgba(99, 102, 241, 0.5);
		}

		/* Pulse animation for live indicators */
		@keyframes pulse-ring {
			0% {
				box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
			}
			50% {
				box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
			}
			100% {
				box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
			}
		}

		.live-indicator {
			display: inline-block;
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: #10b981;
			animation: pulse-ring 2s infinite;
		}

		/* Smooth scroll and smart scroll-padding so anchored sections don't get hidden */
		html {
			scroll-behavior: smooth;
			scroll-padding-top: var(--scroll-padding, 1rem);
		}

		.chart-container {
			background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
			position: relative;
			border-radius: 1rem;
			transition: all 0.3s ease;
		}

		.chart-container:hover {
			box-shadow: 0 10px 40px rgba(99, 102, 241, 0.1);
		}

		.dark .chart-container {
			background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
		}

		/* Floating particles */
		.particle {
			position: fixed;
			pointer-events: none;
			z-index: 0;
			opacity: 0;
		}

		@keyframes particleFloat {
			0% {
				transform: translateY(100vh) scale(0);
				opacity: 0;
			}
			10% {
				opacity: 0.6;
			}
			90% {
				opacity: 0.6;
			}
			100% {
				transform: translateY(-100vh) scale(1);
				opacity: 0;
			}
		}

		/* Button enhancements */
		button, .btn {
			position: relative;
			overflow: hidden;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}

		button::before, .btn::before {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			width: 0;
			height: 0;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.4);
			transform: translate(-50%, -50%);
			transition: width 0.6s, height 0.6s;
		}

		button:hover::before, .btn:hover::before {
			width: 300px;
			height: 300px;
		}

		/* Enhanced stat number animation */
		.stat-number {
			display: inline-block;
			transition: all 0.3s ease;
		}

		.metric-card:hover .stat-number {
			transform: scale(1.1);
			color: var(--accent-600);
		}

		/* Interactive data grid */
		.data-grid {
			display: grid;
			gap: 1.5rem;
			grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
		}

		.data-card {
			position: relative;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}

		.data-card:hover {
			z-index: 10;
		}

		.data-card-inner {
			position: relative;
			padding: 1.5rem;
			border-radius: 1.5rem;
			background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
			border: 1px solid rgba(255,255,255,0.5);
			backdrop-filter: blur(12px);
			transition: all 0.3s ease;
		}

		.data-card:hover .data-card-inner {
			background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
			box-shadow: 0 20px 60px rgba(0,0,0,0.12);
			transform: translateY(-4px);
		}

		/* Accent theme variables and helpers */
		:root {
			/* default = purple */
			--accent-500: #6366f1;
			--accent-600: #4f46e5;
			--accent-700: #4338ca;
			--accent-500-rgb: 99,102,241;
		}

		.accent-gradient-r {
			background-image: linear-gradient(to right, var(--accent-500), var(--accent-600));
		}
		.accent-gradient-br {
			background-image: linear-gradient(to bottom right, var(--accent-500), var(--accent-700));
		}
		.accent-text { color: var(--accent-600); }
		.accent-text-strong { color: var(--accent-700); }
		.accent-border { border-color: rgba(var(--accent-500-rgb), 0.35) !important; }
		.accent-surface {
			background-color: rgba(var(--accent-500-rgb), 0.08);
			color: var(--accent-700);
			border-color: rgba(var(--accent-500-rgb), 0.35);
		}
		.accent-chip {
			background-color: rgba(var(--accent-500-rgb), 0.15);
			color: var(--accent-600);
		}

		/* Modern Sidebar Navigation Styling */
		.nav-item { 
			position: relative; 
			overflow: visible; 
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 14px 16px;
			border-radius: 16px;
			transition: all 280ms cubic-bezier(0.16,1,0.3,1);
			margin-bottom: 8px;
			cursor: pointer;
		}
		
		.nav-item:hover { 
			background: rgba(var(--accent-500-rgb),0.06);
		}
		
		.nav-icon { 
			position: relative; 
			display: flex; 
			align-items: center; 
			justify-content: center; 
			width: 48px; 
			height: 48px; 
			border-radius: 16px; 
			background: linear-gradient(135deg, #f0f4f8 0%, #e8ecf1 100%); 
			color: var(--accent-600); 
			transition: all 280ms cubic-bezier(0.16,1,0.3,1); 
			flex-shrink: 0; 
			z-index: 1; 
			box-shadow: 0 2px 8px rgba(var(--accent-500-rgb),0.08);
		}
		
		.dark .nav-icon { 
			background: linear-gradient(135deg, rgba(30,41,59,0.8) 0%, rgba(15,23,42,0.8) 100%); 
			color: var(--accent-500); 
		}
		
		.nav-icon::after { 
			content: ''; 
			position: absolute; 
			left: -12px; 
			top: 50%; 
			transform: translateY(-50%); 
			width: 64px; 
			height: 64px; 
			border-radius: 9999px; 
			background: radial-gradient(circle at 35% 35%, rgba(var(--accent-500-rgb),0.12), transparent 50%); 
			filter: blur(16px); 
			z-index: 0; 
			opacity: 0; 
			transition: opacity 280ms ease;
		}
		
		.nav-icon > i { 
			position: relative; 
			z-index: 2; 
			font-size: 16px; 
		}
		
		.nav-label { 
			position: relative;
			z-index: 2; 
			color: #5a6b7f; 
			font-weight: 500; 
			transition: all 280ms ease; 
		}
		
		.dark .nav-label {
			color: #a8b5c5;
		}
		
		.nav-item:hover .nav-icon { 
			transform: translateY(-3px) scale(1.08); 
			background-image: linear-gradient(135deg, var(--accent-500), var(--accent-600)); 
			color: #fff; 
			box-shadow: 0 12px 32px rgba(var(--accent-500-rgb),0.25);
		}
		
		.nav-item:hover .nav-icon::after {
			opacity: 1;
		}
		
		.nav-item:hover .nav-label { 
			color: var(--accent-600);
		}
		
		.nav-item .fa-chevron-right { 
			color: rgba(90,107,127,0.4); 
			transition: all 280ms ease;
			font-size: 12px;
		}

		/* Active / selected tab styling */
		.nav-item.active { 
			background: linear-gradient(135deg, rgba(var(--accent-500-rgb),0.12) 0%, rgba(var(--accent-500-rgb),0.06) 100%);
			position: relative;
		}
		
		.nav-item.active::before {
			content: '';
			position: absolute;
			left: 0;
			top: 50%;
			transform: translateY(-50%);
			width: 4px;
			height: 28px;
			border-radius: 0 2px 2px 0;
			background: linear-gradient(180deg, var(--accent-500), var(--accent-600));
		}
		
		.nav-item.active .nav-icon { 
			background-image: linear-gradient(135deg, var(--accent-500), var(--accent-600)); 
			color: #fff; 
			box-shadow: 0 8px 24px rgba(var(--accent-500-rgb),0.3);
			transform: translateY(-2px) scale(1.05);
			position: relative; 
			z-index: 2; 
		}
		
		.nav-item.active .nav-icon::after {
			opacity: 1;
		}
		
		.nav-item.active .nav-label { 
			color: var(--accent-700); 
			font-weight: 600;
			position: relative; 
			z-index: 2; 
		}
		
		.nav-item.active .fa-chevron-right { 
			color: var(--accent-600); 
			transform: translateX(2px);
			position: relative; 
			z-index: 2;
		}
	</style>

	<style>
		/* Loader styles */
		#pageLoader{
			position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(250,250,255,0.95));backdrop-filter:blur(6px);transition:opacity .45s ease,visibility .45s ease;}
		#pageLoader.hidden{opacity:0;visibility:hidden;pointer-events:none}
		#pageLoader .loader-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
		.loader-ring{width:84px;height:84px}
		.ring-bg{stroke:rgba(15,23,42,0.06)}
		.ring{stroke:var(--loader-accent);stroke-dasharray:125;stroke-dashoffset:100;transform-origin:center;animation:spin 1.6s linear infinite, dash 1.4s ease-in-out infinite}
		.loader-text{font-weight:700;color:var(--accent-700);letter-spacing:0.6px}
		@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
		@keyframes dash{0%{stroke-dashoffset:125}50%{stroke-dashoffset:40}100%{stroke-dashoffset:125}}

		/* Modern Navbar Styles */
		.navbar-back-btn:hover i{transform:translateX(-2px)}
		.navbar-cta-btn:hover{transform:translateY(-2px)}
		.navbar-cta-btn:active{transform:scale(0.95)}
		.navbar-notification-btn:hover{background:rgba(255,255,255,0.6)}
		.navbar-notification-btn:hover i{transform:rotate(15deg)}

		/* Profile Dropdown Animation */
		.profile-toggle-btn:hover{background:rgba(255,255,255,0.6)}
		.profile-toggle-btn[aria-expanded="true"]{background:rgba(255,255,255,0.8);border-color:rgba(51,65,85,0.3)}

		.profile-dropdown-menu{
			transform-origin:top right;
			transition: opacity 0.3s cubic-bezier(0.16,1,0.3,1), visibility 0.3s cubic-bezier(0.16,1,0.3,1), transform 0.3s cubic-bezier(0.16,1,0.3,1);
		}

		.profile-dropdown-menu.visible{
			opacity:1 !important;
			visibility:visible !important;
			pointer-events:auto;
			transform: translateY(0) scale(1) !important;
		}

		@keyframes pulse-glow{
			0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.7)}
			50%{box-shadow:0 0 0 4px rgba(34,197,94,0.1)}
		}

		/* Navbar Link hover effects */
		.profile-dropdown-menu a{
			position:relative;
		}

		.profile-dropdown-menu a::before{
			content:'';
			position:absolute;
			left:0;
			top:50%;
			transform:translateY(-50%);
			width:3px;
			height:0;
			background:linear-gradient(to bottom,var(--brand-500),var(--brand-600));
			border-radius:2px;
			transition:all 0.3s cubic-bezier(0.16,1,0.3,1);
		}

		.profile-dropdown-menu a:hover::before{
			height:24px;
		}

		/* Back button hover effects */
		@keyframes backBtnHover{
			0%{transform:translateX(0)}
			100%{transform:translateX(-2px)}
		}

		/* Notification pulse */
		@keyframes bellPulse{
			0%,100%{transform:scale(1) rotate(0deg)}
			25%{transform:scale(1.05) rotate(-5deg)}
			75%{transform:scale(1.05) rotate(5deg)}
		}

		.navbar-notification-btn:hover i{
			animation:bellPulse 0.6s ease-in-out;
		}

		/* Status indicator animations */
		@keyframes statusPulse{
			0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,0.8)}
			50%{box-shadow:0 0 0 3px rgba(34,197,94,0.2)}
		}

		.navbar-profile-dropdown .h-1-5{
			animation:statusPulse 2s infinite;
		}

		/* Navbar responsive adjustments */
		@media(max-width:768px){
			header .hidden.md\:flex{display:none}
		}

		/* Navbar glass morphism effect enhancement */
		header{
			position:sticky;
			background:linear-gradient(135deg,rgba(255,255,255,0.7),rgba(255,255,255,0.4));
		}

		header.dark:bg-slate-950\/50{
			background:linear-gradient(135deg,rgba(15,23,42,0.5),rgba(15,23,42,0.3));
		}

		/* Smooth transitions for all interactive elements */
		.navbar-back-btn,
		.navbar-cta-btn,
		.navbar-notification-btn,
		.profile-toggle-btn{
			will-change:transform,box-shadow;
		}

		/* Navbar item focus states */
		.navbar-back-btn:focus-visible,
		.navbar-cta-btn:focus-visible,
		.navbar-notification-btn:focus-visible,
		.profile-toggle-btn:focus-visible{
			outline:2px solid var(--brand-500);
			outline-offset:2px;
		}
	</style>
</head>
<body class="min-h-screen text-slate-800 dark:bg-slate-950 dark:text-slate-100">
	<!-- Page loader overlay -->
	<div id="pageLoader" aria-hidden="true" style="--loader-accent: var(--accent-500);">
		<div class="loader-wrap">
			<svg class="loader-ring" viewBox="0 0 50 50" aria-hidden="true">
				<circle class="ring-bg" cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle>
				<circle class="ring" cx="25" cy="25" r="20" fill="none" stroke-width="4" stroke-linecap="round"></circle>
			</svg>
			<div class="loader-text">AttendanceTrack</div>
		</div>
	</div>
	<div class="flex min-h-screen">
	<aside class="hidden lg:flex w-80 flex-col gap-6 border-r border-slate-200/40 bg-gradient-to-b from-white/95 to-slate-50/80 px-8 py-8 backdrop-blur-xl dark:border-slate-800/50 dark:from-slate-900/90 dark:to-slate-950/80 lg:sticky lg:top-0 lg:h-screen lg:self-start">
			<!-- Sidebar Header Brand -->
			<div class="flex items-center gap-4 pb-4">
				<div class="flex h-16 w-16 items-center justify-center rounded-2xl accent-gradient-br text-white shadow-lg shadow-red-500/20 transition-transform duration-300 hover:scale-110 hover:shadow-xl hover:shadow-red-500/30">
					<i class="fas fa-pie-chart text-lg"></i>
				</div>
				<div class="flex-1">
					<p class="text-xs uppercase tracking-widest font-semibold text-slate-400 dark:text-slate-500">AttendanceTrack</p>
					<h1 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">Control Center</h1>
				</div>
			</div>
			<div class="h-px bg-gradient-to-r from-slate-200 via-slate-200 to-transparent dark:from-slate-700 dark:via-slate-700 dark:to-transparent"></div>
			<!-- Navigation Menu -->
			<nav class="space-y-0 text-sm font-medium text-slate-600 dark:text-slate-400 flex-1">
				<!-- Overview Item -->
				<a href="#" class="nav-item active group">
					<span class="flex items-center gap-4 flex-1">
						<span class="nav-icon">
							<i class="fas fa-chart-pie text-lg"></i>
						</span>
						<span class="nav-label">Overview</span>
					</span>
					<i class="fas fa-chevron-right"></i>
				</a>

				<!-- Attendance Item -->
				<a href="#attendance" class="nav-item group">
					<span class="flex items-center gap-4 flex-1">
						<span class="nav-icon">
							<i class="fas fa-users text-lg"></i>
						</span>
						<span class="nav-label">Attendance</span>
					</span>
					<i class="fas fa-chevron-right"></i>
				</a>

				<!-- Classrooms Item -->
				<a href="#classes" class="nav-item group">
					<span class="flex items-center gap-4 flex-1">
						<span class="nav-icon">
							<i class="fas fa-door-open text-lg"></i>
						</span>
						<span class="nav-label">Classrooms</span>
					</span>
					<i class="fas fa-chevron-right"></i>
				</a>

				<!-- Alerts Item -->
				<a href="#alerts" class="nav-item group">
					<span class="flex items-center gap-4 flex-1">
						<span class="nav-icon">
							<i class="fas fa-bell text-lg"></i>
						</span>
						<span class="nav-label">Alerts</span>
					</span>
					<i class="fas fa-chevron-right"></i>
				</a>

				<!-- Reports Item -->
				<a href="#reports" class="nav-item group">
					<span class="flex items-center gap-4 flex-1">
						<span class="nav-icon">
							<i class="fas fa-chart-line text-lg"></i>
						</span>
						<span class="nav-label">Reports</span>
					</span>
					<i class="fas fa-chevron-right"></i>
				</a>
			</nav>
		</aside>

		<div class="flex flex-1 flex-col">
			<!-- Modern Redesigned Navbar Header -->
			<header class="sticky top-0 z-40 border-b border-slate-200/40 bg-white/70 backdrop-blur-2xl shadow-sm dark:border-slate-800/60 dark:bg-slate-950/50">
				<div class="flex items-center justify-between px-6 py-4 gap-6">
					<!-- Left Section: Back Button & Branding -->
					<div class="flex items-center gap-4">
						<button id="backHomeBtn" class="navbar-back-btn group inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200/60 bg-white/40 px-3 py-2.5 text-sm font-medium text-slate-700 transition-all duration-300 hover:bg-slate-100/80 hover:border-slate-300 hover:shadow-md active:scale-95 dark:border-slate-700/60 dark:bg-slate-900/40 dark:text-slate-200 dark:hover:bg-slate-800/60" aria-label="Back to homepage">
							<i class="fas fa-arrow-left text-xs transition-transform duration-300 group-hover:-translate-x-1"></i>
							<span class="hidden sm:inline">Back</span>
						</button>
						<div class="h-8 w-px bg-gradient-to-b from-slate-200/0 via-slate-300/50 to-slate-200/0 dark:via-slate-600/50"></div>
						<div class="hidden md:flex flex-col">
							<p class="text-xs font-semibold uppercase tracking-widest text-slate-500 dark:text-slate-400">AttendanceTrack</p>
							<h1 class="text-sm font-bold text-slate-900 dark:text-white">Control Center</h1>
						</div>
					</div>

					<!-- Center Section: Welcome Message & Status -->
					<div class="hidden md:flex flex-1 flex-col px-4">
						<div class="flex items-baseline gap-2">
							<h2 class="text-lg font-bold text-slate-900 dark:text-white">Welcome, <span class="bg-gradient-to-r from-brand-500 to-brand-600 bg-clip-text text-transparent">{{ user.first_name|default:user.username }}</span></h2>
							<span class="inline-flex items-center gap-1 rounded-full bg-green-500/10 px-2.5 py-1 text-xs font-semibold text-green-600 dark:text-green-400">
								<span class="h-1.5 w-1.5 rounded-full bg-green-500 animate-pulse"></span>
								Live
							</span>
						</div>
						<p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">System Status: <span class="font-semibold text-slate-700 dark:text-slate-200">All Systems Operational</span></p>
					</div>

					<!-- Right Section: Actions & Profile -->
					<div class="flex items-center gap-3">
						<!-- Attendance CTA Button -->
						<button id="logAttendanceBtn" class="navbar-cta-btn group inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-brand-500 to-brand-600 px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-brand-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-brand-500/40 hover:scale-105 active:scale-95 dark:shadow-brand-500/20 dark:hover:shadow-brand-500/30" data-ripple-light="true">
							<i class="fas fa-calendar-check text-xs transition-transform duration-300 group-hover:scale-110"></i>
							<span class="hidden sm:inline">Log Attendance</span>
						</button>

						<!-- Notification Bell -->
						<button id="notificationBtn" class="navbar-notification-btn relative inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200/60 bg-white/40 px-3 py-2.5 text-slate-600 transition-all duration-300 hover:bg-slate-100/80 hover:border-slate-300 dark:border-slate-700/60 dark:bg-slate-900/40 dark:text-slate-300 dark:hover:bg-slate-800/60 group" aria-label="Notifications">
							<i class="fas fa-bell text-sm transition-transform duration-300 group-hover:scale-110"></i>
							<span class="absolute top-1 right-1 h-2 w-2 rounded-full bg-red-500 animate-pulse"></span>
						</button>

						<!-- Profile Dropdown -->
						<div class="navbar-profile-dropdown relative">
							<button id="profileToggleBtn" class="profile-toggle-btn inline-flex items-center gap-2.5 rounded-xl border border-slate-200/60 bg-white/40 px-2.5 py-2 transition-all duration-300 hover:bg-slate-100/80 hover:border-slate-300 hover:shadow-md dark:border-slate-700/60 dark:bg-slate-900/40 dark:hover:bg-slate-800/60 group" aria-label="Profile menu" aria-expanded="false">
								<img src="https://images.unsplash.com/photo-1599566150163-29194dcaad36?auto=format&fit=crop&w=256&q=80" alt="Profile avatar" class="h-9 w-9 rounded-lg object-cover border border-slate-200 shadow-sm dark:border-slate-700 transition-transform duration-300 group-hover:scale-110" />
								<div class="hidden lg:flex flex-col leading-tight">
									<p class="text-sm font-semibold text-slate-900 dark:text-white">{{ user.get_full_name|default:user.username }}</p>
									<span class="text-xs text-slate-500 dark:text-slate-400 font-medium">Admin</span>
								</div>
								<i class="fas fa-chevron-down text-xs text-slate-400 transition-transform duration-300 group-hover:text-slate-600 dark:group-hover:text-slate-300"></i>
							</button>

							<!-- Profile Dropdown Menu -->
							<div id="profileDropdown" class="profile-dropdown-menu absolute right-0 top-full mt-2 w-56 rounded-xl border border-slate-200/60 bg-white/95 backdrop-blur-xl shadow-xl opacity-0 invisible transition-all duration-300 dark:border-slate-800/60 dark:bg-slate-900/95 dark:shadow-2xl" style="transform: translateY(-8px) scale(0.95);">
								<!-- Header -->
								<div class="border-b border-slate-200/50 px-4 py-2 dark:border-slate-800/50">
									<p class="font-semibold text-slate-900 dark:text-white text-sm">{{ user.get_full_name|default:user.username }}</p>
									<p class="text-xs text-slate-500 dark:text-slate-400">{{ user.email }}</p>
								</div>
								<!-- Menu Items -->
								<div class="space-y-0 p-1.5">
									<button id="openProfileSettings" class="w-full flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-700 transition-colors duration-200 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-white">
										<i class="fas fa-user-circle w-4 text-center text-slate-400"></i>
										Profile Settings
									</button>
									<a href="#" class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-700 transition-colors duration-200 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-white">
										<i class="fas fa-lock w-4 text-center text-slate-400"></i>
										Change Password
									</a>
									<a href="#" class="flex items-center gap-3 rounded-lg px-3 py-2 text-sm text-slate-700 transition-colors duration-200 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-white">
										<i class="fas fa-headset w-4 text-center text-slate-400"></i>
										Help & Support
									</a>
								</div>
								<!-- Divider -->
								<div class="border-t border-slate-200/50 dark:border-slate-800/50"></div>
								<!-- Logout -->
								<div class="p-1.5">
									<form id="logoutForm" method="POST" action="/logout/" style="display:none;">
										{% csrf_token %}
									</form>
									<button type="button" onclick="handleLogout()" class="w-full flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium text-red-600 transition-colors duration-200 hover:bg-red-50 hover:text-red-700 dark:text-red-400 dark:hover:bg-red-950/20 dark:hover:text-red-300 border-none bg-transparent cursor-pointer">
										<i class="fas fa-sign-out-alt w-4 text-center"></i>
										Logout
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Status Bar -->
				<div class="flex items-center justify-between border-t border-slate-200/30 px-6 py-2.5 text-xs text-slate-600 dark:border-slate-800/50 dark:text-slate-400 bg-gradient-to-r from-slate-50/50 to-transparent dark:from-slate-900/30">
					<div class="flex items-center gap-4">
						<div class="flex items-center gap-1.5">
							<span class="h-1.5 w-1.5 rounded-full bg-green-500"></span>
							<span class="font-medium">System Online</span>
						</div>
						<div class="hidden md:flex items-center gap-1.5">
							<span class="h-1.5 w-1.5 rounded-full bg-blue-500"></span>
							<span>Camera Active</span>
						</div>
					</div>
					<div class="flex items-center gap-2">
						<i class="fas fa-circle-info text-slate-400"></i>
						<span id="navbarTimestamp">00:00 AM</span>
					</div>
				</div>
			</header>

			<main class="relative flex-1 space-y-10 px-6 py-10">
				<section class="grid gap-6 md:grid-cols-2 xl:grid-cols-4">
				<article class="metric-card glass-card group relative overflow-hidden rounded-3xl px-6 py-6 transition-all duration-300 ease-out slide-in-left" data-tooltip="Current attendance percentage">
					<div class="absolute -right-6 -top-6 h-24 w-24 rounded-full bg-brand-100/80 blur-2xl group-hover:blur-3xl transition-all duration-500"></div>
					<div class="flex items-center justify-between">
						<div class="flex-1">
							<p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400 flex items-center gap-2">
								Attendance Rate
								<span class="live-indicator"></span>
							</p>
							<h3 id="attendanceRate" class="stat-number mt-3 text-3xl font-bold text-slate-900 dark:text-white">—</h3>
							<div class="progress-bar mt-3">
								<div class="progress-fill" id="attendanceProgress" style="width: 0%"></div>
							</div>
						</div>
						<span class="floating flex h-14 w-14 items-center justify-center rounded-2xl bg-gradient-to-br from-brand-500 to-brand-600 text-white shadow-soft">
							<i class="fas fa-user-check text-lg"></i>
						</span>
					</div>
					<p class="mt-4 flex items-center gap-2 text-xs font-medium text-slate-500"><i class="fas fa-users"></i> <span id="todayAttendance">—</span> students today</p>
				</article>
				
				<article class="metric-card glass-card group relative overflow-hidden rounded-3xl px-6 py-6 transition-all duration-300 ease-out slide-in-left" style="animation-delay: 0.1s;" data-tooltip="Active classroom sessions">
					<div class="absolute -right-8 -top-8 h-28 w-28 rounded-full bg-sky-100/80 blur-2xl group-hover:blur-3xl transition-all duration-500"></div>
					<div class="flex items-center justify-between">
						<div class="flex-1">
							<p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400 flex items-center gap-2">
								Classes in Session
								<span class="live-indicator"></span>
							</p>
							<h3 id="classesInSession" class="stat-number mt-3 text-3xl font-bold text-slate-900 dark:text-white">—</h3>
							<span class="status-badge success mt-3 inline-flex text-xs px-2 py-1">
								<i class="fas fa-check-circle"></i> Active
							</span>
						</div>
						<span class="floating flex h-14 w-14 items-center justify-center rounded-2xl bg-gradient-to-br from-sky-500 to-sky-600 text-white shadow-soft" style="animation-delay: 0.5s;">
							<i class="fas fa-door-open text-lg"></i>
						</span>
					</div>
					<p class="mt-4 flex items-center gap-2 text-xs font-medium text-sky-500"><i class="fas fa-circle"></i> Live updates</p>
				</article>
				
				<article class="metric-card glass-card group relative overflow-hidden rounded-3xl px-6 py-6 transition-all duration-300 ease-out slide-in-right" style="animation-delay: 0.2s;" data-tooltip="On-time arrival percentage">
					<div class="absolute -right-8 -top-8 h-28 w-28 rounded-full bg-emerald-100/80 blur-2xl group-hover:blur-3xl transition-all duration-500"></div>
					<div class="flex items-center justify-between">
						<div class="flex-1">
							<p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Average Punctuality</p>
							<h3 id="punctualityRate" class="stat-number mt-3 text-3xl font-bold text-slate-900 dark:text-white">—</h3>
							<div class="progress-bar mt-3">
								<div class="progress-fill" id="punctualityProgress" style="width: 0%; background: linear-gradient(90deg, #10b981, #059669);"></div>
							</div>
						</div>
						<span class="floating flex h-14 w-14 items-center justify-center rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-white shadow-soft" style="animation-delay: 1s;">
							<i class="fas fa-clock text-lg"></i>
						</span>
					</div>
					<p class="mt-4 flex items-center gap-2 text-xs font-medium text-emerald-500"><i class="fas fa-check-circle"></i> <span id="onTimeCount">—</span> on-time arrivals</p>
				</article>
				
				<article class="metric-card glass-card group relative overflow-hidden rounded-3xl px-6 py-6 transition-all duration-300 ease-out slide-in-right" style="animation-delay: 0.3s;" data-tooltip="Unrecognized faces detected">
					<div class="absolute -right-12 -top-10 h-32 w-32 rounded-full bg-rose-100/80 blur-2xl group-hover:blur-3xl transition-all duration-500"></div>
					<div class="flex items-center justify-between">
						<div class="flex-1">
							<p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Unknown Faces</p>
							<h3 id="unknownCount" class="stat-number mt-3 text-3xl font-bold text-slate-900 dark:text-white">—</h3>
							<span class="status-badge danger mt-3 inline-flex text-xs px-2 py-1" id="unknownBadge" style="display: none;">
								<i class="fas fa-exclamation-triangle"></i> Alert
							</span>
						</div>
						<span class="floating flex h-14 w-14 items-center justify-center rounded-2xl bg-gradient-to-br from-rose-500 to-rose-600 text-white shadow-soft" style="animation-delay: 1.5s;">
							<i class="fas fa-user-secret text-lg"></i>
						</span>
					</div>
					<p class="mt-4 flex items-center gap-2 text-xs font-medium text-rose-500"><i class="fas fa-triangle-exclamation"></i> Detected today</p>
				</article>
				</section>

				<section id="attendance" class="grid gap-6 lg:grid-cols-3">
					<div class="glass-card rounded-3xl p-8 shadow-soft lg:col-span-2 fade-in" style="animation-delay: 0.4s;">
						<header class="flex items-center justify-between pb-6 border-b border-slate-200/40 dark:border-zinc-900/60">
							<div class="flex-1">
								<div class="flex items-center gap-3">
									<div class="p-2 rounded-lg bg-brand-500/10 dark:bg-brand-500/20">
										<i class="fas fa-chart-line text-brand-600 dark:text-brand-400"></i>
									</div>
									<h3 class="text-xl font-bold bg-gradient-to-r from-brand-600 to-brand-500 bg-clip-text text-transparent">Weekly Attendance Trend</h3>
									<span class="live-indicator"></span>
								</div>
								<p class="text-xs text-slate-500 dark:text-slate-400 mt-2 ml-11">Updated 15 minutes ago • Real-time Analytics</p>
							</div>
							<div class="flex items-center gap-4">
								<div class="flex items-center gap-2">
									<!-- <button id="btnWeek" class="rounded-full border border-slate-200/40 px-4 py-2 font-semibold text-slate-600 transition-all duration-300 hover:border-brand-500/40 hover:text-brand-600 dark:border-zinc-800/60 dark:text-slate-300 dark:hover:text-brand-300 group">
										<i class="fas fa-calendar-week mr-2 opacity-60 group-hover:opacity-100"></i> Week
									</button> -->
									<button id="btnMonth" class="rounded-full bg-gradient-to-r from-brand-600 to-brand-500 px-4 py-2 font-semibold text-white shadow-lg shadow-brand-500/30 hover:shadow-xl transition-all duration-300 hover:scale-105" data-ripple-light="true">
										<i class="fas fa-calendar-alt mr-2 opacity-90"></i> Month
									</button>
								</div>
								<div class="flex items-center gap-3 pl-4 border-l border-slate-200/40 dark:border-zinc-900/60">
									<div class="flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-500/10 dark:bg-emerald-500/20">
										<i class="fas fa-users text-emerald-600 dark:text-emerald-400"></i>
										<span class="text-sm font-semibold text-emerald-700 dark:text-emerald-300">Total: <span id="attendanceTotal">—</span></span>
									</div>
									<div class="flex items-center gap-2 px-4 py-2 rounded-full bg-rose-500/10 dark:bg-rose-500/20">
										<i class="fas fa-bell text-rose-600 dark:text-rose-400"></i>
										<span class="text-sm font-semibold text-rose-700 dark:text-rose-300">Alerts: <span id="alertsTotal">—</span></span>
									</div>
								</div>
							</div>
						</header>
						<div class="mt-8 w-full rounded-2xl p-4 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-zinc-900/60 dark:to-black border border-slate-200/40 dark:border-zinc-900/60 shadow-sm">
							<div class="grid grid-cols-1 gap-4 lg:grid-cols-3 lg:items-stretch">
								<div class="col-span-2 h-72 w-full rounded-2xl bg-transparent p-3">
									<div class="h-full w-full rounded-xl bg-gradient-to-tr from-white/80 to-brand-50/60 p-3 border border-dashed border-slate-100/60 dark:border-slate-700/40">
										<canvas id="attendanceChart" class="w-full h-full"></canvas>
									</div>
								</div>
								<div class="col-span-1 h-72 w-full rounded-2xl bg-transparent p-3 flex items-center justify-center">
									<div class="h-full w-full rounded-xl bg-white/90 p-3 flex items-center justify-center border border-slate-100/60 dark:bg-slate-900/70 dark:border-slate-800">
										<canvas id="attendancePieChart" class="max-h-[220px] w-full"></canvas>
									</div>
								</div>
							</div>
							
							<!-- Statistics Cards Below Charts -->
							<div class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
								<div class="group rounded-2xl border border-emerald-200/60 bg-gradient-to-br from-emerald-50 to-emerald-100/50 p-5 transition-all hover:shadow-lg dark:border-emerald-900/40 dark:from-emerald-900/20 dark:to-emerald-800/10 hover:-translate-y-1">
									<div class="flex items-center justify-between mb-3">
										<p class="text-xs uppercase font-semibold tracking-wide text-emerald-700 dark:text-emerald-300">Weekly Average</p>
										<i class="fas fa-chart-area text-emerald-500/60 group-hover:text-emerald-600 transition"></i>
									</div>
									<p class="text-3xl font-bold text-emerald-700 dark:text-emerald-400" id="weeklyAverage">—</p>
									<p class="mt-2 text-xs text-emerald-600 dark:text-emerald-300">students/day</p>
								</div>
								<div class="group rounded-2xl border border-blue-200/60 bg-gradient-to-br from-blue-50 to-blue-100/50 p-5 transition-all hover:shadow-lg dark:border-blue-900/40 dark:from-blue-900/20 dark:to-blue-800/10 hover:-translate-y-1">
									<div class="flex items-center justify-between mb-3">
										<p class="text-xs uppercase font-semibold tracking-wide text-blue-700 dark:text-blue-300">Peak Day</p>
										<i class="fas fa-arrow-up text-blue-500/60 group-hover:text-blue-600 transition"></i>
									</div>
									<p class="text-3xl font-bold text-blue-700 dark:text-blue-400" id="peakDay">—</p>
									<p class="mt-2 text-xs text-blue-600 dark:text-blue-300" id="peakDayCount">— students</p>
								</div>
								<div class="group rounded-2xl border border-rose-200/60 bg-gradient-to-br from-rose-50 to-rose-100/50 p-5 transition-all hover:shadow-lg dark:border-rose-900/40 dark:from-rose-900/20 dark:to-rose-800/10 hover:-translate-y-1">
									<div class="flex items-center justify-between mb-3">
										<p class="text-xs uppercase font-semibold tracking-wide text-rose-700 dark:text-rose-300">Lowest Day</p>
										<i class="fas fa-arrow-down text-rose-500/60 group-hover:text-rose-600 transition"></i>
									</div>
									<p class="text-3xl font-bold text-rose-700 dark:text-rose-400" id="lowestDay">—</p>
									<p class="mt-2 text-xs text-rose-600 dark:text-rose-300" id="lowestDayCount">— students</p>
								</div>
								
								<div class="group rounded-2xl border border-amber-200/60 bg-gradient-to-br from-amber-50 to-amber-100/50 p-5 transition-all hover:shadow-lg dark:border-amber-900/40 dark:from-amber-900/20 dark:to-amber-800/10 hover:-translate-y-1">
									<div class="flex items-center justify-between mb-3">
										<p class="text-xs uppercase font-semibold tracking-wide text-amber-700 dark:text-amber-300">Trend</p>
										<i class="fas fa-chart-line text-amber-500/60 group-hover:text-amber-600 transition"></i>
									</div>
									<p class="text-3xl font-bold text-amber-700 dark:text-amber-400" id="trendPercent">—</p>
									<p class="mt-2 text-xs text-amber-600 dark:text-amber-300" id="trendLabel">no change</p>
								</div>
							</div>
						</div>
					</div>

				<div class="glass-card flex flex-col rounded-3xl p-8 shadow-soft fade-in" style="animation-delay: 0.5s;">
					<!-- Header with enhanced styling -->
					<header class="flex items-center justify-between pb-6 border-b border-slate-200/40 dark:border-zinc-900/60">
						<div>
							<h3 class="text-xl font-bold bg-gradient-to-r from-brand-600 to-brand-500 bg-clip-text text-transparent">Top Classes by Attendance</h3>
							<p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Performance over last 30 days</p>
						</div>
						<button class="rounded-full px-4 py-2 text-xs font-semibold bg-brand-500/10 text-brand-600 hover:bg-brand-500/20 transition-colors dark:bg-brand-500/20 dark:text-brand-300">
							<i class="fas fa-history mr-1"></i> History
						</button>
					</header>

					<!-- Main Class Card -->
					<div id="topClassesList" class="mt-8 space-y-4">
						<li class="flex items-center justify-center py-12 text-slate-400 dark:text-slate-500">
							<i class="fas fa-spinner fa-spin mr-3"></i> Loading...
						</li>
					</div>					<!-- Class History Cards Grid -->
					<div id="classHistoryCards" class="mt-8 grid grid-cols-2 gap-4">
						<div class="flex items-center justify-center py-8 text-slate-400 dark:text-slate-500 col-span-2">
							<i class="fas fa-spinner fa-spin mr-3"></i> Loading history...
						</div>
					</div>
					
					<!-- View Details Button -->
					<button id="viewClassHistoryBtn" class="mt-8 inline-flex items-center justify-center gap-2 rounded-xl border border-brand-500/30 px-6 py-3 text-sm font-semibold text-brand-600 hover:bg-brand-500/10 transition-all duration-300 dark:border-brand-500/40 dark:text-brand-300 dark:hover:bg-brand-500/15 group">
						<i class="fas fa-chart-line transition-transform group-hover:scale-110"></i> 
						View Detailed History
						<i class="fas fa-arrow-right text-xs transition-transform group-hover:translate-x-1"></i>
					</button>
				</div>
				</section>

				<section id="classes" class="grid gap-6 xl:grid-cols-3">
				<div class="glass-card rounded-3xl p-8 shadow-soft xl:col-span-2 fade-in" style="animation-delay: 0.6s;">
					<header class="flex items-center justify-between pb-6 border-b border-slate-200/40 dark:border-zinc-900/60">
						<div>
							<div class="flex items-center gap-3">
								<div class="p-2 rounded-lg bg-emerald-500/10 dark:bg-emerald-500/20">
									<i class="fas fa-video text-emerald-600 dark:text-emerald-400"></i>
								</div>
								<h3 class="text-xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-500 bg-clip-text text-transparent">Live Classroom Status</h3>
							</div>
							<p class="text-xs text-slate-500 dark:text-slate-400 mt-2 ml-11">Auto-refreshed every 5 seconds • Real-time monitoring</p>
						</div>
						<span class="rounded-full px-4 py-2 text-xs font-semibold bg-emerald-500/10 text-emerald-600 dark:bg-emerald-500/20 dark:text-emerald-300 animate-pulse flex items-center gap-2">
							<span class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span> Live
						</span>
					</header>
					<div id="liveClassroomStatus" class="mt-8 grid gap-4 md:grid-cols-2">
						<div class="flex items-center justify-center py-12 text-slate-400 dark:text-slate-500 col-span-2">
							<i class="fas fa-spinner fa-spin mr-3"></i> Loading live data...
						</div>
					</div>
				</div>					<div class="glass-card flex flex-col justify-between rounded-3xl p-6 shadow-soft fade-in" style="animation-delay: 0.7s;">
						<header class="flex items-center justify-between">
							<h3 class="text-lg font-bold text-slate-900 dark:text-white">Recent Check-ins</h3>
							<span class="rounded-full px-3 py-1 text-xs font-semibold accent-chip">Live</span>
						</header>
						<ul id="recentCheckins" class="mt-6 space-y-4 text-sm min-h-[200px]">
							<li class="flex items-center justify-center py-8 text-slate-400">
								<i class="fas fa-spinner fa-spin mr-2"></i> Loading...
							</li>
						</ul>
						<div class="mt-6 rounded-2xl border accent-border px-4 py-3 text-xs accent-text-strong dark:border-slate-800 dark:text-slate-200 accent-surface">
							<i class="fas fa-clock mr-2"></i> Showing last 5 check-ins
						</div>
					</div>
				</section>

				<section id="alerts" class="grid gap-6 lg:grid-cols-2">
					<div class="glass-card rounded-3xl p-6 shadow-soft fade-in" style="animation-delay: 0.8s;">
						<header class="flex items-center justify-between">
							<h3 class="text-lg font-bold text-slate-900 dark:text-white">Real-time Alerts</h3>
							<span id="alertsCount" class="rounded-full bg-rose-100 px-3 py-1 text-xs font-semibold text-rose-600">—</span>
						</header>
						<ul id="alertsList" class="mt-6 space-y-4 text-sm max-h-96 overflow-y-auto">
							<li class="flex items-center justify-center py-8 text-slate-400">
								<i class="fas fa-spinner fa-spin mr-2"></i> Loading alerts...
							</li>
						</ul>
				</div>

				<!-- Crowd Detection Report - Commented Out
				<div class="glass-card rounded-3xl p-6 shadow-soft fade-in" style="animation-delay: 0.9s;" id="reports">
					<header class="flex items-center justify-between">
						<div>
							<h3 class="text-lg font-bold text-slate-900 dark:text-white">Crowd Detection Report</h3>
							<p class="text-xs text-slate-500 dark:text-slate-400">Live snapshot of crowd density across monitored zones.</p>
						</div>
						<button id="generateCrowd" class="rounded-full accent-gradient-r px-4 py-2 text-xs font-semibold text-white shadow-soft transition-all duration-300 hover:shadow-lg" data-ripple-light="true">Generate report</button>
					</header>
					<div class="mt-6 grid gap-4 lg:grid-cols-1 text-sm" id="crowdReportContainer">
						<div class="flex items-center justify-center py-8">
							<i class="fas fa-spinner fa-spin mr-2"></i> Loading crowd report...
						</div>
					</div>
				</div>
				-->
			</section>				<!-- Students Directory -->
				<section id="students" class="glass-card rounded-3xl p-6 shadow-soft fade-in" style="animation-delay: 1s;">
					<header class="flex items-center justify-between mb-4">
						<div>
							<h3 class="text-lg font-bold text-slate-900 dark:text-white">Students</h3>
							<p class="text-xs text-slate-500 dark:text-slate-400">Directory of students with quick actions.</p>
						</div>
						<div class="flex items-center gap-4">
							<div class="relative">
								<label for="studentSearch" class="sr-only">Search students</label>
								<div class="relative">
									<input id="studentSearch" type="search" placeholder="Search by name or reg no" class="w-64 rounded-full border border-slate-200 bg-white/80 px-4 pr-10 py-2 text-sm placeholder:text-slate-400 dark:border-slate-700 dark:bg-slate-900/60 dark:placeholder:text-slate-500" />
									<i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
								</div>
							</div>
							<div class="flex gap-2">
							<button class="rounded-full accent-gradient-r px-3 py-1 text-xs font-semibold text-white shadow-soft transition-all duration-300 hover:shadow-lg" data-ripple-light="true">
								<i class="fas fa-plus mr-1"></i> Add student
							</button>
							</div>
						</div>
					</header>

					<div class="overflow-auto rounded-2xl border border-slate-200/60 dark:border-slate-800">
						<table class="min-w-full divide-y divide-slate-200 dark:divide-slate-800 text-sm">
							<thead class="bg-slate-50/70 dark:bg-slate-900/60">
								<tr>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Student</th>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">ID</th>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Class</th>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Attendance</th>
									<th class="px-4 py-3 text-right font-semibold text-slate-600 dark:text-slate-300">Actions</th>
								</tr>
							</thead>
							<tbody class="divide-y divide-slate-200 dark:divide-slate-800 bg-white/70 dark:bg-slate-900/70">
								{% for s in students %}
								<tr data-row-pk="{{ s.pk }}">
									<td class="px-4 py-3">
										<div class="flex items-center gap-3">
											<img src="{% if s.avatar %}{{ s.avatar.url }}{% else %}https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=80&q=60{% endif %}" class="h-9 w-9 rounded-full object-cover" alt="avatar"/>
											<div>
												<p class="font-semibold text-slate-800 dark:text-white">{{ s.user.first_name|default:s.user.username }}</p>
												<p class="text-xs text-slate-500">{{ s.department|default:'—' }}</p>
											</div>
										</div>
									</td>
									<td class="px-4 py-3">{{ s.student_id }}</td>
									<td class="px-4 py-3">{{ s.department|default:'—' }}</td>
									<td class="px-4 py-3"><span class="rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-semibold text-slate-600">—</span></td>
									<td class="px-4 py-3 text-right whitespace-nowrap">
										<button class="btn-view rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-brand-500 hover:text-brand-600 dark:border-slate-700 dark:text-slate-300"
											data-pk="{{ s.pk }}"
											data-id="{{ s.student_id }}" data-name="{{ s.user.first_name|default:s.user.username }}" data-class="{{ s.department|default:'—' }}" data-email="{{ s.user.email }}" data-phone="{{ s.phone }}" data-avatar="{% if s.avatar %}{{ s.avatar.url }}{% else %}https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=160&q=60{% endif %}" data-rate="" data-present="" data-absent="" data-late="" data-weeks="Week 1,Week 2,Week 3,Week 4,Week 5,Week 6,Week 7,Week 8" data-values="92,90,94,93,95,92,94,96">
											<i class="fas fa-eye mr-1"></i> View
										</button>
										<button class="btn-edit ml-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-amber-500 hover:text-amber-600 dark:border-slate-700 dark:text-slate-300"
											data-pk="{{ s.pk }}" data-name="{{ s.user.first_name|default:s.user.username }}" data-email="{{ s.user.email }}" data-phone="{{ s.phone }}" data-student_id="{{ s.student_id }}" data-department="{{ s.department }}" data-avatar="{% if s.avatar %}{{ s.avatar.url }}{% endif %}">
											<i class="fas fa-pen mr-1"></i> Edit
										</button>
										<button class="btn-delete ml-2 rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600 hover:bg-rose-50 dark:border-rose-800/60" data-pk="{{ s.pk }}"><i class="fas fa-trash mr-1"></i> Delete</button>
									</td>
								</tr>
								{% empty %}
								<tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">No students found.</td></tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</section>

				<!-- Faculty Directory -->
				<section id="faculty" class="glass-card rounded-3xl p-6 shadow-soft fade-in" style="animation-delay: 1.1s;">
					<header class="flex items-center justify-between mb-4">
						<div>
							<h3 class="text-lg font-bold text-slate-900 dark:text-white">Faculty</h3>
							<p class="text-xs text-slate-500 dark:text-slate-400">Directory of faculty members with quick actions.</p>
						</div>
						<div class="flex items-center gap-4">
							<div class="relative">
								<label for="facultySearch" class="sr-only">Search faculty</label>
								<div class="relative">
									<input id="facultySearch" type="search" placeholder="Search by name or ID" class="w-64 rounded-full border border-slate-200 bg-white/80 px-4 pr-10 py-2 text-sm placeholder:text-slate-400 dark:border-slate-700 dark:bg-slate-900/60 dark:placeholder:text-slate-500" />
									<i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
								</div>
							</div>
						</div>
					</header>

					<div class="overflow-auto rounded-2xl border border-slate-200/60 dark:border-slate-800">
						<table class="min-w-full divide-y divide-slate-200 dark:divide-slate-800 text-sm">
							<thead class="bg-slate-50/70 dark:bg-slate-900/60">
								<tr>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Faculty</th>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Employee ID</th>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Department</th>
									<th class="px-4 py-3 text-left font-semibold text-slate-600 dark:text-slate-300">Status</th>
									<th class="px-4 py-3 text-right font-semibold text-slate-600 dark:text-slate-300">Actions</th>
								</tr>
							</thead>
							<tbody class="divide-y divide-slate-200 dark:divide-slate-800 bg-white/70 dark:bg-slate-900/70">
								{% for f in faculty_list %}
								<tr data-faculty-pk="{{ f.pk }}" data-status="{{ f.approval_status }}">
									<td class="px-4 py-3">
										<div class="flex items-center gap-3">
											<img src="{% if f.profile_pic %}{{ f.profile_pic.url }}{% else %}https://ui-avatars.com/api/?name={{ f.user.first_name|default:f.user.username }}&background=6366f1&color=fff{% endif %}" class="h-9 w-9 rounded-full object-cover" alt="avatar"/>
											<div>
												<p class="font-semibold text-slate-800 dark:text-white">{{ f.user.first_name }} {{ f.user.last_name }}</p>
												<p class="text-xs text-slate-500">{{ f.user.email|default:'—' }}</p>
											</div>
										</div>
									</td>
									<td class="px-4 py-3">{{ f.employee_id }}</td>
									<td class="px-4 py-3">{{ f.department|default:'—' }}</td>
									<td class="px-4 py-3">
										{% if f.approval_status == 'Pending' %}
										<span class="rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-semibold text-amber-600">Pending</span>
										{% elif f.approval_status == 'Approved' %}
										<span class="rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-semibold text-emerald-600">Approved</span>
										{% else %}
										<span class="rounded-full bg-rose-100 px-2.5 py-0.5 text-xs font-semibold text-rose-600">Rejected</span>
										{% endif %}
									</td>
									<td class="px-4 py-3 text-right whitespace-nowrap">
										{% if f.approval_status == 'Pending' %}
										<!-- Pending: Show Approve/Reject buttons -->
										<button class="btn-faculty-approve rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-600 hover:bg-emerald-100 dark:border-emerald-800/60 dark:bg-emerald-900/30"
											data-pk="{{ f.pk }}">
											<i class="fas fa-check mr-1"></i> Approve
										</button>
										<button class="btn-faculty-reject ml-2 rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold text-rose-600 hover:bg-rose-100 dark:border-rose-800/60 dark:bg-rose-900/30"
											data-pk="{{ f.pk }}">
											<i class="fas fa-times mr-1"></i> Reject
										</button>
										{% else %}
										<!-- Approved/Rejected: Show View/Edit/Delete buttons -->
										<button class="btn-faculty-view rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-brand-500 hover:text-brand-600 dark:border-slate-700 dark:text-slate-300"
											data-pk="{{ f.pk }}"
											data-name="{{ f.user.first_name }} {{ f.user.last_name }}"
											data-email="{{ f.user.email }}"
											data-phone="{{ f.phone }}"
											data-employee_id="{{ f.employee_id }}"
											data-department="{{ f.department }}"
											data-qualifications="{{ f.qualifications }}"
											data-status="{{ f.approval_status }}"
											data-avatar="{% if f.profile_pic %}{{ f.profile_pic.url }}{% else %}https://ui-avatars.com/api/?name={{ f.user.first_name|default:f.user.username }}&background=6366f1&color=fff{% endif %}">
											<i class="fas fa-eye mr-1"></i> View
										</button>
										<button class="btn-faculty-edit ml-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-amber-500 hover:text-amber-600 dark:border-slate-700 dark:text-slate-300"
											data-pk="{{ f.pk }}"
											data-first_name="{{ f.user.first_name }}"
											data-last_name="{{ f.user.last_name }}"
											data-email="{{ f.user.email }}"
											data-phone="{{ f.phone }}"
											data-employee_id="{{ f.employee_id }}"
											data-department="{{ f.department }}"
											data-qualifications="{{ f.qualifications }}">
											<i class="fas fa-pen mr-1"></i> Edit
										</button>
										<button class="btn-faculty-delete ml-2 rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600 hover:bg-rose-50 dark:border-rose-800/60"
											data-pk="{{ f.pk }}">
											<i class="fas fa-trash mr-1"></i> Delete
										</button>
										{% endif %}
									</td>
								</tr>
								{% empty %}
								<tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">No faculty members found.</td></tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</section>

				<!-- <section class="glass-card rounded-3xl border accent-border p-6 shadow-soft fade-in" style="animation-delay: 1s; background-image: linear-gradient(to bottom right, rgba(var(--accent-500-rgb),0.06), rgba(99,102,241,0));">
					<div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
						<div>
							<h3 class="text-lg font-bold text-slate-900 dark:text-white">Need deeper insights?</h3>
							<p class="text-sm accent-text-strong">Connect with CampusTrack AI Lab to tailor predictive analytics for your institution.</p>
						</div>
						<div class="flex flex-wrap gap-3">
							<button class="inline-flex items-center gap-2 rounded-full accent-gradient-r px-5 py-2 text-sm font-semibold text-white shadow-soft transition-all duration-300 hover:shadow-lg" data-ripple-light="true">
								Schedule demo <i class="fas fa-arrow-right text-xs"></i>
							</button>
							<button class="inline-flex items-center gap-2 rounded-full border accent-border px-5 py-2 text-sm font-semibold accent-text transition-all duration-300 hover:shadow-md" data-ripple-dark="true">
								Download brochure
							</button>
						</div>
					</div>
				</section>  -->
			</main>
		</div>
	</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	// Chart instances (singletons)
	let attendanceChartInstance = null;
	let pieChartInstance = null;
	let zoneChartInstance = null;

	// Sample weekly attendance percentages (Mon → Sun)
	const labels = ['Mon','Tue','Wed','Thu','Fri','Sat'];
	// Percent values (0-100)
	const dataValues = [92,90,88,93,91,87,];

	// Delay initialization until DOM is ready
	document.addEventListener('DOMContentLoaded', function () {
		const ctx = document.getElementById('attendanceChart');
		const pieCtx = document.getElementById('attendancePieChart');
        const zoneCtx = document.getElementById('zoneChart');

		const colors = [
			'rgba(124,58,237,0.95)',
			'rgba(139,92,246,0.85)',
			'rgba(99,102,241,0.85)',
			'rgba(59,130,246,0.9)',
			'rgba(249,115,22,0.9)',
			'rgba(139,92,246,0.8)'
		];

			if (ctx) {
				// destroy any chart already attached to this canvas (defensive)
				try {
					const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(ctx) : (Chart.helpers && Chart.helpers.getChart ? Chart.helpers.getChart(ctx) : null);
					if (existing) existing.destroy();
				} catch (e) { /* ignore */ }
				attendanceChartInstance = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'Attendance %',
						data: dataValues,
						backgroundColor: colors,
						borderRadius: 8,
						barPercentage: 0.7,
						categoryPercentage: 0.7,
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						y: {
							beginAtZero: true,
							min: 0,
							max: 100,
							ticks: { stepSize: 10, callback: function(value){ return value + '%'; } },
							title: { display: true, text: 'Attendance (%)', color: 'rgba(15,23,42,0.7)' },
							grid: { color: 'rgba(15,23,42,0.04)' }
						},
						x: {
							grid: { display: false },
							title: { display: true, text: 'Weekday', color: 'rgba(15,23,42,0.7)' }
						}
					},
					plugins: {
						legend: { display: false },
						tooltip: {
							backgroundColor: 'rgba(15,23,42,0.9)',
							titleColor: '#fff',
							bodyColor: '#fff',
							callbacks: {
								label: function(context){
									const v = context.parsed && context.parsed.y !== undefined ? context.parsed.y : context.parsed;
									return (context.dataset.label ? context.dataset.label + ': ' : '') + v + '%';
								}
							}
						}
					}
				}
			});
		}

			if (pieCtx) {
				try {
					const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(pieCtx) : (Chart.helpers && Chart.helpers.getChart ? Chart.helpers.getChart(pieCtx) : null);
					if (existing) existing.destroy();
				} catch(e) { /* ignore */ }
			// Example alert breakdown - these should come from your backend in production
			const alertLabels = ['Capacity','Attendance','Sync Issues'];
			const alertCounts = [2,3,1];
			const alertColors = ['rgba(249,115,22,0.95)','rgba(239,68,68,0.9)','rgba(59,130,246,0.9)'];

			pieChartInstance = new Chart(pieCtx, {
				type: 'doughnut',
				data: {
					labels: alertLabels,
					datasets: [{
						data: alertCounts,
						backgroundColor: alertColors,
						hoverOffset: 8,
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					cutout: '58%',
					plugins: {
						legend: {
							position: 'bottom',
							labels: { boxWidth: 10, padding: 8 }
						},
						tooltip: {
							backgroundColor: 'rgba(15,23,42,0.9)',
							titleColor: '#fff',
							bodyColor: '#fff'
						}
					}
				}
			});

			// Populate totals in the header pills
			const attendanceTotalEl = document.getElementById('attendanceTotal');
			const alertsTotalEl = document.getElementById('alertsTotal');
			if (attendanceTotalEl) attendanceTotalEl.textContent = dataValues.reduce((a,b)=>a+b,0);
			if (alertsTotalEl) alertsTotalEl.textContent = alertCounts.reduce((a,b)=>a+b,0);
		}

		// Zone chart (small horizontal bars)
			if (zoneCtx) {
				try {
					const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(zoneCtx) : (Chart.helpers && Chart.helpers.getChart ? Chart.helpers.getChart(zoneCtx) : null);
					if (existing) existing.destroy();
				} catch(e) { /* ignore */ }
			const zoneLabels = ['Main Quad','Lecture Halls','Cafeteria','Library'];
			const zoneValues = [68,83,55,40];
			zoneChartInstance = new Chart(zoneCtx, {
				type: 'bar',
				data: {
					labels: zoneLabels,
					datasets: [{
						label: 'Density %',
						data: zoneValues,
						backgroundColor: ['rgba(59,130,246,0.9)','rgba(239,68,68,0.9)','rgba(16,185,129,0.9)','rgba(99,102,241,0.85)'],
						borderRadius: 6,
						barPercentage: 0.9,
						categoryPercentage: 0.95
					}]
				},
				options: {
					indexAxis: 'y',
					responsive: true,
					maintainAspectRatio: false,
					scales: { x: { beginAtZero: true, max: 100, grid: { display: false } }, y: { grid: { display: false } } },
					plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15,23,42,0.9)', titleColor: '#fff', bodyColor: '#fff' } }
				}
			});
		}
	});

	// Student modal + line chart
	(function(){
		// Inject modal HTML at end of body
		const modalHtml = `
		<div id="studentModal" class="fixed inset-0 z-[999] hidden items-end md:items-center justify-center">
			<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
			<div class="relative w-full md:w-[720px] max-w-[92vw] rounded-3xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
				<header class="flex items-center justify-between px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
					<h4 class="text-lg font-bold text-slate-900 dark:text-white" id="smName">Student Report</h4>
					<button id="smClose" class="rounded-full border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-600 hover:border-brand-500 hover:text-brand-600 dark:border-slate-700 dark:text-slate-300"><i class='fas fa-times'></i></button>
				</header>
				<div class="p-5 space-y-5">
					<div class="flex items-center gap-3">
						<img id="smAvatar" class="h-12 w-12 rounded-full object-cover border-2 border-white shadow"/>
						<div>
							<p class="font-semibold text-slate-900 dark:text-white" id="smClass">—</p>
							<p class="text-xs text-slate-500" id="smId">—</p>
						</div>
					</div>
					<div class="grid gap-3 sm:grid-cols-3">
						<div class="rounded-2xl border border-slate-200/60 p-3 text-center dark:border-slate-800"><p class="text-xs text-slate-500">Attendance</p><p class="text-xl font-bold text-slate-900 dark:text-white" id="smRate">—%</p></div>
						<div class="rounded-2xl border border-slate-200/60 p-3 text-center dark:border-slate-800"><p class="text-xs text-slate-500">Present</p><p class="text-xl font-bold text-emerald-600" id="smPresent">—</p></div>
						<div class="rounded-2xl border border-slate-200/60 p-3 text-center dark:border-slate-800"><p class="text-xs text-slate-500">Absent</p><p class="text-xl font-bold text-rose-600" id="smAbsent">—</p></div>
					</div>
					<div class="rounded-2xl border border-slate-200/60 p-3 dark:border-slate-800">
						<canvas id="studentLineChart" class="h-52 w-full"></canvas>
					</div>
				</div>
			</div>
		</div>`;
		const body = document.body;
		body.insertAdjacentHTML('beforeend', modalHtml);

		const modal = document.getElementById('studentModal');
		const smClose = document.getElementById('smClose');
		function openModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
		function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
		smClose.addEventListener('click', closeModal);
		modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

		let lineChartInstance = null;
		function renderLine(labels, values){
			const ctx = document.getElementById('studentLineChart');
			if (!ctx) return;
			if (lineChartInstance) { lineChartInstance.destroy(); }
			lineChartInstance = new Chart(ctx, {
				type: 'line',
				data: { labels, datasets: [{ label: 'Weekly Attendance %', data: values, borderColor: 'rgba(99,102,241,1)', backgroundColor: 'rgba(99,102,241,0.12)', fill: true, tension: 0.35, pointRadius: 3 }] },
				options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15,23,42,0.9)', titleColor: '#fff', bodyColor: '#fff' } } }
			});
		}

		function setText(id, text){ const el = document.getElementById(id); if (el) el.textContent = text; }
		function setSrc(id, src){ const el = document.getElementById(id); if (el) el.src = src; }

		// Bind table action buttons
		document.querySelectorAll('.btn-view').forEach(btn=>{
			btn.addEventListener('click', ()=>{
				const name = btn.getAttribute('data-name');
				const id = btn.getAttribute('data-id');
				const klass = btn.getAttribute('data-class');
				const avatar = btn.getAttribute('data-avatar');
				const rate = btn.getAttribute('data-rate');
				const present = btn.getAttribute('data-present');
				const absent = btn.getAttribute('data-absent');
				const weeks = (btn.getAttribute('data-weeks')||'').split(',');
				const values = (btn.getAttribute('data-values')||'').split(',').map(v=>Number(v));

				setText('smName', name);
				setText('smClass', klass);
				setText('smId', `ID: ${id}`);
				setSrc('smAvatar', avatar);
				setText('smRate', rate ? `${rate}%` : '—%');
				setText('smPresent', present || '—');
				setText('smAbsent', absent || '—');
				renderLine(weeks, values);
				openModal();
			});
		});
	})();

			// Students search/filter (client-side)
				(function(){
					const searchInput = document.getElementById('studentSearch');
					if (!searchInput) return;
					const tbody = document.querySelector('#students table tbody');
					if (!tbody) return;
					// ensure there's a no-results row
					let noRow = tbody.querySelector('.no-results');
					if (!noRow){
						noRow = document.createElement('tr');
						noRow.className = 'no-results hidden';
						noRow.innerHTML = '<td colspan="5" class="px-4 py-6 text-center text-slate-500">No students match your search.</td>';
						tbody.appendChild(noRow);
					}

					function normalize(s){ return (s||'').toString().trim().toLowerCase(); }
					function runFilter(){
						const q = normalize(searchInput.value);
						const rows = Array.from(tbody.querySelectorAll('tr[data-row-pk]'));
						let visible = 0;
						rows.forEach(row=>{
							const name = normalize(row.querySelector('td:nth-child(1) p.font-semibold')?.textContent);
							const sid = normalize(row.querySelector('td:nth-child(2)')?.textContent);
							if (!q || name.includes(q) || sid.includes(q)){
								row.style.display = '';
								visible++;
							} else {
								row.style.display = 'none';
							}
						});
						if (visible === 0) noRow.classList.remove('hidden'); else noRow.classList.add('hidden');
					}

					let timer = null;
					['input','keyup'].forEach(ev=> searchInput.addEventListener(ev, ()=>{
						clearTimeout(timer);
						timer = setTimeout(runFilter, 100);
					}));
				})();

			// Theme customizer (no chart color changes)
		(function(){
			const THEME_KEY = 'campustrack_theme';
			const themeMap = {
				purple: {500:'#6366f1',600:'#4f46e5',700:'#4338ca'},
				blue:   {500:'#3b82f6',600:'#2563eb',700:'#1d4ed8'},
				green:  {500:'#10b981',600:'#059669',700:'#047857'},
				red:    {500:'#ef4444',600:'#dc2626',700:'#b91c1c'},
				violet: {500:'#8b5cf6',600:'#7c3aed',700:'#6d28d9'},
				grey:   {500:'#64748b',600:'#475569',700:'#334155'}
			};
			const updateVars = (c) => {
				const root = document.documentElement;
				root.style.setProperty('--accent-500', c[500]);
				root.style.setProperty('--accent-600', c[600]);
				root.style.setProperty('--accent-700', c[700]);
				const rgb = hexToRgb(c[500]);
				if (rgb) root.style.setProperty('--accent-500-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
			};
			const hexToRgb = (hex) => {
				const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
				return m ? { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) } : null;
			};
			const applyTheme = (name) => {
				const c = themeMap[name] || themeMap.purple;
				updateVars(c);
				const label = document.getElementById('currentTheme');
				if (label) label.textContent = name.charAt(0).toUpperCase()+name.slice(1);
				localStorage.setItem(THEME_KEY, name);
			};
			const init = () => {
				const saved = localStorage.getItem(THEME_KEY) || 'purple';
				applyTheme(saved);
				const container = document.getElementById('themeSwatches');
				if (container) {
					container.addEventListener('click', (e) => {
						const btn = e.target.closest('[data-theme]');
						if (!btn) return;
						const t = btn.getAttribute('data-theme');
						applyTheme(t);
					});
				}
			};
			document.addEventListener('DOMContentLoaded', init);
			// If script loads after DOMContentLoaded, run init immediately
			if (document.readyState === 'complete' || document.readyState === 'interactive') {
				init();
			}
		})();

	// Sidebar active tab handling with smooth scroll and smart padding
	(function(){
		function getAnchorForItem(item){
			if (!item) return null;
			if (item.tagName && item.tagName.toLowerCase() === 'a') return item;
			return item.querySelector('a[href]') || null;
		}

		function clearActive(){
			document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
		}

		function setActiveByHref(href){
			document.querySelectorAll('.nav-item').forEach(item=>{
				const a = getAnchorForItem(item);
				if (!a) return;
				if (a.getAttribute('href') === href) item.classList.add('active');
			});
		}

		function updateScrollPadding(){
			const header = document.querySelector('header');
			const root = document.documentElement;
			if (!header) return;
			const h = header.getBoundingClientRect().height + 12; // small gap
			root.style.setProperty('--scroll-padding', h + 'px');
		}

		function smoothScrollToHash(hash){
			if (!hash || hash === '#') return; // don't scroll for root
			const id = hash.replace(/^#/, '');
			const el = document.getElementById(id);
			if (!el) return;
			// compute the top position accounting for scroll-padding
			const padding = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--scroll-padding')) || 0;
			const rect = el.getBoundingClientRect();
			const offset = rect.top + window.pageYOffset - padding;
			window.scrollTo({ top: offset, behavior: 'smooth' });
		}

		// attach listeners
		document.querySelectorAll('.nav-item').forEach(item=>{
			const a = getAnchorForItem(item);
			if (!a) return;
			a.addEventListener('click', (e)=>{
				const href = a.getAttribute('href') || '#';
				// update url without triggering immediate jump
				if (href.startsWith('#')){
					e.preventDefault();
					// update history
					history.pushState(null, '', href);
					clearActive();
					item.classList.add('active');
					// smooth scroll
					smoothScrollToHash(href);
				}
			});
		});

		window.addEventListener('hashchange', function(){
			updateScrollPadding();
			clearActive();
			setActiveByHref(window.location.hash || '#');
			smoothScrollToHash(window.location.hash || '#');
		});

		// measure on load and resize
		window.addEventListener('resize', updateScrollPadding);
		updateScrollPadding();

		// initial activation based on current hash
		clearActive();
		setActiveByHref(window.location.hash || '#');
		// if we have a hash at load, jump smoothly to it
		if (window.location.hash){
			setTimeout(()=>{ smoothScrollToHash(window.location.hash); }, 60);
		}
	})();

	// Page loader fade-out
	(function(){
		const loader = document.getElementById('pageLoader');
		if (!loader) return;

		function hideLoader(){
			if (!loader) return;
			loader.classList.add('hidden');
			// remove after transition to keep DOM clean
			setTimeout(()=>{ loader.remove(); }, 700);
		}

		// Prefer window.load which waits for images/CSS
		window.addEventListener('load', ()=>{ setTimeout(hideLoader, 240); });

		// Safety fallback in case load is delayed
		setTimeout(()=>{ if (document.readyState === 'complete') hideLoader(); }, 2000);
	})();
</script>
<!-- CSRF helper + Edit/Delete modals and handlers -->
<script>
// CSRF helper
function getCookie(name){
		const value = `; ${document.cookie}`;
		const parts = value.split(`; ${name}=`);
		if (parts.length === 2) return parts.pop().split(';').shift();
}
function getCSRFToken(){
  return getCookie('csrftoken') || (document.querySelector('input[name=csrfmiddlewaretoken]') || {}).value;
}

// Back/Home button
(function(){
	const back = document.getElementById('backHomeBtn');
	if (!back) return;
	back.addEventListener('click', ()=>{ window.location.href = '/'; });
	// optional shortcut: Alt+H to go home
	document.addEventListener('keydown', (e)=>{ if (e.altKey && e.key.toLowerCase() === 'h') window.location.href = '/'; });
})();

// Inject Edit and Delete modals
(function(){
	const html = `
	<div id="editStudentModal" class="fixed inset-0 z-[1000] hidden items-end md:items-center justify-center">
		<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
		<div class="relative w-full md:w-[640px] max-w-[92vw] rounded-3xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
			<header class="flex items-center justify-between px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
				<h4 class="text-lg font-bold text-slate-900 dark:text-white">Edit Student</h4>
				<button data-close="edit" class="rounded-full border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-600 hover:border-amber-500 hover:text-amber-600 dark:border-slate-700 dark:text-slate-300"><i class='fas fa-times'></i></button>
			</header>
			<form id="editStudentForm" class="p-5 space-y-4" enctype="multipart/form-data">
				<input type="hidden" name="pk" id="editPk" />
				<div class="grid gap-4 sm:grid-cols-2">
					<div>
						<label class="text-xs text-slate-500">Name</label>
						<input id="editName" name="name" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" required />
					</div>
					<div>
						<label class="text-xs text-slate-500">Email</label>
						<input id="editEmail" name="email" type="email" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" required />
					</div>
					<div>
						<label class="text-xs text-slate-500">Phone</label>
						<input id="editPhone" name="phone" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div>
						<label class="text-xs text-slate-500">Student ID</label>
						<input id="editStudentId" name="student_id" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div>
						<label class="text-xs text-slate-500">Department</label>
						<input id="editDepartment" name="department" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div>
						<label class="text-xs text-slate-500">Avatar</label>
						<input id="editAvatar" name="avatar" type="file" accept="image/*" class="mt-1 w-full text-sm" />
					</div>
				</div>
				<div class="pt-3 flex justify-end gap-2">
					<button type="button" data-close="edit" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:text-slate-300">Cancel</button>
					<button type="submit" class="rounded-full accent-gradient-r px-4 py-2 text-xs font-semibold text-white shadow-soft">Save changes</button>
				</div>
				<p id="editError" class="text-xs text-rose-600 hidden"></p>
			</form>
		</div>
	</div>

	<div id="deleteConfirmModal" class="fixed inset-0 z-[1000] hidden items-end md:items-center justify-center">
		<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
		<div class="relative w-full md:w-[460px] max-w-[92vw] rounded-2xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
			<header class="px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
				<h4 class="text-base font-bold text-slate-900 dark:text-white">Delete Student</h4>
			</header>
			<div class="p-5">
				<p class="text-sm text-slate-600 dark:text-slate-300">Are you sure you want to delete this student? This action cannot be undone.</p>
				<div class="mt-5 flex justify-end gap-2">
					<button type="button" data-close="delete" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:text-slate-300">Cancel</button>
					<button id="confirmDeleteBtn" class="rounded-full bg-rose-600 px-4 py-2 text-xs font-semibold text-white">Delete</button>
				</div>
			</div>
		</div>
	</div>`;
	document.body.insertAdjacentHTML('beforeend', html);

	const editModal = document.getElementById('editStudentModal');
	const deleteModal = document.getElementById('deleteConfirmModal');
	function openModal(el){ el.classList.remove('hidden'); el.classList.add('flex'); }
	function closeModal(el){ el.classList.add('hidden'); el.classList.remove('flex'); }
	document.querySelectorAll('[data-close="edit"]').forEach(b=> b.addEventListener('click', ()=> closeModal(editModal)));
	document.querySelectorAll('[data-close="delete"]').forEach(b=> b.addEventListener('click', ()=> closeModal(deleteModal)));

	// Open Edit with data
	document.querySelectorAll('.btn-edit').forEach(btn => {
		btn.addEventListener('click', ()=>{
			const pk = btn.getAttribute('data-pk');
			document.getElementById('editPk').value = pk;
			document.getElementById('editName').value = btn.getAttribute('data-name') || '';
			document.getElementById('editEmail').value = btn.getAttribute('data-email') || '';
			document.getElementById('editPhone').value = btn.getAttribute('data-phone') || '';
			document.getElementById('editStudentId').value = btn.getAttribute('data-student_id') || '';
			document.getElementById('editDepartment').value = btn.getAttribute('data-department') || '';
			openModal(editModal);
		});
	});

	// Submit edit via fetch
	document.getElementById('editStudentForm').addEventListener('submit', async (e)=>{
		e.preventDefault();
		const form = e.currentTarget;
		const pk = document.getElementById('editPk').value;
		const url = `/students/${pk}/update/`;
		const fd = new FormData(form);
		fd.delete('pk');
		try {
			const res = await fetch(url, { method: 'POST', body: fd, headers: { 'X-CSRFToken': getCSRFToken() } });
			const data = await res.json();
			if (!res.ok) { throw data; }
			// Update row in table
			const row = document.querySelector(`tr[data-row-pk="${data.student.pk}"]`);
			if (row) {
				// Update name, department, id, avatar
				const nameEl = row.querySelector('td:nth-child(1) p.font-semibold');
				const deptEl = row.querySelector('td:nth-child(1) p.text-xs');
				const idEl = row.querySelector('td:nth-child(2)');
				const clsEl = row.querySelector('td:nth-child(3)');
				const avatarEl = row.querySelector('img');
				if (nameEl) nameEl.textContent = data.student.name;
				if (deptEl) deptEl.textContent = data.student.department || '—';
				if (idEl) idEl.textContent = data.student.student_id;
				if (clsEl) clsEl.textContent = data.student.department || '—';
				if (avatarEl && data.student.avatar_url) avatarEl.src = data.student.avatar_url;
				// Also update data-attrs on buttons
				const viewBtn = row.querySelector('.btn-view');
				const editBtn = row.querySelector('.btn-edit');
				if (viewBtn){
					viewBtn.setAttribute('data-name', data.student.name);
					viewBtn.setAttribute('data-id', data.student.student_id);
					viewBtn.setAttribute('data-class', data.student.department || '—');
					viewBtn.setAttribute('data-avatar', data.student.avatar_url || viewBtn.getAttribute('data-avatar'));
				}
				if (editBtn){
					editBtn.setAttribute('data-name', data.student.name);
					editBtn.setAttribute('data-email', data.student.email);
					editBtn.setAttribute('data-phone', data.student.phone || '');
					editBtn.setAttribute('data-student_id', data.student.student_id);
					editBtn.setAttribute('data-department', data.student.department || '');
					if (data.student.avatar_url) editBtn.setAttribute('data-avatar', data.student.avatar_url);
				}
			}
			closeModal(editModal);
		} catch(err){
			const errBox = document.getElementById('editError');
			errBox.classList.remove('hidden');
			if (err && err.errors){
				errBox.textContent = Object.entries(err.errors).map(([k,v])=>`${k}: ${v}`).join(' | ');
			} else {
				errBox.textContent = 'Failed to save changes.';
			}
		}
	});

	// Delete flow
	let deletePk = null;
	document.querySelectorAll('.btn-delete').forEach(btn => {
		btn.addEventListener('click', ()=>{
			deletePk = btn.getAttribute('data-pk');
			openModal(deleteModal);
		});
	});
	document.getElementById('confirmDeleteBtn').addEventListener('click', async ()=>{
		if (!deletePk) return;
		const url = `/students/${deletePk}/delete/`;
		try{
			const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCSRFToken() } });
			const data = await res.json();
			if (!res.ok) throw data;
			// remove row
			const row = document.querySelector(`tr[data-row-pk="${deletePk}"]`);
			if (row) row.remove();
			closeModal(deleteModal);
			deletePk = null;
		} catch(err){
			closeModal(deleteModal);
			deletePk = null;
			alert('Failed to delete student');
		}
	});
})();

// Faculty Modals and Handlers
(function(){
	// Inject Faculty Modals HTML at end of body
	const facultyModalsHtml = `
	<!-- Faculty View Modal -->
	<div id="facultyViewModal" class="fixed inset-0 z-[1000] hidden items-end md:items-center justify-center">
		<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
		<div class="relative w-full md:w-[640px] max-w-[92vw] rounded-3xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
			<header class="flex items-center justify-between px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
				<h4 class="text-lg font-bold text-slate-900 dark:text-white">Faculty Details</h4>
				<button data-close="faculty-view" class="rounded-full border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-600 hover:border-brand-500 hover:text-brand-600 dark:border-slate-700 dark:text-slate-300"><i class='fas fa-times'></i></button>
			</header>
			<div class="p-5 space-y-4">
				<div class="flex items-center gap-4">
					<img id="fvAvatar" class="h-16 w-16 rounded-full object-cover border-2 border-white shadow"/>
					<div>
						<p class="font-semibold text-lg text-slate-900 dark:text-white" id="fvName">—</p>
						<p class="text-sm text-slate-500" id="fvEmail">—</p>
						<span id="fvStatus" class="mt-1 inline-block rounded-full px-2.5 py-0.5 text-xs font-semibold">—</span>
					</div>
				</div>
				<div class="grid gap-3 sm:grid-cols-2 mt-4">
					<div class="rounded-2xl border border-slate-200/60 p-3 dark:border-slate-800">
						<p class="text-xs text-slate-500">Employee ID</p>
						<p class="text-sm font-semibold text-slate-900 dark:text-white" id="fvEmployeeId">—</p>
					</div>
					<div class="rounded-2xl border border-slate-200/60 p-3 dark:border-slate-800">
						<p class="text-xs text-slate-500">Department</p>
						<p class="text-sm font-semibold text-slate-900 dark:text-white" id="fvDepartment">—</p>
					</div>
					<div class="rounded-2xl border border-slate-200/60 p-3 dark:border-slate-800">
						<p class="text-xs text-slate-500">Phone</p>
						<p class="text-sm font-semibold text-slate-900 dark:text-white" id="fvPhone">—</p>
					</div>
					<div class="rounded-2xl border border-slate-200/60 p-3 dark:border-slate-800 sm:col-span-2">
						<p class="text-xs text-slate-500">Qualifications</p>
						<p class="text-sm font-semibold text-slate-900 dark:text-white" id="fvQualifications">—</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Faculty Edit Modal -->
	<div id="facultyEditModal" class="fixed inset-0 z-[1000] hidden items-end md:items-center justify-center">
		<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
		<div class="relative w-full md:w-[640px] max-w-[92vw] rounded-3xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
			<header class="flex items-center justify-between px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
				<h4 class="text-lg font-bold text-slate-900 dark:text-white">Edit Faculty</h4>
				<button data-close="faculty-edit" class="rounded-full border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-600 hover:border-amber-500 hover:text-amber-600 dark:border-slate-700 dark:text-slate-300"><i class='fas fa-times'></i></button>
			</header>
			<form id="editFacultyForm" class="p-5 space-y-4">
				<input type="hidden" name="pk" id="editFacultyPk" />
				<div class="grid gap-4 sm:grid-cols-2">
					<div>
						<label class="text-xs text-slate-500">First Name</label>
						<input id="editFacultyFirstName" name="first_name" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" required />
					</div>
					<div>
						<label class="text-xs text-slate-500">Last Name</label>
						<input id="editFacultyLastName" name="last_name" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div>
						<label class="text-xs text-slate-500">Email</label>
						<input id="editFacultyEmail" name="email" type="email" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" required />
					</div>
					<div>
						<label class="text-xs text-slate-500">Phone</label>
						<input id="editFacultyPhone" name="phone" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div>
						<label class="text-xs text-slate-500">Employee ID</label>
						<input id="editFacultyEmployeeId" name="employee_id" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div>
						<label class="text-xs text-slate-500">Department</label>
						<input id="editFacultyDepartment" name="department" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" />
					</div>
					<div class="sm:col-span-2">
						<label class="text-xs text-slate-500">Qualifications</label>
						<textarea id="editFacultyQualifications" name="qualifications" rows="2" class="mt-1 w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900"></textarea>
					</div>
				</div>
				<div class="pt-3 flex justify-end gap-2">
					<button type="button" data-close="faculty-edit" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:text-slate-300">Cancel</button>
					<button type="submit" class="rounded-full accent-gradient-r px-4 py-2 text-xs font-semibold text-white shadow-soft">Save changes</button>
				</div>
				<p id="editFacultyError" class="text-xs text-rose-600 hidden"></p>
			</form>
		</div>
	</div>

	<!-- Faculty Delete Modal -->
	<div id="facultyDeleteModal" class="fixed inset-0 z-[1000] hidden items-end md:items-center justify-center">
		<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
		<div class="relative w-full md:w-[460px] max-w-[92vw] rounded-2xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
			<header class="px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
				<h4 class="text-base font-bold text-slate-900 dark:text-white">Delete Faculty</h4>
			</header>
			<div class="p-5">
				<p class="text-sm text-slate-600 dark:text-slate-300">Are you sure you want to delete this faculty member? This action cannot be undone.</p>
				<div class="mt-5 flex justify-end gap-2">
					<button type="button" data-close="faculty-delete" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:text-slate-300">Cancel</button>
					<button id="confirmFacultyDeleteBtn" class="rounded-full bg-rose-600 px-4 py-2 text-xs font-semibold text-white">Delete</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Faculty Reject Modal (with reason) -->
	<div id="facultyRejectModal" class="fixed inset-0 z-[1000] hidden items-end md:items-center justify-center">
		<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
		<div class="relative w-full md:w-[460px] max-w-[92vw] rounded-2xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl">
			<header class="px-5 py-4 border-b border-slate-200/60 dark:border-slate-800">
				<h4 class="text-base font-bold text-slate-900 dark:text-white">Reject Faculty</h4>
			</header>
			<div class="p-5">
				<p class="text-sm text-slate-600 dark:text-slate-300 mb-3">Please provide a reason for rejection (optional):</p>
				<textarea id="rejectFacultyReason" rows="3" class="w-full rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-sm dark:border-slate-700 dark:bg-slate-900" placeholder="Enter rejection reason..."></textarea>
				<div class="mt-5 flex justify-end gap-2">
					<button type="button" data-close="faculty-reject" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 dark:border-slate-700 dark:text-slate-300">Cancel</button>
					<button id="confirmFacultyRejectBtn" class="rounded-full bg-rose-600 px-4 py-2 text-xs font-semibold text-white">Reject</button>
				</div>
			</div>
		</div>
	</div>`;
	document.body.insertAdjacentHTML('beforeend', facultyModalsHtml);

	// Modal helpers
	const fViewModal = document.getElementById('facultyViewModal');
	const fEditModal = document.getElementById('facultyEditModal');
	const fDeleteModal = document.getElementById('facultyDeleteModal');
	const fRejectModal = document.getElementById('facultyRejectModal');

	function openFacultyModal(el){ el.classList.remove('hidden'); el.classList.add('flex'); }
	function closeFacultyModal(el){ el.classList.add('hidden'); el.classList.remove('flex'); }

	document.querySelectorAll('[data-close="faculty-view"]').forEach(b=> b.addEventListener('click', ()=> closeFacultyModal(fViewModal)));
	document.querySelectorAll('[data-close="faculty-edit"]').forEach(b=> b.addEventListener('click', ()=> closeFacultyModal(fEditModal)));
	document.querySelectorAll('[data-close="faculty-delete"]').forEach(b=> b.addEventListener('click', ()=> closeFacultyModal(fDeleteModal)));
	document.querySelectorAll('[data-close="faculty-reject"]').forEach(b=> b.addEventListener('click', ()=> closeFacultyModal(fRejectModal)));

	// View Faculty
	document.querySelectorAll('.btn-faculty-view').forEach(btn => {
		btn.addEventListener('click', ()=>{
			document.getElementById('fvName').textContent = btn.getAttribute('data-name') || '—';
			document.getElementById('fvEmail').textContent = btn.getAttribute('data-email') || '—';
			document.getElementById('fvPhone').textContent = btn.getAttribute('data-phone') || '—';
			document.getElementById('fvEmployeeId').textContent = btn.getAttribute('data-employee_id') || '—';
			document.getElementById('fvDepartment').textContent = btn.getAttribute('data-department') || '—';
			document.getElementById('fvQualifications').textContent = btn.getAttribute('data-qualifications') || '—';
			document.getElementById('fvAvatar').src = btn.getAttribute('data-avatar') || '';
			
			const status = btn.getAttribute('data-status');
			const statusEl = document.getElementById('fvStatus');
			statusEl.textContent = status || '—';
			if (status === 'Approved') {
				statusEl.className = 'mt-1 inline-block rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-semibold text-emerald-600';
			} else if (status === 'Rejected') {
				statusEl.className = 'mt-1 inline-block rounded-full bg-rose-100 px-2.5 py-0.5 text-xs font-semibold text-rose-600';
			} else {
				statusEl.className = 'mt-1 inline-block rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-semibold text-amber-600';
			}
			
			openFacultyModal(fViewModal);
		});
	});

	// Edit Faculty - Open modal
	document.querySelectorAll('.btn-faculty-edit').forEach(btn => {
		btn.addEventListener('click', ()=>{
			document.getElementById('editFacultyPk').value = btn.getAttribute('data-pk');
			document.getElementById('editFacultyFirstName').value = btn.getAttribute('data-first_name') || '';
			document.getElementById('editFacultyLastName').value = btn.getAttribute('data-last_name') || '';
			document.getElementById('editFacultyEmail').value = btn.getAttribute('data-email') || '';
			document.getElementById('editFacultyPhone').value = btn.getAttribute('data-phone') || '';
			document.getElementById('editFacultyEmployeeId').value = btn.getAttribute('data-employee_id') || '';
			document.getElementById('editFacultyDepartment').value = btn.getAttribute('data-department') || '';
			document.getElementById('editFacultyQualifications').value = btn.getAttribute('data-qualifications') || '';
			document.getElementById('editFacultyError').classList.add('hidden');
			openFacultyModal(fEditModal);
		});
	});

	// Edit Faculty - Submit form
	document.getElementById('editFacultyForm').addEventListener('submit', async (e)=>{
		e.preventDefault();
		const pk = document.getElementById('editFacultyPk').value;
		const url = '/api/faculty/' + pk + '/update/';
		const payload = {
			first_name: document.getElementById('editFacultyFirstName').value,
			last_name: document.getElementById('editFacultyLastName').value,
			email: document.getElementById('editFacultyEmail').value,
			phone: document.getElementById('editFacultyPhone').value,
			employee_id: document.getElementById('editFacultyEmployeeId').value,
			department: document.getElementById('editFacultyDepartment').value,
			qualifications: document.getElementById('editFacultyQualifications').value,
		};
		try {
			const res = await fetch(url, {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
				body: JSON.stringify(payload)
			});
			const data = await res.json();
			if (!res.ok) throw data;
			
			// Update the row in the table
			const row = document.querySelector('tr[data-faculty-pk="' + pk + '"]');
			if (row) {
				const nameEl = row.querySelector('td:nth-child(1) p.font-semibold');
				const emailEl = row.querySelector('td:nth-child(1) p.text-xs');
				const idEl = row.querySelector('td:nth-child(2)');
				const deptEl = row.querySelector('td:nth-child(3)');
				if (nameEl) nameEl.textContent = data.faculty.name;
				if (emailEl) emailEl.textContent = data.faculty.email || '—';
				if (idEl) idEl.textContent = data.faculty.employee_id;
				if (deptEl) deptEl.textContent = data.faculty.department || '—';
				
				// Update data attributes on buttons
				const viewBtn = row.querySelector('.btn-faculty-view');
				const editBtn = row.querySelector('.btn-faculty-edit');
				if (viewBtn) {
					viewBtn.setAttribute('data-name', data.faculty.name);
					viewBtn.setAttribute('data-email', data.faculty.email);
					viewBtn.setAttribute('data-phone', data.faculty.phone || '');
					viewBtn.setAttribute('data-employee_id', data.faculty.employee_id);
					viewBtn.setAttribute('data-department', data.faculty.department || '');
					viewBtn.setAttribute('data-qualifications', data.faculty.qualifications || '');
				}
				if (editBtn) {
					editBtn.setAttribute('data-first_name', data.faculty.first_name);
					editBtn.setAttribute('data-last_name', data.faculty.last_name);
					editBtn.setAttribute('data-email', data.faculty.email);
					editBtn.setAttribute('data-phone', data.faculty.phone || '');
					editBtn.setAttribute('data-employee_id', data.faculty.employee_id);
					editBtn.setAttribute('data-department', data.faculty.department || '');
					editBtn.setAttribute('data-qualifications', data.faculty.qualifications || '');
				}
			}
			closeFacultyModal(fEditModal);
		} catch(err) {
			const errBox = document.getElementById('editFacultyError');
			errBox.classList.remove('hidden');
			errBox.textContent = err.error || 'Failed to save changes.';
		}
	});

	// Delete Faculty
	let deleteFacultyPk = null;
	document.querySelectorAll('.btn-faculty-delete').forEach(btn => {
		btn.addEventListener('click', ()=>{
			deleteFacultyPk = btn.getAttribute('data-pk');
			openFacultyModal(fDeleteModal);
		});
	});
	document.getElementById('confirmFacultyDeleteBtn').addEventListener('click', async ()=>{
		if (!deleteFacultyPk) return;
		const url = '/api/faculty/' + deleteFacultyPk + '/delete/';
		try {
			const res = await fetch(url, { method: 'DELETE', headers: { 'X-CSRFToken': getCSRFToken() } });
			const data = await res.json();
			if (!res.ok) throw data;
			// Remove row from table
			const row = document.querySelector('tr[data-faculty-pk="' + deleteFacultyPk + '"]');
			if (row) row.remove();
			closeFacultyModal(fDeleteModal);
			deleteFacultyPk = null;
		} catch(err) {
			closeFacultyModal(fDeleteModal);
			deleteFacultyPk = null;
			alert('Failed to delete faculty');
		}
	});

	// Approve Faculty
	document.querySelectorAll('.btn-faculty-approve').forEach(btn => {
		btn.addEventListener('click', async ()=>{
			const pk = btn.getAttribute('data-pk');
			const url = '/api/faculty/approve/' + pk + '/';
			try {
				const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCSRFToken() } });
				const data = await res.json();
				if (!res.ok) throw data;
				// Update the row: change status badge and swap buttons
				const row = document.querySelector('tr[data-faculty-pk="' + pk + '"]');
				if (row) {
					row.setAttribute('data-status', 'Approved');
					// Update status badge
					const statusCell = row.querySelector('td:nth-child(4)');
					if (statusCell) {
						statusCell.innerHTML = '<span class="rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-semibold text-emerald-600">Approved</span>';
					}
					// Get faculty info from row for new buttons
					const nameEl = row.querySelector('td:nth-child(1) p.font-semibold');
					const emailEl = row.querySelector('td:nth-child(1) p.text-xs');
					const idEl = row.querySelector('td:nth-child(2)');
					const deptEl = row.querySelector('td:nth-child(3)');
					const avatarEl = row.querySelector('td:nth-child(1) img');
					
					// Replace action buttons
					const actionsCell = row.querySelector('td:nth-child(5)');
					if (actionsCell) {
						actionsCell.innerHTML = 
							'<button class="btn-faculty-view rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-brand-500 hover:text-brand-600 dark:border-slate-700 dark:text-slate-300" ' +
							'data-pk="' + pk + '" ' +
							'data-name="' + (nameEl ? nameEl.textContent : '') + '" ' +
							'data-email="' + (emailEl ? emailEl.textContent : '') + '" ' +
							'data-employee_id="' + (idEl ? idEl.textContent : '') + '" ' +
							'data-department="' + (deptEl ? deptEl.textContent : '') + '" ' +
							'data-status="Approved" ' +
							'data-avatar="' + (avatarEl ? avatarEl.src : '') + '">' +
							'<i class="fas fa-eye mr-1"></i> View</button>' +
							'<button class="btn-faculty-edit ml-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-amber-500 hover:text-amber-600 dark:border-slate-700 dark:text-slate-300" ' +
							'data-pk="' + pk + '">' +
							'<i class="fas fa-pen mr-1"></i> Edit</button>' +
							'<button class="btn-faculty-delete ml-2 rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600 hover:bg-rose-50 dark:border-rose-800/60" ' +
							'data-pk="' + pk + '">' +
							'<i class="fas fa-trash mr-1"></i> Delete</button>';
						// Re-bind event listeners for new buttons
						bindFacultyButtons(row);
					}
				}
			} catch(err) {
				alert('Failed to approve faculty: ' + (err.error || 'Unknown error'));
			}
		});
	});

	// Reject Faculty - Open modal
	let rejectFacultyPk = null;
	document.querySelectorAll('.btn-faculty-reject').forEach(btn => {
		btn.addEventListener('click', ()=>{
			rejectFacultyPk = btn.getAttribute('data-pk');
			document.getElementById('rejectFacultyReason').value = '';
			openFacultyModal(fRejectModal);
		});
	});
	document.getElementById('confirmFacultyRejectBtn').addEventListener('click', async ()=>{
		if (!rejectFacultyPk) return;
		const reason = document.getElementById('rejectFacultyReason').value;
		const url = '/api/faculty/reject/' + rejectFacultyPk + '/';
		try {
			const res = await fetch(url, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
				body: JSON.stringify({ reason: reason })
			});
			const data = await res.json();
			if (!res.ok) throw data;
			// Update the row
			const row = document.querySelector('tr[data-faculty-pk="' + rejectFacultyPk + '"]');
			if (row) {
				row.setAttribute('data-status', 'Rejected');
				// Update status badge
				const statusCell = row.querySelector('td:nth-child(4)');
				if (statusCell) {
					statusCell.innerHTML = '<span class="rounded-full bg-rose-100 px-2.5 py-0.5 text-xs font-semibold text-rose-600">Rejected</span>';
				}
				// Get faculty info for new buttons
				const nameEl = row.querySelector('td:nth-child(1) p.font-semibold');
				const emailEl = row.querySelector('td:nth-child(1) p.text-xs');
				const idEl = row.querySelector('td:nth-child(2)');
				const deptEl = row.querySelector('td:nth-child(3)');
				const avatarEl = row.querySelector('td:nth-child(1) img');
				
				// Replace action buttons
				const actionsCell = row.querySelector('td:nth-child(5)');
				if (actionsCell) {
					actionsCell.innerHTML = 
						'<button class="btn-faculty-view rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-brand-500 hover:text-brand-600 dark:border-slate-700 dark:text-slate-300" ' +
						'data-pk="' + rejectFacultyPk + '" ' +
						'data-name="' + (nameEl ? nameEl.textContent : '') + '" ' +
						'data-email="' + (emailEl ? emailEl.textContent : '') + '" ' +
						'data-employee_id="' + (idEl ? idEl.textContent : '') + '" ' +
						'data-department="' + (deptEl ? deptEl.textContent : '') + '" ' +
						'data-status="Rejected" ' +
						'data-avatar="' + (avatarEl ? avatarEl.src : '') + '">' +
						'<i class="fas fa-eye mr-1"></i> View</button>' +
						'<button class="btn-faculty-edit ml-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-amber-500 hover:text-amber-600 dark:border-slate-700 dark:text-slate-300" ' +
						'data-pk="' + rejectFacultyPk + '">' +
						'<i class="fas fa-pen mr-1"></i> Edit</button>' +
						'<button class="btn-faculty-delete ml-2 rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-600 hover:bg-rose-50 dark:border-rose-800/60" ' +
						'data-pk="' + rejectFacultyPk + '">' +
						'<i class="fas fa-trash mr-1"></i> Delete</button>';
					// Re-bind event listeners
					bindFacultyButtons(row);
				}
			}
			closeFacultyModal(fRejectModal);
			rejectFacultyPk = null;
		} catch(err) {
			alert('Failed to reject faculty: ' + (err.error || 'Unknown error'));
		}
	});

	// Helper to rebind event listeners for dynamically created buttons
	function bindFacultyButtons(row) {
		const viewBtn = row.querySelector('.btn-faculty-view');
		const editBtn = row.querySelector('.btn-faculty-edit');
		const deleteBtn = row.querySelector('.btn-faculty-delete');
		
		if (viewBtn) {
			viewBtn.addEventListener('click', ()=>{
				document.getElementById('fvName').textContent = viewBtn.getAttribute('data-name') || '—';
				document.getElementById('fvEmail').textContent = viewBtn.getAttribute('data-email') || '—';
				document.getElementById('fvPhone').textContent = viewBtn.getAttribute('data-phone') || '—';
				document.getElementById('fvEmployeeId').textContent = viewBtn.getAttribute('data-employee_id') || '—';
				document.getElementById('fvDepartment').textContent = viewBtn.getAttribute('data-department') || '—';
				document.getElementById('fvQualifications').textContent = viewBtn.getAttribute('data-qualifications') || '—';
				document.getElementById('fvAvatar').src = viewBtn.getAttribute('data-avatar') || '';
				const status = viewBtn.getAttribute('data-status');
				const statusEl = document.getElementById('fvStatus');
				statusEl.textContent = status || '—';
				if (status === 'Approved') {
					statusEl.className = 'mt-1 inline-block rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-semibold text-emerald-600';
				} else if (status === 'Rejected') {
					statusEl.className = 'mt-1 inline-block rounded-full bg-rose-100 px-2.5 py-0.5 text-xs font-semibold text-rose-600';
				} else {
					statusEl.className = 'mt-1 inline-block rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-semibold text-amber-600';
				}
				openFacultyModal(fViewModal);
			});
		}
		
		if (editBtn) {
			editBtn.addEventListener('click', ()=>{
				document.getElementById('editFacultyPk').value = editBtn.getAttribute('data-pk');
				document.getElementById('editFacultyFirstName').value = editBtn.getAttribute('data-first_name') || '';
				document.getElementById('editFacultyLastName').value = editBtn.getAttribute('data-last_name') || '';
				document.getElementById('editFacultyEmail').value = editBtn.getAttribute('data-email') || '';
				document.getElementById('editFacultyPhone').value = editBtn.getAttribute('data-phone') || '';
				document.getElementById('editFacultyEmployeeId').value = editBtn.getAttribute('data-employee_id') || '';
				document.getElementById('editFacultyDepartment').value = editBtn.getAttribute('data-department') || '';
				document.getElementById('editFacultyQualifications').value = editBtn.getAttribute('data-qualifications') || '';
				document.getElementById('editFacultyError').classList.add('hidden');
				openFacultyModal(fEditModal);
			});
		}
		
		if (deleteBtn) {
			deleteBtn.addEventListener('click', ()=>{
				deleteFacultyPk = deleteBtn.getAttribute('data-pk');
				openFacultyModal(fDeleteModal);
			});
		}
	}

	// Faculty search/filter (client-side)
	const facultySearchInput = document.getElementById('facultySearch');
	if (facultySearchInput) {
		const tbody = document.querySelector('#faculty table tbody');
		if (tbody) {
			let noRow = tbody.querySelector('.no-results-faculty');
			if (!noRow) {
				noRow = document.createElement('tr');
				noRow.className = 'no-results-faculty hidden';
				noRow.innerHTML = '<td colspan="5" class="px-4 py-6 text-center text-slate-500">No faculty match your search.</td>';
				tbody.appendChild(noRow);
			}

			function normalize(s){ return (s||'').toString().trim().toLowerCase(); }
			function runFacultyFilter(){
				const q = normalize(facultySearchInput.value);
				const rows = Array.from(tbody.querySelectorAll('tr[data-faculty-pk]'));
				let visible = 0;
				rows.forEach(row=>{
					const name = normalize(row.querySelector('td:nth-child(1) p.font-semibold')?.textContent);
					const empId = normalize(row.querySelector('td:nth-child(2)')?.textContent);
					if (!q || name.includes(q) || empId.includes(q)){
						row.style.display = '';
						visible++;
					} else {
						row.style.display = 'none';
					}
				});
				if (visible === 0) noRow.classList.remove('hidden'); else noRow.classList.add('hidden');
			}

			let timer = null;
			['input','keyup'].forEach(ev=> facultySearchInput.addEventListener(ev, ()=>{
				clearTimeout(timer);
				timer = setTimeout(runFacultyFilter, 100);
			}));
		}
	}
})();

// Live Dashboard Updates
(function() {

	async function updateDashboard() {
		try {
			const response = await fetch('/api/face-dashboard/stats/', {
				credentials: 'include'
			});
			const data = await response.json();

		// Update stats cards
		document.getElementById('attendanceRate').textContent = `${data.attendance_rate}%`;
		document.getElementById('todayAttendance').textContent = data.today_attendance;
		document.getElementById('classesInSession').textContent = data.classes_in_session;
		document.getElementById('punctualityRate').textContent = `${data.punctuality}%`;
		document.getElementById('onTimeCount').textContent = data.on_time_count;
		document.getElementById('unknownCount').textContent = data.unknown_count;

		// Update progress bars with animation
		const attendanceProgress = document.getElementById('attendanceProgress');
		if (attendanceProgress) {
			setTimeout(() => {
				attendanceProgress.style.width = `${data.attendance_rate}%`;
			}, 100);
		}
		
		const punctualityProgress = document.getElementById('punctualityProgress');
		if (punctualityProgress) {
			setTimeout(() => {
				punctualityProgress.style.width = `${data.punctuality}%`;
			}, 200);
		}

		// Show/hide unknown faces badge
		const unknownBadge = document.getElementById('unknownBadge');
		if (unknownBadge && data.unknown_count > 0) {
			unknownBadge.style.display = 'inline-flex';
		} else if (unknownBadge) {
			unknownBadge.style.display = 'none';
		}

		// Update hero stats
		const heroToday = document.getElementById('heroTodayAttendance');
		if (heroToday) heroToday.textContent = data.today_attendance;
		const heroRate = document.getElementById('heroAttendanceRate');
		if (heroRate) heroRate.textContent = `${data.attendance_rate}%`;
		const heroClasses = document.getElementById('heroClasses');
		if (heroClasses) heroClasses.textContent = data.classes_in_session;
		const heroUnknown = document.getElementById('heroUnknownFaces');
		if (heroUnknown) heroUnknown.textContent = data.unknown_count;
		const heroPunctuality = document.getElementById('heroPunctuality');
		if (heroPunctuality) heroPunctuality.textContent = `${data.punctuality}%`;

		// Update weekly attendance chart
		updateAttendanceChart(data.weekly_data);			// Update pie chart
			updatePieChart(data.on_time_count, data.late_count);

			// Update top classes
			updateTopClasses(data.top_classes);

			// Update class history cards
			updateClassHistoryCards();

			// Update live classroom status
			updateLiveClassrooms(data.live_classes);

			// Update recent check-ins
			updateRecentCheckins();

			// Update crowd report
			updateCrowdReport();

		} catch (error) {
			console.error('Dashboard update error:', error);
		}
	}

	function updateAttendanceChart(weeklyData) {
		const ctx = document.getElementById('attendanceChart');
		if (!ctx) return;

		const labels = weeklyData.map(d => d.date);
		const values = weeklyData.map(d => d.count);

		// Always destroy the old chart if it exists
		if (attendanceChartInstance) {
			attendanceChartInstance.destroy();
		} else {
			// Defensive: if instance var isn't set, check Chart registry for an existing chart attached to this canvas
			try {
				const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(ctx) : (Chart.helpers && Chart.helpers.getChart ? Chart.helpers.getChart(ctx) : null);
				if (existing) existing.destroy();
			} catch (e) { /* ignore */ }
		}

		// Create fresh chart instance
		attendanceChartInstance = new Chart(ctx, {
			type: 'bar',
			data: {
				labels: labels,
				datasets: [{
					label: 'Daily Attendance',
					data: values,
					backgroundColor: [
						'rgba(99,102,241,0.8)',
						'rgba(99,102,241,0.85)',
						'rgba(99,102,241,0.9)',
						'rgba(99,102,241,0.95)',
						'rgba(99,102,241,1)',
						'rgba(99,102,241,0.92)',
						'rgba(99,102,241,0.87)'
					],
					borderColor: 'rgba(99,102,241,1)',
					borderWidth: 2,
					borderRadius: 8,
					borderSkipped: false,
					hoverBackgroundColor: 'rgba(79, 70, 229, 1)',
					hoverBorderColor: 'rgba(55, 56, 202, 1)',
					hoverBorderWidth: 3
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				animation: {
					duration: 300
				},
				plugins: {
					legend: { display: false },
					tooltip: {
						backgroundColor: 'rgba(15,23,42,0.9)',
						padding: 12,
						titleColor: '#fff',
						bodyColor: '#fff',
						borderColor: 'rgba(99,102,241,0.3)',
						borderWidth: 1,
						cornerRadius: 6,
						displayColors: false
					}
				},
				scales: {
					y: {
						beginAtZero: true,
						ticks: {
							stepSize: 1
						},
						grid: { color: 'rgba(148,163,184,0.1)', drawBorder: false }
					},
					x: {
						grid: { display: false, drawBorder: false },
						ticks: { color: 'rgba(71,85,105,0.6)' }
					}
				}
			}
		});
		
		// Update statistics
		updateAttendanceStats(weeklyData);
	}

	function updateAttendanceStats(weeklyData) {
		if (!weeklyData || weeklyData.length === 0) return;

		const counts = weeklyData.map(d => d.count);
		const dates = weeklyData.map(d => d.date);

		// Calculate average
		const average = Math.round(counts.reduce((a, b) => a + b, 0) / counts.length);
		document.getElementById('weeklyAverage').textContent = average;

		// Find peak day
		const maxCount = Math.max(...counts);
		const maxIndex = counts.indexOf(maxCount);
		document.getElementById('peakDay').textContent = dates[maxIndex];
		document.getElementById('peakDayCount').textContent = maxCount + ' students';

		// Find lowest day
		const minCount = Math.min(...counts);
		const minIndex = counts.indexOf(minCount);
		document.getElementById('lowestDay').textContent = dates[minIndex];
		document.getElementById('lowestDayCount').textContent = minCount + ' students';

		// Calculate trend (first 3 days vs last 3 days) with safe divide-by-zero handling
		const firstThree = counts.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
		const lastThree = counts.slice(-3).reduce((a, b) => a + b, 0) / 3;
		let trendChange = 0;
		if (firstThree === 0) {
			// If there was no activity in the earlier period but some now, treat as 100% increase; otherwise 0
			trendChange = lastThree === 0 ? 0 : 100;
		} else {
			trendChange = Math.round((lastThree - firstThree) / firstThree * 100);
		}
		
		const trendElement = document.getElementById('trendPercent');
		const trendLabel = document.getElementById('trendLabel');
		
		if (trendChange > 0) {
			trendElement.textContent = '+' + trendChange + '%';
			trendElement.parentElement.style.color = 'rgb(34, 197, 94)';
			trendLabel.textContent = 'Increasing';
		} else if (trendChange < 0) {
			trendElement.textContent = trendChange + '%';
			trendElement.parentElement.style.color = 'rgb(239, 68, 68)';
			trendLabel.textContent = 'Decreasing';
		} else {
			trendElement.textContent = '0%';
			trendLabel.textContent = 'Stable';
		}
	}

	function updatePieChart(onTime, late) {
		const pieCtx = document.getElementById('attendancePieChart');
		if (!pieCtx) return;

		// Always destroy the old chart if it exists
		if (pieChartInstance) {
			pieChartInstance.destroy();
		}
		else {
			try {
				const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(pieCtx) : (Chart.helpers && Chart.helpers.getChart ? Chart.helpers.getChart(pieCtx) : null);
				if (existing) existing.destroy();
			} catch(e) { /* ignore */ }
		}

		// Create fresh chart instance
		pieChartInstance = new Chart(pieCtx, {
			type: 'doughnut',
			data: {
				labels: ['On-Time', 'Late'],
				datasets: [{
					data: [onTime, late],
					backgroundColor: ['rgba(16,185,129,0.8)', 'rgba(251,146,60,0.8)'],
					borderWidth: 2,
					borderColor: '#fff'
				}]
			},
			options: {
				responsive: true,
				animation: {
					duration: 300
				},
				plugins: {
					legend: {
						position: 'bottom',
						labels: { padding: 15, font: { size: 11 } }
					},
					tooltip: {
						backgroundColor: 'rgba(15,23,42,0.9)',
						padding: 12
					}
				}
			}
		});
	}

	async function updateClassHistoryCards() {
		const container = document.getElementById('classHistoryCards');
		if (!container) return;

		try {
			const response = await fetch('/api/class-history/', {
				method: 'GET',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json'
				}
			});
			if (!response.ok) throw new Error(`API error: ${response.status}`);
			
			const data = await response.json();
			console.log('Class history data:', data);

			if (!data.classes || Object.keys(data.classes).length === 0) {
				container.innerHTML = `
					<div class="flex items-center justify-center py-6 text-slate-400 col-span-2">
						<i class="fas fa-inbox mr-2"></i> No history data
					</div>
				`;
				return;
			}

			const cardsHTML = Object.entries(data.classes).map(([className, classData]) => {
				const onTimePercent = Math.round(classData.on_time_percentage || 0);
				const statusColor = onTimePercent >= 80 ? 'emerald' : onTimePercent >= 60 ? 'amber' : 'rose';
				const statusBg = {
					emerald: 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800',
					amber: 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800',
					rose: 'bg-rose-50 dark:bg-rose-900/20 border-rose-200 dark:border-rose-800'
				}[statusColor];

				const statusText = {
					emerald: 'text-emerald-700 dark:text-emerald-400',
					amber: 'text-amber-700 dark:text-amber-400',
					rose: 'text-rose-700 dark:text-rose-400'
				}[statusColor];

				return `
					<div class="rounded-xl border ${statusBg} p-3 cursor-pointer hover:shadow-md transition" onclick="showClassHistory('${className}')">
						<div class="flex items-start justify-between mb-2">
							<h4 class="font-bold text-slate-900 dark:text-white text-sm">${className}</h4>
							<span class="text-xs font-semibold ${statusText}">${onTimePercent}%</span>
						</div>
						<div class="space-y-1 text-xs">
							<p class="text-slate-600 dark:text-slate-400"><i class="fas fa-users mr-1"></i> ${classData.unique_students} students</p>
							<p class="text-slate-600 dark:text-slate-400"><i class="fas fa-check-circle mr-1 text-emerald-600"></i> ${classData.total_on_time} on-time</p>
							<p class="text-slate-600 dark:text-slate-400"><i class="fas fa-clock mr-1 text-amber-600"></i> ${classData.total_late} late</p>
						</div>
					</div>
				`;
			}).join('');
			
			container.innerHTML = cardsHTML;
		} catch (error) {
			console.error('Error loading history cards:', error);
			container.innerHTML = `
				<div class="flex items-center justify-center py-6 text-rose-400 col-span-2">
					<i class="fas fa-exclamation-circle mr-2"></i> Error: ${error.message}
				</div>
			`;
		}
	}

	function updateTopClasses(classes) {
		const list = document.getElementById('topClassesList');
		if (!list) return;

		if (classes.length === 0) {
			list.innerHTML = `
				<li class="flex items-center justify-center py-8 text-slate-400">
					<i class="fas fa-inbox mr-2"></i> No attendance data yet
				</li>
			`;
			return;
		}

		list.innerHTML = classes.map(cls => {
			const statusColor = cls.late > cls.on_time ? 'amber' : 'emerald';
			const percentage = Math.round((cls.on_time / cls.count) * 100) || 0;
			
			return `
				<li class="flex items-center justify-between rounded-2xl border border-slate-200/60 px-4 py-3 shadow-sm transition-all duration-300 hover:border-brand-300 hover:shadow-md cursor-pointer dark:border-slate-800" onclick="showClassHistory('${cls.class_name}')">
					<div>
						<p class="font-semibold text-slate-800 dark:text-white">${cls.class_name}</p>
						<span class="text-xs text-slate-500 dark:text-slate-400">${cls.count} students • ${cls.on_time} on-time, ${cls.late} late</span>
					</div>
					<span class="rounded-full bg-${statusColor}-100 px-3 py-1 text-xs font-semibold text-${statusColor}-600">${percentage}%</span>
				</li>
			`;
		}).join('');
	}

	function updateLiveClassrooms(liveClasses) {
		const container = document.getElementById('liveClassroomStatus');
		if (!container) return;

		if (liveClasses.length === 0) {
			container.innerHTML = `
				<div class="flex flex-col items-center justify-center py-12 text-slate-400 col-span-2">
					<i class="fas fa-door-closed text-4xl mb-3 opacity-50"></i>
					<p>No active classes at the moment</p>
				</div>
			`;
			return;
		}

		container.innerHTML = liveClasses.map(cls => {
			const colorMap = {
				emerald: { bg: 'bg-emerald-100/70', badge: 'bg-emerald-100 text-emerald-600', gradient: 'from-emerald-400 to-emerald-500' },
				amber: { bg: 'bg-amber-100/70', badge: 'bg-amber-100 text-amber-600', gradient: 'from-amber-400 to-orange-500' },
				rose: { bg: 'bg-rose-100/70', badge: 'bg-rose-100 text-rose-600', gradient: 'from-rose-400 to-rose-500' },
				slate: { bg: 'bg-slate-100/70', badge: 'bg-slate-100 text-slate-600', gradient: 'from-slate-300 to-slate-400' }
			};
			const colors = colorMap[cls.status_color] || colorMap.emerald;

			return `
				<article class="relative overflow-hidden rounded-2xl border border-slate-200/60 bg-white/80 p-4 shadow transition-all duration-300 hover:shadow-lg dark:border-slate-800 dark:bg-slate-900/70">
					<div class="absolute right-4 top-4 h-14 w-14 rounded-full ${colors.bg} blur-xl"></div>
					<header class="flex items-start justify-between">
						<div>
							<p class="text-xs uppercase text-slate-500">${cls.class_name}</p>
							<h4 class="mt-1 text-base font-bold text-slate-900 dark:text-white">${cls.checked_in} Students</h4>
						</div>
						<span class="rounded-full ${colors.badge} px-3 py-1 text-xs font-semibold">${cls.status}</span>
					</header>
					<div class="mt-4">
						<div class="flex items-center justify-between text-xs text-slate-500">
							<span>Capacity</span>
							<span>${cls.capacity_percent}%</span>
						</div>
						<div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-slate-200 dark:bg-slate-800">
							<div class="h-full rounded-full bg-gradient-to-r ${colors.gradient}" style="width: ${Math.min(cls.capacity_percent, 100)}%"></div>
						</div>
					</div>
				</article>
			`;
		}).join('');
	}

	async function updateRecentCheckins() {
		try {
			const response = await fetch('/api/face-dashboard/stats/', { credentials: 'include' });
			const data = await response.json();
			
			const container = document.getElementById('recentCheckins');
			if (!container) return;

			// Get most recent 5 check-ins from today's attendance
			const recentUrl = '/api/dashboard/stats/';
			// For now, show placeholder until we create a specific endpoint
			container.innerHTML = `
				<li class="flex items-center justify-between transition-all duration-300 hover:bg-white/50 dark:hover:bg-slate-800/50 rounded-xl px-3 py-2">
					<span class="inline-flex items-center gap-3">
						<span class="flex h-9 w-9 items-center justify-center rounded-full bg-brand-100 text-brand-600"><i class="fas fa-user-graduate"></i></span>
						<span class="text-sm text-slate-700 dark:text-slate-300">Live tracking active</span>
					</span>
					<span class="rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-600">${data.today_attendance} today</span>
				</li>
			`;
		} catch (error) {
			console.error('Recent check-ins error:', error);
		}
	}

	async function updateAlerts() {
		try {
			const unknownResponse = await fetch('/api/unknown-faces/', {
				credentials: 'include'
			});
			const unknownData = await unknownResponse.json();
			
			const alertsList = document.getElementById('alertsList');
			const alertsCount = document.getElementById('alertsCount');
			
			if (!alertsList || !alertsCount) return;

			const unknownFaces = unknownData.unknown_faces || [];
			alertsCount.textContent = unknownFaces.length;

			if (unknownFaces.length === 0) {
				alertsList.innerHTML = `
					<li class="flex items-center justify-center py-8 text-slate-400">
						<i class="fas fa-check-circle mr-2 text-emerald-500"></i> No alerts at this time
					</li>
				`;
				return;
			}

			alertsList.innerHTML = unknownFaces.map(face => `
				<li class="flex items-start gap-3 rounded-2xl border border-rose-100 bg-rose-50/80 px-4 py-3 text-rose-600 shadow transition-all duration-300 hover:shadow-md cursor-pointer dark:border-rose-500/30 dark:bg-rose-500/10 dark:text-rose-200" onclick="showUnknownFaceModal('${face.image_url}', '${face.detected_at}', '${face.class_name}')">
					<i class="fas fa-user-secret mt-1 text-base"></i>
					<div class="flex-1">
						<p class="font-semibold">Unknown face detected</p>
						<span class="text-xs text-rose-500/80 dark:text-rose-200/70">Class: ${face.class_name || 'Unknown'} • ${face.time_ago}</span>
					</div>
					<i class="fas fa-chevron-right text-xs mt-1"></i>
				</li>
			`).join('');

		} catch (error) {
			console.error('Alerts update error:', error);
		}
	}

	async function updateCrowdReport() {
		try {
			const response = await fetch('/api/crowd-report/', {
				credentials: 'include'
			});
			const data = await response.json();

			const container = document.getElementById('crowdReportContainer');
			if (!container) return;

			// Map classroom names to icons and display names
			const zoneIcons = {
				'BCA': { icon: 'fa-person-walking', bg: 'bg-sky-100', text: 'text-sky-600' },
				'BSC': { icon: 'fa-users', bg: 'bg-rose-100', text: 'text-rose-600' },
				'BCOM': { icon: 'fa-door-open', bg: 'bg-emerald-100', text: 'text-emerald-600' },
				'ELECTRONICS': { icon: 'fa-microchip', bg: 'bg-purple-100', text: 'text-purple-600' }
			};

			// Build overall occupancy section
			const isNoThreshold = data.overall_occupancy < data.threshold;
			let html = `
				<div class="flex items-center gap-4 rounded-2xl border border-slate-200/60 bg-white/70 p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900/70">
					<div class="flex-1">
						<p class="text-xs uppercase text-slate-500">Overall Occupancy</p>
						<h4 class="mt-1 text-2xl font-semibold text-slate-900 dark:text-white">${data.overall_occupancy}%</h4>
						<p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Threshold: ${data.threshold}% — ${isNoThreshold ? 'no critical crowding detected' : 'critical crowding detected'}</p>
					</div>
				</div>
				<div class="space-y-3">
			`;

			// Build zone cards
			data.zones.forEach(zone => {
				const zoneConfig = zoneIcons[zone.zone] || { icon: 'fa-door-open', bg: 'bg-slate-100', text: 'text-slate-600' };
				
				// Color coding based on status
				let statusColor = 'text-slate-700';
				if (zone.status === 'Critical') statusColor = 'text-rose-600';
				else if (zone.status === 'High') statusColor = 'text-rose-600';
				else if (zone.status === 'Moderate') statusColor = 'text-amber-600';
				else if (zone.status === 'Low') statusColor = 'text-emerald-600';

				html += `
					<div class="flex items-center justify-between rounded-2xl border border-slate-200/60 bg-white/70 p-3 shadow-sm dark:border-slate-800 dark:bg-slate-900/70">
						<div class="flex items-center gap-3">
							<span class="flex h-9 w-9 items-center justify-center rounded-full ${zoneConfig.bg} ${zoneConfig.text}">
								<i class="fas ${zoneConfig.icon}"></i>
							</span>
							<div>
								<p class="font-semibold text-slate-900 dark:text-white">${zone.zone}</p>
								<span class="text-xs text-slate-500 dark:text-slate-400">Current density: ${zone.density_percent}%</span>
							</div>
						</div>
						<div class="text-sm font-semibold ${statusColor} dark:text-white">${zone.status}</div>
					</div>
				`;
			});

			html += `</div>`;
			container.innerHTML = html;

		} catch (error) {
			console.error('Crowd report update error:', error);
		}
	}

	// Initial load
	updateDashboard();
	updateAlerts();

	// Auto-refresh every 5 seconds
	setInterval(updateDashboard, 5000);
	setInterval(updateAlerts, 5000);

	// Add event listener for generate crowd report button
	// Ensure handlers are attached after DOM is ready so elements (modal, buttons) exist
	document.addEventListener('DOMContentLoaded', () => {
		console.log('Crowd report script: DOMContentLoaded - attaching handlers');
		const generateCrowdBtn = document.getElementById('generateCrowd');
		const crowdReportModal = document.getElementById('crowdReportModal');
		const crowdReportClose = document.getElementById('crowdReportClose');
		const crowdReportContent = document.getElementById('crowdReportContent');

		if (generateCrowdBtn && crowdReportModal) {
			generateCrowdBtn.addEventListener('click', async () => {
				console.log('Generate report clicked');
				generateCrowdBtn.disabled = true;
				generateCrowdBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generating...';
				if (crowdReportContent) {
					crowdReportContent.innerHTML = '<div class="flex items-center justify-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i> Loading report...</div>';
				}
				crowdReportModal.style.display = 'flex';

				try {
					const response = await fetch('/api/crowd-report/', {
						credentials: 'include'
					});
					const data = await response.json();

				// Build report HTML
				const isNoThreshold = data.overall_occupancy < data.threshold;
				const zoneIcons = {
					'BCA': { icon: 'fa-person-walking', bg: 'bg-sky-100', text: 'text-sky-600' },
					'BSC': { icon: 'fa-users', bg: 'bg-rose-100', text: 'text-rose-600' },
					'BCOM': { icon: 'fa-door-open', bg: 'bg-emerald-100', text: 'text-emerald-600' },
					'ELECTRONICS': { icon: 'fa-microchip', bg: 'bg-purple-100', text: 'text-purple-600' }
				};

				let html = `
					<div class="flex items-center gap-4 rounded-2xl border border-slate-200/60 bg-gradient-to-br from-brand-50 to-blue-50 p-6 shadow-sm dark:border-slate-800 dark:from-slate-900/70 dark:to-slate-800/70">
						<div class="flex-1">
							<p class="text-xs uppercase text-slate-500 dark:text-slate-400">Overall Occupancy</p>
							<h4 class="mt-2 text-4xl font-bold text-slate-900 dark:text-white">${data.overall_occupancy}%</h4>
							<p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Threshold: ${data.threshold}% — ${isNoThreshold ? '✓ No critical crowding' : '⚠ Critical crowding detected'}</p>
						</div>
					</div>
					<div class="grid gap-4 grid-cols-1 md:grid-cols-2">
				`;

				// Build zone cards
				data.zones.forEach(zone => {
					const zoneConfig = zoneIcons[zone.zone] || { icon: 'fa-door-open', bg: 'bg-slate-100', text: 'text-slate-600' };
					
					let statusColor = 'text-slate-700';
					let statusBg = 'bg-slate-50';
					if (zone.status === 'Critical') {
						statusColor = 'text-rose-600';
						statusBg = 'bg-rose-50';
					} else if (zone.status === 'High') {
						statusColor = 'text-rose-600';
						statusBg = 'bg-rose-50';
					} else if (zone.status === 'Moderate') {
						statusColor = 'text-amber-600';
						statusBg = 'bg-amber-50';
					} else if (zone.status === 'Low') {
						statusColor = 'text-emerald-600';
						statusBg = 'bg-emerald-50';
					}

					// Progress bar
					const progressColor = zone.status === 'Critical' ? 'bg-rose-500' : 
										  zone.status === 'High' ? 'bg-rose-400' :
										  zone.status === 'Moderate' ? 'bg-amber-400' : 'bg-emerald-500';

					html += `
						<div class="rounded-2xl border border-slate-200/60 ${statusBg} p-4 shadow-sm dark:border-slate-800 dark:${statusBg === 'bg-slate-50' ? 'bg-slate-900/50' : 'bg-slate-900/30'}">
							<div class="flex items-center gap-3 mb-3">
								<span class="flex h-10 w-10 items-center justify-center rounded-full ${zoneConfig.bg} ${zoneConfig.text}">
									<i class="fas ${zoneConfig.icon}"></i>
								</span>
								<div class="flex-1">
									<p class="font-bold text-slate-900 dark:text-white">${zone.zone}</p>
									<p class="text-xs text-slate-500 dark:text-slate-400">${zone.present}/${zone.capacity} students</p>
								</div>
								<div class="text-right">
									<p class="text-2xl font-bold ${statusColor}">${zone.density_percent}%</p>
									<p class="text-xs font-semibold ${statusColor}">${zone.status}</p>
								</div>
							</div>
							<div class="h-2 w-full rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
								<div class="h-full ${progressColor}" style="width: ${zone.density_percent}%"></div>
							</div>
						</div>
					`;
				});

					html += `</div>`;
					// Append chart containers for visual summaries
					html += `
						<div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
							<div class="p-4 bg-white/80 dark:bg-slate-900/70 rounded-xl shadow-sm">
								<p class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Zone occupancy (%)</p>
								<canvas id="crowdBarChart" height="140"></canvas>
							</div>
							<div class="p-4 bg-white/80 dark:bg-slate-900/70 rounded-xl shadow-sm">
								<p class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Distribution by students</p>
								<canvas id="crowdDoughnutChart" height="140"></canvas>
							</div>
						</div>
					`;
					crowdReportContent.innerHTML = html;

					// Initialize Chart.js visuals if available
					if (typeof Chart !== 'undefined') {
						try {
							const labels = data.zones.map(z => z.zone);
							const percentValues = data.zones.map(z => z.density_percent);
							const studentValues = data.zones.map(z => z.present);
							const bgColors = data.zones.map(z => z.status === 'Critical' ? '#ef4444' : z.status === 'High' ? '#fb7185' : z.status === 'Moderate' ? '#f59e0b' : '#10b981');

							// Destroy previous instances
							if (window.crowdBarChart) window.crowdBarChart.destroy();
							if (window.crowdDoughnutChart) window.crowdDoughnutChart.destroy();

							const barCtx = document.getElementById('crowdBarChart').getContext('2d');
							window.crowdBarChart = new Chart(barCtx, {
								type: 'bar',
								data: {
									labels: labels,
									datasets: [{
										label: 'Density %',
										data: percentValues,
										backgroundColor: bgColors,
										headerThickness: 0
									}]
								},
								options: {
									plugins: { legend: { display: false } },
									scales: { y: { beginAtZero: true, max: 100 } }
								}
							});

							const doughCtx = document.getElementById('crowdDoughnutChart').getContext('2d');
							window.crowdDoughnutChart = new Chart(doughCtx, {
								type: 'doughnut',
								data: {
									labels: labels,
									datasets: [{ data: studentValues, backgroundColor: bgColors }]
								},
								options: { plugins: { legend: { position: 'bottom' } } }
							});
						} catch (cErr) {
							console.warn('Chart initialization failed', cErr);
						}
					} else {
						console.warn('Chart.js not found. Include Chart.js CDN to render graphs.');
					}
					} catch (error) {
						console.error('Error loading crowd report:', error);
						if (crowdReportContent) {
							crowdReportContent.innerHTML = '<div class="text-center py-8"><i class="fas fa-exclamation-triangle text-rose-500 text-2xl mb-2"></i><p class="text-slate-600 dark:text-slate-400">Failed to load report</p></div>';
						}
					} finally {
						generateCrowdBtn.disabled = false;
						generateCrowdBtn.innerHTML = 'Generate report';
					}
			});

			// Close modal handlers (guard in case elements are missing)
			if (crowdReportClose) {
				crowdReportClose.addEventListener('click', () => {
					crowdReportModal.style.display = 'none';
				});
			}

			crowdReportModal.addEventListener('click', (e) => {
				if (e.target === crowdReportModal) {
					crowdReportModal.style.display = 'none';
				}
			});
		} else {
			console.warn('Crowd report elements not found: generateCrowdBtn or crowdReportModal is missing');
		}
	});

	// Add event listener for view history button
	const viewHistoryBtn = document.getElementById('viewClassHistoryBtn');
	if (viewHistoryBtn) {
		viewHistoryBtn.addEventListener('click', async () => {
			try {
				const response = await fetch('/api/class-history/', {
					credentials: 'include'
				});
				const data = await response.json();
				
				// Show all classes history in a comprehensive modal
				const allClassesHTML = `
					<div id="allClassesHistoryModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
						<div class="glass-card relative w-full max-w-5xl mx-4 rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
							<div class="flex items-center justify-between mb-6 sticky top-0 bg-gradient-to-b from-white/80 to-white/0 dark:from-slate-900/80 dark:to-slate-900/0 pb-4">
								<div>
									<h3 class="text-2xl font-bold text-slate-900 dark:text-white">All Classes - Attendance History</h3>
									<p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${data.period}</p>
								</div>
								<button onclick="closeAllClassesHistoryModal()" class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
									<i class="fas fa-times text-xl text-slate-600 dark:text-slate-300"></i>
								</button>
							</div>

							<div class="grid lg:grid-cols-2 gap-6">
								${Object.entries(data.classes).map(([className, classData]) => `
									<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-5 dark:border-slate-800 dark:bg-slate-900/30 hover:shadow-lg transition cursor-pointer" onclick="showClassHistory('${className}')">
										<div class="flex items-start justify-between mb-4">
											<div>
												<h4 class="text-lg font-bold text-slate-900 dark:text-white">${className}</h4>
												<p class="text-xs text-slate-500 dark:text-slate-400">${classData.unique_students} unique students</p>
											</div>
											<span class="rounded-full ${classData.on_time_percentage >= 80 ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'} px-3 py-1 text-xs font-semibold">${classData.on_time_percentage}%</span>
										</div>
										
										<div class="grid grid-cols-3 gap-2 mb-4 text-center">
											<div class="rounded-lg bg-slate-100 dark:bg-slate-800 p-2">
												<p class="text-xs text-slate-600 dark:text-slate-400">Total</p>
												<p class="text-lg font-bold text-slate-900 dark:text-white">${classData.total_attendance}</p>
											</div>
											<div class="rounded-lg bg-emerald-100/50 dark:bg-emerald-900/30 p-2">
												<p class="text-xs text-emerald-600 dark:text-emerald-400">On-Time</p>
												<p class="text-lg font-bold text-emerald-600 dark:text-emerald-400">${classData.total_on_time}</p>
											</div>
											<div class="rounded-lg bg-amber-100/50 dark:bg-amber-900/30 p-2">
												<p class="text-xs text-amber-600 dark:text-amber-400">Late</p>
												<p class="text-lg font-bold text-amber-600 dark:text-amber-400">${classData.total_late}</p>
											</div>
										</div>

										<div class="space-y-2">
											<div class="flex justify-between items-center text-xs mb-1">
												<span class="text-slate-600 dark:text-slate-400">On-Time Rate</span>
												<span class="font-bold text-emerald-600">${classData.on_time_percentage}%</span>
											</div>
											<div class="h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
												<div class="h-full bg-gradient-to-r from-emerald-400 to-emerald-600" style="width: ${classData.on_time_percentage}%"></div>
											</div>
										</div>
										
										<div class="mt-4 pt-4 border-t border-slate-200/60 dark:border-slate-700">
											<i class="fas fa-chevron-right text-sm text-brand-600 dark:text-brand-400"></i>
											<p class="text-xs text-brand-600 dark:text-brand-400 font-semibold inline ml-2">View Details</p>
										</div>
									</div>
								`).join('')}
							</div>
						</div>
					</div>
				`;

				const existingModal = document.getElementById('allClassesHistoryModal');
				if (existingModal) existingModal.remove();

				document.body.insertAdjacentHTML('beforeend', allClassesHTML);
			} catch (error) {
				console.error('Error loading all classes history:', error);
				alert('Failed to load class history');
			}
		});
	}
})();

window.closeAllClassesHistoryModal = function() {
	const modal = document.getElementById('allClassesHistoryModal');
	if (modal) modal.remove();
};

// Class History Modal// Class History Modal
window.showClassHistory = async function(className) {
	try {
		const response = await fetch('/api/class-history/', {
			credentials: 'include'
		});
		const data = await response.json();
		const classData = data.classes[className];
		
		if (!classData) {
			alert('No data found for this class');
			return;
		}

		const modalHTML = `
			<div id="classHistoryModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
				<div class="glass-card relative w-full max-w-4xl mx-4 rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
					<div class="flex items-center justify-between mb-6">
						<div>
							<h3 class="text-2xl font-bold text-slate-900 dark:text-white">
								<i class="fas fa-chart-bar text-brand-600 mr-2"></i> ${className} - Attendance History
							</h3>
							<p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${data.period}</p>
						</div>
						<button onclick="closeClassHistoryModal()" class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
							<i class="fas fa-times text-xl text-slate-600 dark:text-slate-300"></i>
						</button>
					</div>

					<div class="grid md:grid-cols-4 gap-4 mb-6">
						<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-4 dark:border-slate-800 dark:bg-slate-900/30">
							<p class="text-xs uppercase text-slate-500 mb-1">Total Attendance</p>
							<p class="text-2xl font-bold text-slate-900 dark:text-white">${classData.total_attendance}</p>
							<p class="text-xs text-slate-400 mt-1">${classData.unique_students} unique students</p>
						</div>
						<div class="rounded-2xl border border-emerald-200/60 bg-emerald-50/50 p-4 dark:border-emerald-800 dark:bg-emerald-900/20">
							<p class="text-xs uppercase text-emerald-600 dark:text-emerald-400 mb-1">On-Time</p>
							<p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${classData.total_on_time}</p>
							<p class="text-xs text-emerald-500 mt-1">${classData.on_time_percentage}% rate</p>
						</div>
						<div class="rounded-2xl border border-amber-200/60 bg-amber-50/50 p-4 dark:border-amber-800 dark:bg-amber-900/20">
							<p class="text-xs uppercase text-amber-600 dark:text-amber-400 mb-1">Late</p>
							<p class="text-2xl font-bold text-amber-600 dark:text-amber-400">${classData.total_late}</p>
							<p class="text-xs text-amber-500 mt-1">${Math.round((classData.total_late / classData.total_attendance) * 100)}% rate</p>
						</div>
						<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-4 dark:border-slate-800 dark:bg-slate-900/30">
							<p class="text-xs uppercase text-slate-500 mb-1">Avg per Day</p>
							<p class="text-2xl font-bold text-slate-900 dark:text-white">${Math.round(classData.total_attendance / 30)}</p>
							<p class="text-xs text-slate-400 mt-1">students/day</p>
						</div>
					</div>

					<div class="grid md:grid-cols-2 gap-6">
						<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-4 dark:border-slate-800 dark:bg-slate-900/30">
							<h4 class="font-semibold text-slate-900 dark:text-white mb-4">Last 7 Days Trend</h4>
							<div class="space-y-3">
								${classData.daily_data.map(d => `
									<div class="flex items-center gap-3">
										<span class="text-xs font-semibold text-slate-500 w-8">${d.date}</span>
										<div class="flex-1 h-6 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
											<div class="h-full bg-gradient-to-r from-brand-400 to-brand-600 rounded-full" style="width: ${(d.count / Math.max(...classData.daily_data.map(x => x.count), 1)) * 100}%"></div>
										</div>
										<span class="text-xs font-semibold text-slate-900 dark:text-white w-6 text-right">${d.count}</span>
									</div>
								`).join('')}
							</div>
						</div>

						<div class="rounded-2xl border border-slate-200/60 bg-white/50 p-4 dark:border-slate-800 dark:bg-slate-900/30">
							<h4 class="font-semibold text-slate-900 dark:text-white mb-4">Attendance Status Breakdown</h4>
							<div class="space-y-4">
								<div>
									<div class="flex justify-between text-xs mb-2">
										<span class="text-slate-600 dark:text-slate-300">On-Time Percentage</span>
										<span class="font-bold text-emerald-600">${classData.on_time_percentage}%</span>
									</div>
									<div class="h-3 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
										<div class="h-full bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full" style="width: ${classData.on_time_percentage}%"></div>
									</div>
								</div>
								<div>
									<div class="flex justify-between text-xs mb-2">
										<span class="text-slate-600 dark:text-slate-300">Late Percentage</span>
										<span class="font-bold text-amber-600">${Math.round((classData.total_late / classData.total_attendance) * 100)}%</span>
									</div>
									<div class="h-3 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
										<div class="h-full bg-gradient-to-r from-amber-400 to-amber-600 rounded-full" style="width: ${Math.round((classData.total_late / classData.total_attendance) * 100)}%"></div>
									</div>
								</div>
								<div class="mt-4 rounded-xl border border-brand-200/60 bg-brand-50/50 p-3 dark:border-brand-800 dark:bg-brand-900/20">
									<p class="text-xs text-brand-700 dark:text-brand-200">
										<i class="fas fa-info-circle mr-1"></i> 
										${classData.on_time_percentage >= 90 ? "Excellent punctuality! Keep up the good work." : classData.on_time_percentage >= 75 ? "Good attendance rate. Room for improvement." : "Needs attention to punctuality."}
									</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		`;

		// Remove any existing modal
		const existingModal = document.getElementById('classHistoryModal');
		if (existingModal) existingModal.remove();

		document.body.insertAdjacentHTML('beforeend', modalHTML);
	} catch (error) {
		console.error('Error loading class history:', error);
		alert('Failed to load class history');
	}
};

window.closeClassHistoryModal = function() {
	const modal = document.getElementById('classHistoryModal');
	if (modal) modal.remove();
};

// Close modal on outside click
document.addEventListener('click', function(e) {
	if (e.target && e.target.id === 'classHistoryModal') {
		window.closeClassHistoryModal();
	}
});

// Unknown Face Modal
window.showUnknownFaceModal = function(imageUrl, detectedAt, className) {
	const modalHTML = `
		<div id="unknownFaceModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
			<div class="glass-card relative w-full max-w-2xl mx-4 rounded-3xl p-6 shadow-2xl">
				<div class="flex items-center justify-between mb-4">
					<h3 class="text-xl font-bold text-slate-900 dark:text-white">
						<i class="fas fa-user-secret text-rose-600 mr-2"></i> Unknown Face Detected
					</h3>
					<button onclick="closeUnknownFaceModal()" class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition">
						<i class="fas fa-times text-xl text-slate-600 dark:text-slate-300"></i>
					</button>
				</div>
				
				<div class="grid md:grid-cols-2 gap-6">
					<div class="rounded-2xl overflow-hidden bg-slate-900">
						<img src="${imageUrl}" alt="Unknown Face" class="w-full h-auto object-contain" style="max-height: 400px;">
					</div>
					
					<div class="flex flex-col justify-center space-y-4">
						<div class="rounded-2xl border border-slate-200/60 p-4 dark:border-slate-800">
							<p class="text-xs uppercase text-slate-500 mb-1">Detected At</p>
							<p class="text-lg font-semibold text-slate-900 dark:text-white">${detectedAt}</p>
						</div>
						
						<div class="rounded-2xl border border-slate-200/60 p-4 dark:border-slate-800">
							<p class="text-xs uppercase text-slate-500 mb-1">Class</p>
							<p class="text-lg font-semibold text-slate-900 dark:text-white">${className || 'Unknown'}</p>
						</div>
						
						<div class="rounded-2xl border border-rose-200/60 bg-rose-50/80 p-4 dark:border-rose-800 dark:bg-rose-900/20">
							<div class="flex items-start gap-2">
								<i class="fas fa-exclamation-triangle text-rose-600 mt-1"></i>
								<div>
									<p class="text-sm font-semibold text-rose-900 dark:text-rose-100">Action Required</p>
									<p class="text-xs text-rose-700 dark:text-rose-200 mt-1">This person was not recognized in the system. Please verify identity and add to database if authorized.</p>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div class="mt-6 flex justify-end gap-3">
					<button onclick="closeUnknownFaceModal()" class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800">
						Close
					</button>
					<button class="rounded-lg bg-brand-600 hover:bg-brand-700 px-4 py-2 text-sm font-semibold text-white shadow-md transition">
						<i class="fas fa-user-plus mr-2"></i> Add to System
					</button>
				</div>
			</div>
		</div>
	`;
	
	document.body.insertAdjacentHTML('beforeend', modalHTML);
};

window.closeUnknownFaceModal = function() {
	const modal = document.getElementById('unknownFaceModal');
	if (modal) {
		modal.remove();
	}
};

// Attendance Modal Functionality
(function() {
	const logAttendanceBtn = document.getElementById('logAttendanceBtn');
	if (!logAttendanceBtn) return;

	// Create Attendance Modal
	const modalHTML = `
	<div id="attendanceModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm" role="dialog" aria-modal="true">
		<div class="glass-card relative w-full max-w-4xl mx-4 rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
			<div class="flex items-center justify-between mb-6">
				<div>
					<h2 class="text-2xl font-bold text-slate-900 dark:text-white">Log Attendance</h2>
					<p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Start camera to mark student attendance</p>
				</div>
				<button id="closeAttendanceModal" class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800 transition" aria-label="Close">
					<i class="fas fa-times text-xl text-slate-600 dark:text-slate-300"></i>
				</button>
			</div>

			<!-- Camera Feed -->
			<div class="relative mb-6 rounded-2xl overflow-hidden bg-slate-900" style="height: 400px;">
				<img id="attendanceVideoFeed" src="" alt="Camera Feed" class="w-full h-full object-cover hidden">
				<div id="attendanceCameraPlaceholder" class="w-full h-full flex items-center justify-center">
					<div class="text-center text-slate-400">
						<i class="fas fa-camera text-6xl mb-4 opacity-50"></i>
						<p class="text-lg">Configure settings and click "Start Camera"</p>
					</div>
				</div>
			</div>

			<!-- Controls -->
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
				<div>
					<label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
						<i class="fas fa-graduation-cap mr-1"></i> Select Class
					</label>
					<select id="attendanceClass" class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
						<option value="">-- Select Class --</option>
						<option value="BCA">BCA</option>
						<option value="BSC">BSC</option>
						<option value="BCOM">BCOM</option>
						<option value="ELECTRONICS">ELECTRONICS</option>
					</select>
				</div>
				<div>
					<label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
						<i class="fas fa-clock mr-1"></i> Cutoff Time
					</label>
					<input type="time" id="attendanceCutoffTime" class="w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500" value="09:00">
				</div>
				<div class="flex items-end">
					<button id="startAttendanceCameraBtn" class="w-full rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 text-sm font-semibold shadow-md transition">
						<i class="fas fa-play mr-2"></i> Start Camera
					</button>
					<button id="stopAttendanceCameraBtn" class="w-full rounded-lg bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 text-sm font-semibold shadow-md transition hidden">
						<i class="fas fa-stop mr-2"></i> Stop Camera
					</button>
				</div>
			</div>

			<!-- Status Message -->
			<div id="attendanceMessage" class="hidden rounded-lg p-4 mb-4">
				<div class="flex items-center gap-3">
					<i class="fas fa-info-circle text-xl"></i>
					<div id="attendanceMessageContent"></div>
				</div>
			</div>

			<!-- Instructions -->
			<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
				<div class="flex items-start gap-3">
					<i class="fas fa-info-circle text-blue-600 dark:text-blue-400 text-lg mt-1"></i>
					<div class="text-sm text-blue-900 dark:text-blue-100">
						<p class="font-semibold mb-2">How it works:</p>
						<ul class="space-y-1 text-xs">
							<li>• Students crossing the red line will be automatically detected</li>
							<li>• First crossing = Check-In, second crossing = Check-Out</li>
							<li>• Late arrivals (after cutoff time) will be marked as "Late"</li>
							<li>• Unknown faces will trigger an alert and be saved for review</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>`;

	document.body.insertAdjacentHTML('beforeend', modalHTML);

	const modal = document.getElementById('attendanceModal');
	const closeBtn = document.getElementById('closeAttendanceModal');
	const startBtn = document.getElementById('startAttendanceCameraBtn');
	const stopBtn = document.getElementById('stopAttendanceCameraBtn');
	const videoFeed = document.getElementById('attendanceVideoFeed');
	const placeholder = document.getElementById('attendanceCameraPlaceholder');
	const classSelect = document.getElementById('attendanceClass');
	const cutoffTime = document.getElementById('attendanceCutoffTime');
	const messageBox = document.getElementById('attendanceMessage');
	const messageContent = document.getElementById('attendanceMessageContent');

	let currentSessionId = null;
	let statusInterval = null;

	function openModal() {
		modal.classList.remove('hidden');
		modal.classList.add('flex');
	}

	function closeModal() {
		modal.classList.add('hidden');
		modal.classList.remove('flex');
		if (currentSessionId) {
			stopCamera();
		}
	}

	function showMessage(content, type = 'info') {
		messageBox.className = `rounded-lg p-4 mb-4 ${
			type === 'success' ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-900 dark:text-green-100' :
			type === 'error' ? 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-900 dark:text-red-100' :
			type === 'warning' ? 'bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-amber-900 dark:text-amber-100' :
			'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 text-blue-900 dark:text-blue-100'
		}`;
		messageContent.innerHTML = content;
		messageBox.classList.remove('hidden');
	}

	function pollStatus() {
		if (!currentSessionId) return;
		
		statusInterval = setInterval(async () => {
			try {
				const res = await fetch(`/api/attendance/status/${currentSessionId}/`);
				const data = await res.json();
				
				if (data.last_result) {
					if (data.last_result.unknown) {
						showMessage(data.last_result.message, 'warning');
					} else {
						showMessage(`
							<strong>Attendance Marked</strong><br>
							<span class="text-sm">Student ID: ${data.last_result.student_id}</span><br>
							<span class="text-sm">Name: ${data.last_result.name}</span><br>
							<span class="text-sm">Action: ${data.last_result.action}</span><br>
							<span class="text-sm">Time: ${data.last_result.time}</span><br>
							<span class="text-sm">Status: <strong>${data.last_result.status}</strong></span>
						`, data.last_result.status === 'Late' ? 'warning' : 'success');
					}
					// Clear result
					data.last_result = null;
				}
				
				if (!data.active) {
					clearInterval(statusInterval);
					stopCamera();
				}
			} catch (error) {
				console.error('Status poll error:', error);
			}
		}, 500);
	}

	async function startCamera() {
		const className = classSelect.value;
		const cutoff = cutoffTime.value;

		if (!className) {
			showMessage('Please select a class', 'error');
			return;
		}

		if (!cutoff) {
			showMessage('Please set a cutoff time', 'error');
			return;
		}

		try {
			const res = await fetch('/api/attendance/start/', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					class_name: className,
					cutoff_time: cutoff
				})
			});

			const data = await res.json();

			if (data.success) {
				currentSessionId = data.session_id;
				placeholder.classList.add('hidden');
				videoFeed.classList.remove('hidden');
				videoFeed.src = `/api/attendance/video-feed/${currentSessionId}/`;
				startBtn.classList.add('hidden');
				stopBtn.classList.remove('hidden');
				classSelect.disabled = true;
				cutoffTime.disabled = true;
				showMessage('Camera started. Students will be automatically detected.', 'success');
				pollStatus();
			} else {
				showMessage(data.error || 'Failed to start camera', 'error');
			}
		} catch (error) {
			console.error('Start camera error:', error);
			showMessage('Network error occurred', 'error');
		}
	}

	async function stopCamera() {
		if (!currentSessionId) return;

		try {
			await fetch('/api/attendance/stop/', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ session_id: currentSessionId })
			});
		} catch (error) {
			console.error('Stop camera error:', error);
		}

		clearInterval(statusInterval);
		videoFeed.src = '';
		videoFeed.classList.add('hidden');
		placeholder.classList.remove('hidden');
		startBtn.classList.remove('hidden');
		stopBtn.classList.add('hidden');
		classSelect.disabled = false;
		cutoffTime.disabled = false;
		currentSessionId = null;
		messageBox.classList.add('hidden');
	}

	logAttendanceBtn.addEventListener('click', openModal);
	closeBtn.addEventListener('click', closeModal);
	startBtn.addEventListener('click', startCamera);
	stopBtn.addEventListener('click', stopCamera);
	
	// Close on outside click
	modal.addEventListener('click', (e) => {
		if (e.target === modal) closeModal();
	});
})();
</script>

<!-- Crowd Report Modal -->
<div id="crowdReportModal" class="fixed inset-0 z-[1001] items-center justify-center" style="display: none;">
	<div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
	<div class="relative w-full md:w-[800px] max-w-[92vw] rounded-3xl glass-card border border-slate-200/60 dark:border-slate-800 overflow-hidden shadow-2xl max-h-[90vh] overflow-y-auto">
		<header class="sticky top-0 flex items-center justify-between px-6 py-4 border-b border-slate-200/60 dark:border-slate-800 bg-white/70 dark:bg-slate-900/70 backdrop-blur-sm">
			<div>
				<h3 class="text-lg font-bold text-slate-900 dark:text-white">Crowd Detection Report</h3>
				<p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Live occupancy snapshot</p>
			</div>
			<button id="crowdReportClose" class="rounded-full border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-600 hover:border-brand-500 hover:text-brand-600 dark:border-slate-700 dark:text-slate-300"><i class='fas fa-times'></i></button>
		</header>
		<div class="p-6 space-y-6">
			<!-- Overall Occupancy -->
			<div id="crowdReportContent" class="space-y-6">
				<div class="flex items-center justify-center py-8">
					<i class="fas fa-spinner fa-spin mr-2"></i> Loading report...
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Hidden form to ensure CSRF cookie is set -->
<form style="display:none">{% csrf_token %}</form>
</script>
<!-- Chart.js CDN for visual graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Particle system for beautiful floating elements
(function() {
	const colors = ['#6366f1', '#8b5cf6', '#3b82f6', '#06b6d4', '#10b981'];
	
	function createParticle() {
		const particle = document.createElement('div');
		particle.className = 'particle';
		particle.style.left = Math.random() * 100 + '%';
		particle.style.width = (Math.random() * 8 + 4) + 'px';
		particle.style.height = particle.style.width;
		particle.style.background = colors[Math.floor(Math.random() * colors.length)];
		particle.style.borderRadius = '50%';
		particle.style.animation = `particleFloat ${Math.random() * 10 + 15}s linear infinite`;
		particle.style.animationDelay = Math.random() * 5 + 's';
		document.body.appendChild(particle);
		
		setTimeout(() => particle.remove(), 25000);
	}
	
	// Create particles periodically
	setInterval(createParticle, 2000);
	for(let i = 0; i < 5; i++) {
		setTimeout(createParticle, i * 400);
	}
})();

// Enhanced smooth scrolling with offset
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
	anchor.addEventListener('click', function (e) {
		e.preventDefault();
		const target = document.querySelector(this.getAttribute('href'));
		if (target) {
			const offset = 100;
			const elementPosition = target.getBoundingClientRect().top;
			const offsetPosition = elementPosition + window.pageYOffset - offset;
			
			window.scrollTo({
				top: offsetPosition,
				behavior: 'smooth'
			});
		}
	});
});

// Add active state to navigation items on scroll
const sections = document.querySelectorAll('section[id]');
const navItems = document.querySelectorAll('.nav-item');

window.addEventListener('scroll', () => {
	let current = '';
	sections.forEach(section => {
		const sectionTop = section.offsetTop;
		const sectionHeight = section.clientHeight;
		if (pageYOffset >= (sectionTop - 200)) {
			current = section.getAttribute('id');
		}
	});
	
	navItems.forEach(item => {
		item.classList.remove('active');
		if (item.getAttribute('href') === '#' + current || (current === '' && item.getAttribute('href') === '#')) {
			item.classList.add('active');
		}
	});
});

// Animate numbers on load with counter effect
function animateCounter(element, target, duration = 1000) {
	const start = 0;
	const increment = target / (duration / 16);
	let current = start;
	
	const timer = setInterval(() => {
		current += increment;
		if (current >= target) {
			element.textContent = target;
			clearInterval(timer);
		} else {
			element.textContent = Math.floor(current);
		}
	}, 16);
}

// Intersection Observer for scroll animations
const observerOptions = {
	threshold: 0.1,
	rootMargin: '0px 0px -100px 0px'
};

const observer = new IntersectionObserver((entries) => {
	entries.forEach(entry => {
		if (entry.isIntersecting) {
			entry.target.style.opacity = '1';
			entry.target.style.transform = 'translateY(0)';
		}
	});
}, observerOptions);

// Observe all cards for scroll animations
document.querySelectorAll('.glass-card').forEach(card => {
	if (!card.style.animationDelay) {
		card.style.opacity = '0';
		card.style.transform = 'translateY(20px)';
		card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
	}
	observer.observe(card);
});

// Add ripple effect to buttons
document.querySelectorAll('button, .btn').forEach(button => {
	button.addEventListener('click', function(e) {
		const ripple = document.createElement('span');
		const rect = this.getBoundingClientRect();
		const size = Math.max(rect.width, rect.height);
		const x = e.clientX - rect.left - size / 2;
		const y = e.clientY - rect.top - size / 2;
		
		ripple.style.width = ripple.style.height = size + 'px';
		ripple.style.left = x + 'px';
		ripple.style.top = y + 'px';
		ripple.style.position = 'absolute';
		ripple.style.borderRadius = '50%';
		ripple.style.background = 'rgba(255, 255, 255, 0.6)';
		ripple.style.transform = 'scale(0)';
		ripple.style.animation = 'rippleEffect 0.6s ease-out';
		ripple.style.pointerEvents = 'none';
		
		this.appendChild(ripple);
		setTimeout(() => ripple.remove(), 600);
	});
});

// Add ripple animation
const style = document.createElement('style');
style.textContent = `
	@keyframes rippleEffect {
		to {
			transform: scale(4);
			opacity: 0;
		}
	}
`;
document.head.appendChild(style);

// Card tilt effect on mouse move
document.querySelectorAll('.metric-card').forEach(card => {
	card.addEventListener('mousemove', (e) => {
		const rect = card.getBoundingClientRect();
		const x = e.clientX - rect.left;
		const y = e.clientY - rect.top;
		
		const centerX = rect.width / 2;
		const centerY = rect.height / 2;
		
		const rotateX = (y - centerY) / 20;
		const rotateY = (centerX - x) / 20;
		
		card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-8px) scale(1.02)`;
	});
	
	card.addEventListener('mouseleave', () => {
		card.style.transform = '';
	});
});

// Tooltip functionality
const tooltipElements = document.querySelectorAll('[data-tooltip]');
tooltipElements.forEach(el => {
	el.addEventListener('mouseenter', (e) => {
		const tooltip = document.createElement('div');
		tooltip.className = 'tooltip show';
		tooltip.textContent = el.getAttribute('data-tooltip');
		tooltip.id = 'active-tooltip';
		
		document.body.appendChild(tooltip);
		
		const rect = el.getBoundingClientRect();
		tooltip.style.left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2 + 'px';
		tooltip.style.top = rect.bottom + 10 + 'px';
	});
	
	el.addEventListener('mouseleave', () => {
		const tooltip = document.getElementById('active-tooltip');
		if (tooltip) tooltip.remove();
	});
});

// Add click animation to stat numbers
document.querySelectorAll('.stat-number').forEach(stat => {
	stat.addEventListener('click', function() {
		this.style.transform = 'scale(1.2)';
		setTimeout(() => {
			this.style.transform = '';
		}, 200);
	});
});

// Interactive badge click handlers
document.querySelectorAll('.status-badge').forEach(badge => {
	badge.addEventListener('click', function() {
		const badges = document.querySelectorAll('.status-badge');
		badges.forEach(b => b.style.opacity = '0.5');
		this.style.opacity = '1';
		
		setTimeout(() => {
			badges.forEach(b => b.style.opacity = '1');
		}, 1500);
	});
});

// Enhanced card hover effects
document.querySelectorAll('.metric-card').forEach(card => {
	card.addEventListener('mouseenter', () => {
		card.style.boxShadow = '0 30px 60px rgba(99, 102, 241, 0.25)';
	});
	card.addEventListener('mouseleave', () => {
		card.style.boxShadow = '';
	});
});

// Hero date + greeting updater
(function() {
	const dateEl = document.getElementById('heroDate');
	const greetingEl = document.getElementById('heroGreeting');

	function updateHeroHeader() {
		if (dateEl) {
			const now = new Date();
			const dateFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
			const timeFormatter = new Intl.DateTimeFormat('en-US', { hour: 'numeric', minute: '2-digit' });
			dateEl.textContent = `${dateFormatter.format(now)} · ${timeFormatter.format(now)}`;
		}

		if (greetingEl) {
			const hour = new Date().getHours();
			let greeting = 'Hello';
			if (hour < 12) greeting = 'Good morning';
			else if (hour < 17) greeting = 'Good afternoon';
			else greeting = 'Good evening';
			greetingEl.textContent = greeting;
		}
	}

	updateHeroHeader();
	setInterval(updateHeroHeader, 60000);
})();

// ========================================
// MODERN NAVBAR FUNCTIONALITY
// ========================================
(function() {
	// Profile Dropdown Toggle
	const profileToggleBtn = document.getElementById('profileToggleBtn');
	const profileDropdown = document.getElementById('profileDropdown');
	const profileDropdownBtn = document.querySelector('.profile-toggle-btn');

	if (profileToggleBtn && profileDropdown) {
		profileToggleBtn.addEventListener('click', (e) => {
			e.stopPropagation();
			const isVisible = profileDropdown.classList.contains('visible');
			
			if (isVisible) {
				profileDropdown.classList.remove('visible');
				profileToggleBtn.setAttribute('aria-expanded', 'false');
			} else {
				profileDropdown.classList.add('visible');
				profileToggleBtn.setAttribute('aria-expanded', 'true');
			}
		});

		// Close on outside click
		document.addEventListener('click', (e) => {
			if (!e.target.closest('.navbar-profile-dropdown')) {
				profileDropdown.classList.remove('visible');
				profileToggleBtn.setAttribute('aria-expanded', 'false');
			}
		});
	}

	// Navbar timestamp updater
	const navbarTimestamp = document.getElementById('navbarTimestamp');
	if (navbarTimestamp) {
		function updateTime() {
			const now = new Date();
			const timeFormatter = new Intl.DateTimeFormat('en-US', { 
				hour: 'numeric', 
				minute: '2-digit',
				second: '2-digit',
				hour12: true 
			});
			navbarTimestamp.textContent = timeFormatter.format(now);
		}
		
		updateTime();
		setInterval(updateTime, 1000);
	}

	// Back button functionality
	const backHomeBtn = document.getElementById('backHomeBtn');
	if (backHomeBtn) {
		backHomeBtn.addEventListener('click', () => {
			window.history.back();
		});
	}

	// Notification button with animation
	const notificationBtn = document.getElementById('notificationBtn');
	if (notificationBtn) {
		notificationBtn.addEventListener('click', (e) => {
			e.stopPropagation();
			// Show notification toast or panel
			showNotificationToast('You have 3 new notifications', 'info');
		});

		// Remove notification indicator on click (after 2 seconds)
		setTimeout(() => {
			const indicator = notificationBtn.querySelector('span.animate-pulse');
			if (indicator) {
				indicator.style.display = 'none';
			}
		}, 2000);
	}

	// Notification toast function
	function showNotificationToast(message, type = 'info') {
		const toast = document.createElement('div');
		toast.className = `fixed bottom-4 right-4 px-6 py-4 rounded-xl text-white shadow-lg z-50 flex items-center gap-3 ${
			type === 'info' ? 'bg-blue-500' : 
			type === 'success' ? 'bg-green-500' :
			type === 'error' ? 'bg-red-500' :
			'bg-slate-600'
		} animate-bounce`;
		
		toast.innerHTML = `
			<i class="fas fa-${
				type === 'info' ? 'info-circle' :
				type === 'success' ? 'check-circle' :
				type === 'error' ? 'exclamation-circle' :
				'bell'
			}"></i>
			<span>${message}</span>
		`;
		
		document.body.appendChild(toast);
		
		setTimeout(() => {
			toast.style.opacity = '0';
			toast.style.transition = 'opacity 0.3s ease';
			setTimeout(() => toast.remove(), 300);
		}, 3000);
	}

	// Smooth navbar entrance animation
	const navbar = document.querySelector('header');
	if (navbar) {
		navbar.style.animation = 'slideDownSmooth 0.5s cubic-bezier(0.16, 1, 0.3, 1)';
		const style = document.createElement('style');
		style.textContent = `
			@keyframes slideDownSmooth {
				from {
					opacity: 0;
					transform: translateY(-20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}
		`;
		document.head.appendChild(style);
	}

	// Profile dropdown item hover effects
	const dropdownItems = document.querySelectorAll('.profile-dropdown-menu a');
	dropdownItems.forEach(item => {
		item.addEventListener('mouseenter', function() {
			this.style.background = 'rgba(99, 102, 241, 0.1)';
		});
		item.addEventListener('mouseleave', function() {
			this.style.background = 'transparent';
		});
	});

	// Navbar button ripple effects (if data-ripple-light is present)
	document.querySelectorAll('[data-ripple-light]').forEach(button => {
		button.addEventListener('click', function(e) {
			const ripple = document.createElement('span');
			const rect = this.getBoundingClientRect();
			const size = Math.max(rect.width, rect.height);
			const x = e.clientX - rect.left - size / 2;
			const y = e.clientY - rect.top - size / 2;

			ripple.style.width = ripple.style.height = size + 'px';
			ripple.style.left = x + 'px';
			ripple.style.top = y + 'px';
			ripple.className = 'ripple-light';
			ripple.style.position = 'absolute';
			ripple.style.borderRadius = '50%';
			ripple.style.background = 'rgba(255, 255, 255, 0.6)';
			ripple.style.pointerEvents = 'none';
			ripple.style.animation = 'rippleEffect 0.6s ease-out';

			this.style.position = 'relative';
			this.style.overflow = 'hidden';
			this.appendChild(ripple);

			setTimeout(() => ripple.remove(), 600);
		});
	});

	// Active page indicator (if multiple pages)
	const currentPath = window.location.pathname;
	document.querySelectorAll('.profile-dropdown-menu a').forEach(link => {
		if (link.getAttribute('href') === currentPath) {
			link.style.background = 'rgba(99, 102, 241, 0.15)';
			link.style.color = 'var(--brand-600)';
		}
	});

	// Keyboard shortcut: Cmd/Ctrl + Shift + P to open profile
	document.addEventListener('keydown', (e) => {
		if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'P') {
			e.preventDefault();
			if (profileToggleBtn) {
				profileToggleBtn.click();
			}
		}
	});

	// Keyboard shortcut: Esc to close dropdown
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && profileDropdown) {
			profileDropdown.classList.remove('visible');
			profileToggleBtn.setAttribute('aria-expanded', 'false');
		}
	});

	// Navbar scroll behavior (optional: add subtle shadow on scroll)
	window.addEventListener('scroll', () => {
		if (navbar) {
			if (window.scrollY > 10) {
				navbar.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.08)';
			} else {
				navbar.style.boxShadow = '';
			}
		}
	}, { passive: true });

	// Accessibility: Announce navbar changes
	const navbar_status = document.createElement('div');
	navbar_status.setAttribute('role', 'status');
	navbar_status.setAttribute('aria-live', 'polite');
	navbar_status.setAttribute('aria-atomic', 'true');
	navbar_status.className = 'sr-only';
	document.body.appendChild(navbar_status);
})();

// Navbar ripple effect styles
const navbarRippleStyle = document.createElement('style');
navbarRippleStyle.textContent = `
	@keyframes rippleEffect {
		to {
			transform: scale(4);
			opacity: 0;
		}
	}
	.sr-only {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border-width: 0;
	}
`;
document.head.appendChild(navbarRippleStyle);
</script>

<!-- Profile Settings Modal -->
<div id="profileSettingsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
	<!-- Backdrop -->
	<div id="profileSettingsBackdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity duration-300"></div>
	
	<!-- Modal Content -->
	<div class="relative max-w-2xl w-full mx-4 max-h-screen overflow-y-auto rounded-2xl bg-white shadow-2xl dark:bg-slate-900 dark:shadow-2xl">
		<!-- Header -->
		<div class="sticky top-0 z-10 flex items-center justify-between border-b border-slate-200/50 bg-white px-8 py-6 dark:border-slate-800/50 dark:bg-slate-900">
			<div>
				<h2 class="text-2xl font-bold text-slate-900 dark:text-white">Profile Settings</h2>
				<p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Manage your account and preferences</p>
			</div>
			<button id="closeProfileSettings" class="group rounded-lg p-2 text-slate-400 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:hover:bg-slate-800 dark:hover:text-slate-200">
				<i class="fas fa-times text-xl"></i>
			</button>
		</div>

		<!-- Content -->
		<div class="px-8 py-6 space-y-6">
			<!-- Profile Section -->
			<div>
				<h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
					<i class="fas fa-user text-brand-500"></i>
					Profile Information
				</h3>
				<div class="space-y-3 bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4">
					<div class="flex items-start justify-between">
						<div>
							<p class="text-sm font-medium text-slate-600 dark:text-slate-400">Full Name</p>
							<p class="text-base font-semibold text-slate-900 dark:text-white">{{ user.get_full_name|default:user.username }}</p>
						</div>
						<i class="fas fa-check text-green-500"></i>
					</div>
					<div class="h-px bg-slate-200/50 dark:bg-slate-700/50"></div>
					<div>
						<p class="text-sm font-medium text-slate-600 dark:text-slate-400">Email</p>
						<p class="text-base font-semibold text-slate-900 dark:text-white break-all">{{ user.email }}</p>
					</div>
					<div class="h-px bg-slate-200/50 dark:bg-slate-700/50"></div>
					<div>
						<p class="text-sm font-medium text-slate-600 dark:text-slate-400">Account Type</p>
						<p class="text-base font-semibold text-slate-900 dark:text-white flex items-center gap-2">
							<span class="inline-flex items-center gap-1 rounded-full bg-brand-100 px-3 py-1 text-xs font-bold text-brand-600 dark:bg-brand-900/30 dark:text-brand-400">
								<i class="fas fa-shield"></i>
								Admin
							</span>
						</p>
					</div>
				</div>
			</div>

			<!-- Theme Customization Section -->
			<div>
				<h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
					<i class="fas fa-palette text-brand-500"></i>
					Customize Theme
				</h3>
				<p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Choose an accent color for your dashboard</p>
				<div class="grid grid-cols-6 gap-3 bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4">
					<button class="h-12 rounded-xl ring-2 ring-offset-2 ring-offset-white dark:ring-offset-slate-900 ring-transparent transition-all duration-300 hover:scale-110 hover:ring-offset-4 shadow-md hover:shadow-lg" style="background: linear-gradient(135deg, #6366f1 0%, #7c3aed 100%);" data-theme="purple" title="Purple"></button>
					<button class="h-12 rounded-xl ring-2 ring-offset-2 ring-offset-white dark:ring-offset-slate-900 ring-transparent transition-all duration-300 hover:scale-110 hover:ring-offset-4 shadow-md hover:shadow-lg" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" data-theme="blue" title="Blue"></button>
					<button class="h-12 rounded-xl ring-2 ring-offset-2 ring-offset-white dark:ring-offset-slate-900 ring-transparent transition-all duration-300 hover:scale-110 hover:ring-offset-4 shadow-md hover:shadow-lg" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);" data-theme="green" title="Green"></button>
					<button class="h-12 rounded-xl ring-2 ring-offset-2 ring-offset-white dark:ring-offset-slate-900 ring-red-400 transition-all duration-300 hover:scale-110 hover:ring-offset-4 shadow-md hover:shadow-lg" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" data-theme="red" title="Red"></button>
					<button class="h-12 rounded-xl ring-2 ring-offset-2 ring-offset-white dark:ring-offset-slate-900 ring-transparent transition-all duration-300 hover:scale-110 hover:ring-offset-4 shadow-md hover:shadow-lg" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);" data-theme="violet" title="Violet"></button>
					<button class="h-12 rounded-xl ring-2 ring-offset-2 ring-offset-white dark:ring-offset-slate-900 ring-transparent transition-all duration-300 hover:scale-110 hover:ring-offset-4 shadow-md hover:shadow-lg" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);" data-theme="grey" title="Grey"></button>
				</div>
				<div class="mt-3 text-sm text-slate-600 dark:text-slate-400">Current: <span id="profileSettingsCurrentTheme" class="font-bold text-brand-600 dark:text-brand-400">Red</span></div>
			</div>
		</div>

		<!-- Footer -->
		<div class="border-t border-slate-200/50 bg-white px-8 py-4 dark:border-slate-800/50 dark:bg-slate-900">
			<button id="closeProfileSettingsBtn" class="w-full rounded-xl bg-gradient-to-r from-brand-500 to-brand-600 px-6 py-3 text-sm font-semibold text-white shadow-lg transition-all hover:shadow-xl hover:scale-105 active:scale-95">
				Close Settings
			</button>
		</div>
	</div>
</div>

<script>
// Profile Settings Modal Management
(function() {
	const THEME_KEY = 'theme';
	const modal = document.getElementById('profileSettingsModal');
	const backdrop = document.getElementById('profileSettingsBackdrop');
	const openBtn = document.getElementById('openProfileSettings');
	const closeBtn = document.getElementById('closeProfileSettings');
	const closeBottomBtn = document.getElementById('closeProfileSettingsBtn');
	const profileDropdown = document.getElementById('profileDropdown');

	// Theme color map
	const themeMap = {
		purple: { 500: '#a855f7', 600: '#9333ea', 700: '#7e22ce' },
		blue: { 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
		green: { 500: '#10b981', 600: '#059669', 700: '#047857' },
		red: { 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c' },
		violet: { 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9' },
		grey: { 500: '#64748b', 600: '#475569', 700: '#334155' }
	};

	// Hex to RGB conversion
	const hexToRgb = (hex) => {
		const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
		return m ? { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) } : null;
	};

	// Apply theme to CSS variables
	const applyThemeToDOM = (c) => {
		const root = document.documentElement;
		root.style.setProperty('--accent-500', c[500]);
		root.style.setProperty('--accent-600', c[600]);
		root.style.setProperty('--accent-700', c[700]);
		const rgb = hexToRgb(c[500]);
		if (rgb) root.style.setProperty('--accent-500-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
	};

	// Initialize modal theme buttons on page load
	const initThemeButtons = () => {
		const savedTheme = localStorage.getItem(THEME_KEY) || 'red';
		const modalThemeButtons = modal?.querySelectorAll('[data-theme]') || [];
		
		// Apply saved theme to DOM immediately
		const c = themeMap[savedTheme] || themeMap.red;
		applyThemeToDOM(c);
		
		// Set initial ring indicator for saved theme
		modalThemeButtons.forEach(btn => {
			if (btn.getAttribute('data-theme') === savedTheme) {
				btn.classList.add('ring-offset-4');
			}
		});
		
		// Update current theme display
		const themeNames = { purple: 'Purple', blue: 'Blue', green: 'Green', red: 'Red', violet: 'Violet', grey: 'Grey' };
		const displayName = themeNames[savedTheme] || savedTheme;
		const currentThemeEl = document.getElementById('profileSettingsCurrentTheme');
		if (currentThemeEl) currentThemeEl.textContent = displayName;
		
		// Add click handlers
		modalThemeButtons.forEach(btn => {
			btn.addEventListener('click', () => {
				const theme = btn.getAttribute('data-theme');
				
				// Remove all ring highlights
				modalThemeButtons.forEach(b => b.classList.remove('ring-offset-4'));
				// Add ring to clicked button
				btn.classList.add('ring-offset-4');
				
				// Update theme display
			const displayName = themeNames[theme] || theme;
				if (currentThemeEl) currentThemeEl.textContent = displayName;
				
				// Apply the theme
				const c = themeMap[theme] || themeMap.purple;
				applyThemeToDOM(c);
				localStorage.setItem(THEME_KEY, theme);
			});
		});
	};

	if (openBtn && modal) {
		// Open modal
		openBtn.addEventListener('click', (e) => {
			e.preventDefault();
			e.stopPropagation();
			modal.classList.remove('hidden');
			setTimeout(() => {
				backdrop.style.opacity = '1';
			}, 10);
			// Close dropdown
			if (profileDropdown) {
				profileDropdown.classList.remove('visible');
			}
		});

		// Close modal handlers
		const closeModal = () => {
			backdrop.style.opacity = '0';
			setTimeout(() => {
				modal.classList.add('hidden');
			}, 300);
		};

		closeBtn?.addEventListener('click', closeModal);
		closeBottomBtn?.addEventListener('click', closeModal);
		backdrop?.addEventListener('click', closeModal);

		// Prevent modal close when clicking inside
		modal.querySelector('div:nth-child(2)')?.addEventListener('click', (e) => {
			e.stopPropagation();
		});

		// Close on Escape key
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
				closeModal();
			}
		});
	}

	// Initialize on DOMContentLoaded or if already loaded
	if (document.readyState === 'complete' || document.readyState === 'interactive') {
		initThemeButtons();
	}
	document.addEventListener('DOMContentLoaded', initThemeButtons);
	
	// Logout handler function
	window.handleLogout = function() {
		if (confirm('Are you sure you want to logout?')) {
			document.getElementById('logoutForm').submit();
		}
	};
})();
</script>

</body>
</html>