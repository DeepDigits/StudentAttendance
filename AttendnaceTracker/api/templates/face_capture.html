<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Registration - CampusTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes progress {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .animate-slideUp {
            animation: slideUp 0.5s ease-out forwards;
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .camera-frame {
            position: relative;
            width: 100%;
            max-width: 640px;
            height: 480px;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 360px;
            border: 3px solid #4ade80;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.6;
        }
        
        .corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid #4ade80;
        }
        
        .corner-tl {
            top: 60px;
            left: 160px;
            border-right: none;
            border-bottom: none;
            border-radius: 12px 0 0 0;
        }
        
        .corner-tr {
            top: 60px;
            right: 160px;
            border-left: none;
            border-bottom: none;
            border-radius: 0 12px 0 0;
        }
        
        .corner-bl {
            bottom: 60px;
            left: 160px;
            border-right: none;
            border-top: none;
            border-radius: 0 0 0 12px;
        }
        
        .corner-br {
            bottom: 60px;
            right: 160px;
            border-left: none;
            border-top: none;
            border-radius: 0 0 12px 0;
        }
        
        .scanning-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4ade80, transparent);
            animation: scan 2s ease-in-out infinite;
        }
        
        @keyframes scan {
            0%, 100% { top: 60px; }
            50% { top: calc(100% - 60px); }
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.3s;
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .step-circle.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }
        
        .step-circle.completed {
            background: #4ade80;
            color: white;
        }
        
        .step-circle.pending {
            background: #e5e7eb;
            color: #9ca3af;
        }
        
        .step-line {
            flex: 1;
            height: 2px;
            background: #e5e7eb;
            position: relative;
            overflow: hidden;
        }
        
        .step-line.completed::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            background: #4ade80;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #4ade80;
            border-radius: 50%;
            opacity: 0;
            animation: particle-float 3s ease-in-out infinite;
        }
        
        @keyframes particle-float {
            0%, 100% { opacity: 0; transform: translateY(0) scale(1); }
            50% { opacity: 1; transform: translateY(-100px) scale(1.5); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <div class="max-w-5xl w-full">
        <!-- Header -->
        <div class="text-center mb-8 animate-slideUp">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/20 backdrop-blur-sm mb-4">
                <i class="fas fa-user-circle text-3xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2">Face Registration</h1>
            <p class="text-white/80 text-lg">Student ID: <span class="font-semibold">{{ student_id }}</span></p>
        </div>

        <!-- Step Indicator -->
        <div class="glass-effect rounded-2xl p-6 mb-6 animate-slideUp" style="animation-delay: 0.1s;">
            <div class="step-indicator">
                <div class="step-circle" id="step-1">1</div>
                <div class="step-line" id="line-1"></div>
                <div class="step-circle" id="step-2">2</div>
                <div class="step-line" id="line-2"></div>
                <div class="step-circle" id="step-3">3</div>
            </div>
            <div class="grid grid-cols-3 mt-4 text-center text-sm font-medium">
                <div class="text-purple-600" id="label-1">Capture Faces</div>
                <div class="text-gray-400" id="label-2">Train Model</div>
                <div class="text-gray-400" id="label-3">Complete</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="glass-effect rounded-2xl p-8 animate-slideUp" style="animation-delay: 0.2s;">
            <!-- Camera View -->
            <div id="camera-section" class="text-center">
                <div class="camera-frame mx-auto mb-6 relative">
                    <img id="video-feed" src="" alt="Camera Feed" class="w-full h-full object-cover hidden">
                    <div id="camera-placeholder" class="w-full h-full flex items-center justify-center">
                        <div class="text-center text-white">
                            <div class="relative inline-block mb-4">
                                <i class="fas fa-camera text-6xl opacity-50"></i>
                                <div class="absolute -inset-4 border-4 border-white/30 rounded-full animate-pulse"></div>
                            </div>
                            <p class="text-xl">Click "Start Capture" to begin</p>
                            <p class="text-sm mt-2 opacity-75">Ensure good lighting and face the camera</p>
                        </div>
                    </div>
                    
                    <!-- Camera Overlay -->
                    <div class="camera-overlay hidden" id="face-overlay">
                        <div class="corner corner-tl"></div>
                        <div class="corner corner-tr"></div>
                        <div class="corner corner-bl"></div>
                        <div class="corner corner-br"></div>
                        <div class="scanning-line"></div>
                    </div>
                    
                    <!-- Capture Progress -->
                    <div id="capture-progress" class="absolute top-4 left-4 right-4 bg-black/60 backdrop-blur-sm rounded-xl p-4 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-white font-semibold">Capturing...</span>
                            <span class="text-white font-bold" id="progress-text">0 / 50</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                            <div id="progress-bar" class="bg-gradient-to-r from-green-400 to-blue-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div id="instructions" class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-500 text-xl mt-1"></i>
                        <div class="text-left">
                            <h3 class="font-semibold text-blue-900 mb-2">Instructions:</h3>
                            <ul class="text-sm text-blue-800 space-y-1">
                                <li>• Position your face in the center of the frame</li>
                                <li>• Keep your face clearly visible and well-lit</li>
                                <li>• Move your head slightly to capture different angles</li>
                                <li>• We'll capture 50 images for best accuracy</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Capture Button -->
                <button id="start-capture-btn" class="px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-lg font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                    <i class="fas fa-camera mr-2"></i>
                    Start Capture
                </button>
                
                <button id="stop-capture-btn" class="px-8 py-4 bg-red-500 text-white text-lg font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200 hidden">
                    <i class="fas fa-stop mr-2"></i>
                    Stop Capture
                </button>
            </div>

            <!-- Training Section -->
            <div id="training-section" class="text-center hidden">
                <div class="mb-6">
                    <div class="inline-flex items-center justify-center w-32 h-32 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 mb-6 relative">
                        <i class="fas fa-brain text-5xl text-white"></i>
                        <div class="absolute inset-0 rounded-full border-4 border-white border-t-transparent animate-spin"></div>
                    </div>
                </div>
                
                <h2 class="text-3xl font-bold text-gray-800 mb-3">Training Model</h2>
                <p class="text-gray-600 mb-6">Please wait while we train your face recognition model...</p>
                
                <div class="max-w-md mx-auto">
                    <div id="training-progress" class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">Loading dataset</span>
                            <div class="w-6 h-6 border-3 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Section -->
            <div id="success-section" class="text-center hidden">
                <div class="mb-6">
                    <div class="inline-flex items-center justify-center w-32 h-32 rounded-full bg-green-100 mb-6 animate-fadeIn">
                        <i class="fas fa-check-circle text-6xl text-green-500"></i>
                    </div>
                </div>
                
                <h2 class="text-3xl font-bold text-gray-800 mb-3">Registration Complete!</h2>
                <p class="text-gray-600 mb-2">Your face has been successfully registered.</p>
                <p class="text-sm text-gray-500 mb-6">
                    <span class="font-semibold">Model Accuracy:</span> 
                    <span id="model-accuracy" class="text-green-600">--</span>
                </p>
                
                <div class="flex gap-4 justify-center">
                    <a href="/" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                        <i class="fas fa-home mr-2"></i>
                        Go to Home
                    </a>
                    <button onclick="window.location.href='/dashboard/'" class="px-6 py-3 bg-white border-2 border-purple-500 text-purple-600 font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                        <i class="fas fa-chart-line mr-2"></i>
                        View Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    </div>

    <script>
        const studentId = "{{ student_id }}";
        let statusInterval = null;
        let capturedCount = 0;
        const maxCaptures = 50;

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-xl shadow-lg transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500'
            } text-white`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Update step indicator
        function updateStep(step) {
            for (let i = 1; i <= 3; i++) {
                const circle = document.getElementById(`step-${i}`);
                const label = document.getElementById(`label-${i}`);
                const line = document.getElementById(`line-${i}`);
                
                if (i < step) {
                    circle.className = 'step-circle completed';
                    if (line) line.className = 'step-line completed';
                    label.className = 'text-green-600';
                } else if (i === step) {
                    circle.className = 'step-circle active';
                    label.className = 'text-purple-600';
                } else {
                    circle.className = 'step-circle pending';
                    label.className = 'text-gray-400';
                }
            }
        }

        // Poll capture status
        function pollCaptureStatus() {
            statusInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/capture-status/${studentId}/`);
                    const status = await response.json();
                    
                    if (status.count !== undefined) {
                        capturedCount = status.count;
                        updateCaptureProgress(capturedCount);
                    }
                    
                    if (status.completed) {
                        clearInterval(statusInterval);
                        showToast('Capture completed!', 'success');
                        setTimeout(() => {
                            startTraining();
                        }, 1000);
                    }
                    
                    if (status.error) {
                        clearInterval(statusInterval);
                        showToast(status.error, 'error');
                        // Allow retry
                        document.getElementById('start-capture-btn').classList.remove('hidden');
                        document.getElementById('stop-capture-btn').classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 300); // Poll every 300ms
        }

        // Start face capture
        document.getElementById('start-capture-btn').addEventListener('click', async () => {
            try {
                // Start capture on backend
                const response = await fetch('/api/start-capture/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ student_id: studentId })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Show video feed
                    document.getElementById('camera-placeholder').classList.add('hidden');
                    document.getElementById('video-feed').classList.remove('hidden');
                    document.getElementById('video-feed').src = `/api/video-feed/${studentId}/`;
                    document.getElementById('face-overlay').classList.remove('hidden');
                    document.getElementById('capture-progress').classList.remove('hidden');
                    
                    // Toggle buttons
                    document.getElementById('start-capture-btn').classList.add('hidden');
                    document.getElementById('stop-capture-btn').classList.remove('hidden');
                    
                    showToast('Capture started! Please look at the camera and move your head slightly.', 'success');
                    
                    // Start polling status
                    pollCaptureStatus();
                } else {
                    showToast(data.error || 'Failed to start capture', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Network error occurred', 'error');
            }
        });

        // Stop capture
        document.getElementById('stop-capture-btn').addEventListener('click', stopCapture);

        async function stopCapture() {
            clearInterval(statusInterval);
            
            try {
                await fetch('/api/stop-capture/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ student_id: studentId })
                });
                
                // Clear video feed
                document.getElementById('video-feed').src = '';
                document.getElementById('video-feed').classList.add('hidden');
                document.getElementById('camera-placeholder').classList.remove('hidden');
                
                showToast('Capture stopped', 'info');
                
                // Reset UI
                document.getElementById('start-capture-btn').classList.remove('hidden');
                document.getElementById('stop-capture-btn').classList.add('hidden');
            } catch (error) {
                console.error('Error stopping capture:', error);
            }
        }

        // Update capture progress
        function updateCaptureProgress(count) {
            const percentage = (count / maxCaptures) * 100;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${count} / ${maxCaptures}`;
        }

        // Start training
        async function startTraining() {
            updateStep(2);
            
            // Hide camera section
            document.getElementById('camera-section').classList.add('hidden');
            
            // Show training section
            document.getElementById('training-section').classList.remove('hidden');
            
            showToast('Starting model training...', 'info');

            try {
                const response = await fetch('/api/train-model/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ student_id: studentId })
                });

                const data = await response.json();
                
                // Check if both training results are successful
                const singleSuccess = data.single_train && data.single_train.success;
                const combinedSuccess = data.combined_train && data.combined_train.success;
                
                if (singleSuccess && combinedSuccess) {
                    setTimeout(() => {
                        showSuccess(data);
                    }, 2000);
                } else {
                    const error = (data.single_train && data.single_train.error) || 
                                  (data.combined_train && data.combined_train.error) || 
                                  'Training failed';
                    showToast(error, 'error');
                    // Allow retry
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Training error occurred', 'error');
            }
        }

        // Show success
        function showSuccess(data) {
            updateStep(3);
            
            document.getElementById('training-section').classList.add('hidden');
            document.getElementById('success-section').classList.remove('hidden');
            
            if (data.accuracy) {
                document.getElementById('model-accuracy').textContent = `${(data.accuracy * 100).toFixed(1)}%`;
            }
            
            showToast('Registration completed successfully!', 'success');
        }

        // Initialize
        updateStep(1);
    </script>
</body>
</html>
